<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Devis digital QemWork</title>

  <style>
    :root {
      --qem-blue: #0055a5;
      --qem-blue-dark: #00366b;
      --qem-blue-light: #e6f0ff;
      --qem-accent: #00a58a;
      --qem-bg: #f5f8fc;
      --qem-border: #d5e0f0;
      --qem-text: #1f2933;
      --qem-muted: #6b7380;
      --qem-danger: #c0392b;

      --qem-interne-main: #f97316;
      --qem-interne-dark: #c05621;
      --qem-interne-light: #fff7ed;

      --qem-client-main: #0055a5;
      --qem-client-dark: #00366b;
      --qem-client-light: #e6f0ff;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:var(--qem-bg);color:var(--qem-text);line-height:1.4;padding:20px;
    }
    .page{
      max-width:1200px;margin:0 auto;background:#fff;border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);overflow:hidden
    }
    header{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 20px;background:linear-gradient(135deg,var(--qem-blue),var(--qem-blue-dark));color:#fff
    }
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff}
    .logo-img{
      width:52px;height:52px;border-radius:50%;background:#fff;
      display:flex;align-items:center;justify-content:center;overflow:hidden
    }
    .logo-img img{max-width:100%;max-height:100%}
    .logo-text-main{font-weight:700;letter-spacing:.06em;text-transform:uppercase}
    .logo-text-sub{font-size:.8rem;opacity:.9}
    .header-right{font-size:.8rem;text-align:right}
    .tabs-top{
      display:flex;border-bottom:1px solid var(--qem-border);background:#f9fbff;
    }
    .tab{
      flex:1;padding:8px 10px;text-align:center;font-size:.8rem;font-weight:600;
      text-transform:uppercase;letter-spacing:.1em;cursor:pointer;
      color:var(--qem-muted);border-right:1px solid var(--qem-border);
    }
    .tab:last-child{border-right:none}
    .tab.active{background:#fff;color:var(--qem-blue-dark);border-bottom:3px solid var(--qem-blue)}
    .panel{padding:16px 20px 20px;display:none}
    .panel.active{display:block}
    .top-title{
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;
      border-bottom:2px solid var(--qem-blue-light);padding-bottom:6px;margin-bottom:10px
    }
    .top-left{font-size:.85rem}
    .top-right{text-align:right;font-size:.8rem}
    .top-right .big{font-weight:700;font-size:.95rem;color:var(--qem-blue-dark)}
    .section{
      margin-top:10px;padding:10px 12px;border-radius:8px;border:1px solid var(--qem-border);
      background:#f9fbff;
    }
    .section-title{
      font-size:.8rem;text-transform:uppercase;letter-spacing:.12em;
      margin-bottom:6px;font-weight:700;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .field{flex:1;min-width:190px;display:flex;flex-direction:column;gap:3px}
    .field-small{flex:0 0 130px;}
    label{font-size:.78rem;color:var(--qem-muted)}
    input,select,textarea{
      border-radius:6px;border:1px solid var(--qem-border);padding:6px 8px;
      font-size:.85rem;font-family:inherit;width:100%;
    }
    input:focus,select:focus,textarea:focus{
      outline:2px solid rgba(0,85,165,.25);border-color:var(--qem-blue)
    }
    textarea{min-height:70px;resize:vertical}
    table{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:6px}
    th,td{border:1px solid var(--qem-border);padding:5px 6px;text-align:left;vertical-align:top}
    th{
      background:var(--qem-blue-light);font-size:.78rem;text-transform:uppercase;
      letter-spacing:.08em;color:var(--qem-blue-dark)
    }
    .num{text-align:right}
    .note{font-size:.8rem;color:var(--qem-muted);margin-top:4px}
    .validation{
      margin-top:10px;border-top:1px dashed var(--qem-border);padding-top:8px;font-size:.85rem
    }
    .val-buttons{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
    button{
      border-radius:999px;border:none;padding:6px 12px;font-size:.8rem;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;gap:4px
    }
    button.primary{background:var(--qem-blue);color:#fff}
    button.secondary{background:#e4ecff;color:var(--qem-blue-dark)}
    .footer-note{font-size:.75rem;color:var(--qem-muted);margin-top:6px}
    .field.highlight input{
      font-weight:700;
      font-size:0.95rem;
      color:#00366b;
      background:#fffef5;
      border:2px solid #00a58a;
    }
    .conditions{
      font-size:.78rem;margin-top:10px;max-height:260px;overflow-y:auto;
      padding:8px;border-radius:8px;border:1px solid var(--qem-border);background:#fbfcff
    }
    .client-legal{
      font-size:0.78rem;
      border-radius:8px;
      border:1px solid var(--qem-border);
      background:#fbfcff;
      padding:8px;
      max-height:260px;
      overflow-y:auto;
      margin-top:8px;
    }
    .client-validation{
      margin-top:10px;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--qem-border);
      background:#fdfdfd;
      font-size:0.8rem;
    }
    .warning{font-size:.8rem;color:var(--qem-danger);margin-top:4px}
    .alert-red {
      color: var(--qem-danger);
      font-size: 0.78rem;
      margin-top: 3px;
    }
    .two-cols {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
    }
    .two-cols .col {
      flex: 1;
    }
    #panel-interne .section-title {
      color: var(--qem-interne-dark);
    }
    #panel-interne .section {
      border-color: #fed7aa;
      background: var(--qem-interne-light);
    }
    #panel-interne .top-title {
      border-bottom-color: #fed7aa;
    }
    #panel-interne .top-title .big {
      color: var(--qem-interne-dark);
    }
    #panel-interne .section.synthese-interne {
      border:2px solid #00a58a !important;
      background:#e6fff7 !important;
    }
    #panel-client .section-title {
      color: var(--qem-client-dark);
    }
    #panel-client .section {
      border-color: var(--qem-blue-light);
      background:#ffffff;
    }
    #panel-client .top-title {
      border-bottom-color: var(--qem-client-light);
    }
    #panel-client .top-title .big {
      color: var(--qem-client-dark);
    }
    #clientHeaderInfos {
      display: none !important;
    }
    /* Autocomplete */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }
    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 20;
      background: #fff;
      border: 1px solid var(--qem-border);
      border-radius: 0 0 8px 8px;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      font-size: 0.8rem;
    }
    .autocomplete-item {
      padding: 6px 8px;
      cursor: pointer;
    }
    .autocomplete-item:hover {
      background: var(--qem-blue-light);
    }

    @media(max-width:760px){
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .top-title{flex-direction:column;align-items:flex-start}
      .top-right{text-align:left}
      .two-cols{flex-direction:column}
    }
    @media print {
      body{padding:0;background:#fff;}
      .page{box-shadow:none;border-radius:0;}
      .tabs-top{display:none!important;}
      button{display:none!important;}
      .panel{padding:0 10px 10px;}
    }
  </style>
</head>
<body>
<div class="page">

  <!-- En-tête QemWork -->
  <header>
    <a href="https://www.qemwork.com" class="logo" target="_blank" rel="noopener">
      <div class="logo-img">
        <img src="https://raw.githubusercontent.com/mantorx/QemWork/refs/heads/main/Logo_QemWork_HD%20-%20new.svg" alt="QemWork">
      </div>
      <div>
        <div class="logo-text-main">QemWork</div>
        <div class="logo-text-sub">
          La plateforme qui sécurise tous vos travaux au Cameroun
        </div>
      </div>
    </a>
    <div class="header-right">
      <div>TVA 19,25 % incluse | Fonds sécurisés par QemWork</div>
      <div>Devis – validité automatique selon le type de mission</div>
    </div>
  </header>

  <!-- Onglets -->
  <div class="tabs-top">
    <div class="tab active" data-tab="interne">Face interne (QemWork / technicien)</div>
    <div class="tab" data-tab="client">Face client</div>
  </div>

  <!-- PANEL INTERNE -->
  <div id="panel-interne" class="panel active">
    <div class="top-title">
      <div class="top-left">
        <div class="big">OUTIL INTERNE – DEVIS DIGITAL QEMWORK</div>
        <div style="font-size:0.8rem;color:var(--qem-muted);">
          À usage QemWork & techniciens partenaires – non communiqué au client
        </div>
      </div>
      <div class="top-right">
        <div id="interneDevisMeta">
          <div>N° Devis : <strong id="interneDevisNumLabel"></strong></div>
          <div>Référence mission : <strong id="interneRefMissionLabel"></strong></div>
        </div>
        <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap;">
          <button type="button" class="secondary" id="btnGenererClient">Générer la face client</button>
        </div>
      </div>
    </div>

    <!-- A. Coordonnées QemWork -->
    <div class="section">
      <div class="section-title">A. Coordonnées QemWork</div>
      <div style="font-size:0.82rem;">
        <strong>QemWork – Digital Factory SARL</strong><br>
        Dépôt de Sable – Etoudi, Yaoundé – Cameroun<br>
        RCCM : CM-NSI-01-2025-B12-01096<br>
        NUI : M062527815914U<br>
        Tél. : +237 676 59 17 25<br>
        Email : support@qemwork.com<br>
        Site : https://www.qemwork.com
      </div>
    </div>

    <!-- B. Références devis / mission -->
    <div class="section">
      <div class="section-title">B. Références du devis / mission</div>
      <div class="row">
        <div class="field">
          <label>N° de devis</label>
          <input id="devisNum" placeholder="Ex : QW-2025-001">
        </div>
        <div class="field">
          <label>Référence mission interne</label>
          <input id="refMission" placeholder="Ex : QW-CHT-2025-...">
        </div>
        <div class="field-small">
          <label>Date d’établissement</label>
          <input id="dateEtab" type="date">
        </div>
        <div class="field-small">
          <label>Validité</label>
          <input id="validiteLabel" readonly value="selon type de mission">
        </div>
      </div>
    </div>

    <!-- C. Type de devis -->
    <div class="section">
      <div class="section-title">C. Type de devis</div>
      <div class="row">
        <div class="field">
          <label>Type de devis</label>
          <select id="typeDevis">
            <option value="estimatif" selected>Devis estimatif (main d’œuvre seule)</option>
            <option value="quantitatif">Devis quantitatif (main d’œuvre + matériel)</option>
          </select>
        </div>
        <div class="field">
          <label>Résumé internalisé</label>
          <input id="typeDevisInterneLabel" readonly value="Devis estimatif (M.O seule)">
        </div>
      </div>
      <div class="note">
        Le type de devis influe sur la présentation des phases (estimées ou définies) et sur la face client.
      </div>
    </div>

    <!-- D. Prestataire (technicien / entreprise) -->
    <div class="section">
      <div class="section-title">D. Prestataire (technicien / entreprise)</div>
      <div class="row">
        <div class="field-small">
          <label>Type prestataire</label>
          <select id="prestataireType">
            <option value="" disabled selected>Choisir...</option>
            <option value="individu">Individu</option>
            <option value="entreprise">Entreprise</option>
          </select>
        </div>
        <div class="field">
          <label>Nom / Raison sociale</label>
          <input id="prestataireNom">
        </div>
        <div class="field">
          <label>Email</label>
          <input id="prestataireMail">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Téléphone</label>
          <div class="row" style="gap:4px;margin-bottom:0;">
            <div class="field-small">
              <select id="prestataireTelIndic">
                <option value="+237" selected>+237</option>
                <option value="autre">Autre</option>
              </select>
              <input id="prestataireTelIndicAutre" placeholder="Autre indicatif" style="margin-top:4px;display:none;">
            </div>
            <div class="field">
              <input id="prestataireTel" placeholder="Numéro">
            </div>
          </div>
        </div>
        <div class="field">
          <label>Ville technicien</label>
          <select id="prestataireVille">
            <option value="" disabled selected>Choisir...</option>
            <option value="Yaoundé">Yaoundé</option>
            <option value="Douala">Douala</option>
            <option value="autre">Autre ville</option>
          </select>
        </div>
      </div>
      <div class="row" id="prestataireVilleAutreRow" style="display:none;">
        <div class="field">
          <label>Autre ville prestataire</label>
          <input id="prestataireVilleAutre">
        </div>
      </div>
      <div class="row" id="prestataireEntrepriseExtra" style="display:none;">
        <div class="field">
          <label>RCCM</label>
          <input id="prestataireRCCM">
        </div>
        <div class="field">
          <label>NUI</label>
          <input id="prestataireNUI">
        </div>
      </div>
      <div class="row" id="prestataireRepRow" style="display:none;">
        <div class="field">
          <label>Représentant légal</label>
          <input id="prestataireRep">
        </div>
      </div>
    </div>

    <!-- E. Client -->
    <div class="section">
      <div class="section-title">E. Client (maître d’ouvrage)</div>
      <div class="row">
        <div class="field-small">
          <label>Type client</label>
          <select id="clientType">
            <option value="" disabled selected>Choisir...</option>
            <option value="particulier">Particulier</option>
            <option value="entreprise">Entreprise</option>
          </select>
        </div>
        <div class="field">
          <label>Nom / Raison sociale</label>
          <input id="clientNom">
        </div>
        <div class="field">
          <label>Email</label>
          <input id="clientMail">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Téléphone</label>
          <div class="row" style="gap:4px;margin-bottom:0;">
            <div class="field-small">
              <select id="clientTelIndic">
                <option value="+237" selected>+237</option>
                <option value="autre">Autre</option>
              </select>
              <input id="clientTelIndicAutre" placeholder="Autre indicatif" style="margin-top:4px;display:none;">
            </div>
            <div class="field">
              <input id="clientTel" placeholder="Numéro">
            </div>
          </div>
        </div>
      </div>
      <div class="row" id="clientEntrepriseExtra" style="display:none;">
        <div class="field">
          <label>RCCM</label>
          <input id="clientRCCM">
        </div>
        <div class="field">
          <label>NUI</label>
          <input id="clientNUI">
        </div>
      </div>
      <div class="row" id="clientRepRow" style="display:none;">
        <div class="field">
          <label>Représentant</label>
          <input id="clientRep">
        </div>
      </div>
    </div>

    <!-- F. Chantier -->
    <div class="section">
      <div class="section-title">F. Chantier</div>
      <div class="row">
        <div class="field">
          <label>Adresse complète du chantier</label>
          <input id="clientAdresse" placeholder="Adresse complète (rue, point de repère...)">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Ville du chantier</label>
          <select id="clientVille">
            <option value="" disabled selected>Choisir une ville</option>
            <option value="Yaoundé">Yaoundé</option>
            <option value="Douala">Douala</option>
            <option value="autre">Autre ville</option>
          </select>
        </div>
        <div class="field">
          <label>Quartier du chantier (avec aide à la saisie)</label>
          <div class="autocomplete-container">
            <input id="clientQuartierInput" placeholder="Commencez à taper...">
            <div id="clientQuartierResults" class="autocomplete-results" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="row" id="clientVilleAutreRow" style="display:none;">
        <div class="field">
          <label>Autre ville chantier</label>
          <input id="clientVilleAutre">
        </div>
      </div>
    </div>

    <!-- G. Corps de métier / mission -->
    <div class="section">
      <div class="section-title">G. Corps de métier / type d’intervention / mission</div>
      <div class="row">
        <div class="field">
          <label>Corps de métier principal (aide au remplissage)</label>
          <div class="autocomplete-container">
            <input id="corpsMetierInput" placeholder="Ex : Plombier, Électricien...">
            <div id="corpsMetierResults" class="autocomplete-results" style="display:none;"></div>
          </div>
        </div>
        <div class="field">
          <label>Type d’intervention (aide au remplissage)</label>
          <div class="autocomplete-container">
            <input id="typeInterventionInput" placeholder="Ex : Fuite d’eau, Recherche de panne...">
            <div id="typeInterventionResults" class="autocomplete-results" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field-small">
          <label>Type de mission</label>
          <select id="missionType">
            <option value="" disabled selected>Choisir...</option>
            <option value="urgence">Urgence 24/7</option>
            <option value="reparation">Réparation ponctuelle</option>
            <option value="entretien">Entretien / maintenance</option>
            <option value="petits">Petits travaux</option>
            <option value="gros">Gros travaux / rénovation</option>
            <option value="construction">Construction</option>
            <option value="placement">Placement de personnel</option>
          </select>
        </div>
        <div class="field">
          <label>Date de début souhaitée (hors urgence)</label>
          <input id="dateDebutSouhaitee" type="date">
        </div>
      </div>

      <!-- Urgence -->
      <div class="row" id="urgenceExtra" style="display:none;">
        <div class="field-small">
          <label>Jour de l’intervention</label>
          <select id="typeJour">
            <option value="lundi">Lundi</option>
            <option value="mardi">Mardi</option>
            <option value="mercredi">Mercredi</option>
            <option value="jeudi">Jeudi</option>
            <option value="vendredi">Vendredi</option>
            <option value="samedi">Samedi</option>
            <option value="dimanche">Dimanche</option>
          </select>
        </div>
        <div class="field">
          <label>Créneau horaire (2h)</label>
          <select id="creneauHeure">
            <option value="08-10">08h - 10h</option>
            <option value="10-12">10h - 12h</option>
            <option value="12-14">12h - 14h</option>
            <option value="14-16">14h - 16h</option>
            <option value="16-18">16h - 18h</option>
            <option value="18-20">18h - 20h</option>
            <option value="20-22">20h - 22h</option>
            <option value="22-24">22h - 00h</option>
            <option value="00-02">00h - 02h</option>
            <option value="02-04">02h - 04h</option>
            <option value="04-06">04h - 06h</option>
            <option value="06-08">06h - 08h</option>
          </select>
          <div class="note">
            Barème urgence client : 10 % journée semaine (06h–18h), 15 % soirée semaine (18h–22h),
            15 % journée weekend (06h–18h), 20 % soirée weekend (18h–22h), 25 % nuit (22h–06h).<br>
            Barème technicien urgence : Lundi-Vendredi 10 % (06h–18h), 7 % (18h–22h), 3 % (22h–06h).
            Samedi-Dimanche 7 % (08h–18h), 3 % (18h–22h et 22h–06h).
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Description / contexte de la mission</label>
          <textarea id="description" placeholder="Contexte, attentes, contraintes..."></textarea>
        </div>
      </div>
    </div>

    <!-- H. Phases -->
    <div class="section">
      <div class="section-title" id="phasesSectionTitle">H. Phases estimées</div>
      <table id="tablePhases">
        <thead>
        <tr>
          <th>Nom de phase</th>
          <th>Description</th>
          <th>Date début prévisionnelle</th>
          <th>Date fin prévisionnelle</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td><input class="phase-name" value="Phase I" readonly></td>
          <td><input class="phase-desc" placeholder="Description de la phase (ex : Démarrage, protections...)"></td>
          <td><input class="phase-deb" type="date"></td>
          <td><input class="phase-fin" type="date"></td>
          <td><button type="button" class="secondary del-phase-row">Supprimer</button></td>
        </tr>
        </tbody>
      </table>
      <button type="button" class="secondary" id="addPhaseBtn">+ Ajouter une phase</button>
      <div class="note">
        Les phases sont nommées automatiquement (Phase I, Phase II, ...) et utilisées pour ventiler les coûts.
      </div>
    </div>

    <!-- I. Chiffrage -->
    <div class="section">
      <div class="section-title">I. Chiffrage – Main d’œuvre, matériel et placement</div>

      <!-- Estimatif -->
      <div id="blocEstimatif">
        <h4>1. Main d’œuvre – Devis estimatif</h4>
        <table id="tableMdoEstim">
          <thead>
          <tr>
            <th>Ligne</th>
            <th>Phase</th>
            <th>Désignation</th>
            <th>Unité</th>
            <th>Quantité</th>
            <th>P. Unit. TTC (FCFA)</th>
            <th>P. Total TTC (FCFA)</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>1.1</td>
            <td>
              <select class="mdo-phase-select-estim">
                <option value="">Sans phase</option>
                <option value="Phase I">Phase I</option>
              </select>
            </td>
            <td><input class="mdo-desc-estim" value="Main d’œuvre technicien"></td>
            <td><input class="mdo-unite-estim" value="Forfait"></td>
            <td><input class="num mdo-qte-estim" type="number" value="1"></td>
            <td><input class="num mdo-pu-estim" type="number" placeholder="Ex : 20000"></td>
            <td class="num mdo-total-estim">0 FCFA</td>
            <td><button type="button" class="secondary btnDelMdoEstim">X</button></td>
          </tr>
          </tbody>
        </table>
        <button type="button" class="secondary" id="btnAddMdoEstim">+ Ajouter une ligne M.O (estimatif)</button>
      </div>

      <!-- Quantitatif -->
      <div id="blocQuantitatif" style="display:none;margin-top:12px;">
        <h4>2. Main d’œuvre – Devis quantitatif</h4>
        <table id="tableMdoQuant">
          <thead>
          <tr>
            <th>Ligne</th>
            <th>Phase</th>
            <th>Désignation</th>
            <th>Unité</th>
            <th>Quantité</th>
            <th>P. Unit. TTC (FCFA)</th>
            <th>P. Total TTC (FCFA)</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>1.1</td>
            <td>
              <select class="mdo-phase-select-quant">
                <option value="">Sans phase</option>
                <option value="Phase I">Phase I</option>
              </select>
            </td>
            <td><input class="mdo-desc-quant" value="Main d’œuvre technicien"></td>
            <td><input class="mdo-unite-quant" value="Forfait"></td>
            <td><input class="num mdo-qte-quant" type="number" value="1"></td>
            <td><input class="num mdo-pu-quant" type="number" placeholder="Ex : 20000"></td>
            <td class="num mdo-total-quant">0 FCFA</td>
            <td><button type="button" class="secondary btnDelMdoQuant">X</button></td>
          </tr>
          </tbody>
        </table>
        <button type="button" class="secondary" id="btnAddMdoQuant">+ Ajouter une ligne M.O (quantitatif)</button>

        <h4 style="margin-top:10px;">3. Matériel / fournitures – Devis quantitatif</h4>
        <table id="tableMateriel">
          <thead>
          <tr>
            <th>Ligne</th>
            <th>Phase</th>
            <th>Désignation</th>
            <th>Unité</th>
            <th>Quantité</th>
            <th>P. Unit. TTC (FCFA)</th>
            <th>P. Total TTC (FCFA)</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>2.1</td>
            <td>
              <select class="materiel-phase-select">
                <option value="">Sans phase</option>
                <option value="Phase I">Phase I</option>
              </select>
            </td>
            <td><input class="materiel-desc" placeholder="Ex : Ciment 50kg"></td>
            <td><input class="materiel-unite" placeholder="Sacs"></td>
            <td><input class="num materiel-qte" type="number" value="1"></td>
            <td><input class="num materiel-pu" type="number" placeholder="Ex : 6000"></td>
            <td class="num materiel-total">0 FCFA</td>
            <td><button type="button" class="secondary btnDelLigneMat">X</button></td>
          </tr>
          </tbody>
        </table>
        <button type="button" class="secondary" id="btnAddMateriel">+ Ajouter une ligne matériel</button>
      </div>

      <!-- Placement de personnel -->
      <div id="blocPlacement" style="margin-top:12px;display:none;">
        <h4>4. Placement de personnel</h4>
        <table id="tablePlacement">
          <thead>
          <tr>
            <th>Corps de métier souhaité</th>
            <th>Ville du technicien</th>
            <th>Hébergement pris en charge (client)</th>
            <th>Qté (pers.)</th>
            <th>Tarif journalier (FCFA)</th>
            <th>Jours</th>
            <th>Distance max (km)</th>
            <th>Frais déplacement (A/R)</th>
            <th>Hébergement (par pers/jour)</th>
            <th>Total TTC ligne</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>
              <div class="autocomplete-container">
                <input class="place-corps-input" placeholder="Ex : Maçon, Plombier...">
                <div class="autocomplete-results place-corps-results" style="display:none;"></div>
              </div>
            </td>
            <td>
              <select class="place-ville-tech">
                <option value="" disabled selected>Ville technicien</option>
                <option value="Yaoundé">Yaoundé</option>
                <option value="Douala">Douala</option>
                <option value="autre">Autre (à préciser)</option>
              </select>
              <input class="place-ville-tech-autre" placeholder="Autre ville" style="margin-top:4px;display:none;">
            </td>
            <td>
              <select class="place-heberg-prise">
                <option value="non" selected>Non</option>
                <option value="oui">Oui</option>
              </select>
            </td>
            <td><input class="num place-qte" type="number" value="1"></td>
            <td><input class="num place-tarif" type="number" placeholder="Tarif jour"></td>
            <td><input class="num place-jours" type="number" value="1"></td>
            <td>
              <input class="num place-km" type="number" value="0">
              <div class="alert-red place-km-alert" style="display:none;">
                Distance ≥ 20 km : hébergement min. 2 500 FCFA/pers/jour.
              </div>
            </td>
            <td class="num place-depl">0 FCFA</td>
            <td><input class="num place-heberg" type="number" value="0" min="0"></td>
            <td class="num place-total">0 FCFA</td>
            <td><button type="button" class="secondary btnDelLignePlacement">X</button></td>
          </tr>
          </tbody>
        </table>
        <button type="button" class="secondary" id="btnAddPlacement">+ Ajouter une ligne personnel</button>
      </div>
    </div>

    <!-- Synthèse interne -->
    <div class="section synthese-interne">
      <div class="section-title">J. Synthèse interne QemWork (commissions et nets)</div>
      <div class="row">
        <div class="field">
          <label>Montant M.O TTC pris en compte</label>
          <input id="mdoDisplayInterne" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>Total TTC global (M.O + matériel / placement)</label>
          <input id="totalDevisInterne" readonly value="0 FCFA">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Taux commission technicien (interne)</label>
          <input id="tauxTechInterne" readonly>
        </div>
        <div class="field">
          <label>Part QemWork (M.O) – HT</label>
          <input id="partQemInterne" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>TVA sur part M.O technicien</label>
          <input id="tvaTech" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>Net TTC technicien (M.O seule)</label>
          <input id="netTechInterne" readonly value="0 FCFA">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Taux commission client (front)</label>
          <input id="tauxClientInterne" readonly>
        </div>
        <div class="field">
          <label>Commission client – HT</label>
          <input id="commClientHT" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>TVA sur commission client</label>
          <input id="tvaClient" readonly value="0 FCFA">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Commission totale QemWork – HT</label>
          <input id="commissionTotaleHT" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>TVA totale QemWork</label>
          <input id="tvaTotaleQW" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>Frais front client (TTC)</label>
          <input id="fraisFrontInterne" readonly value="0 FCFA">
        </div>
        <div class="field">
          <label>Total TTC à facturer au client (interne)</label>
          <input id="totalClientTTCInterne" readonly value="0 FCFA">
        </div>
      </div>
      <div class="row">
        <div class="field highlight">
          <label>Net TTC technicien (rappel)</label>
          <input id="netTechHighlight" readonly value="0 FCFA">
        </div>
        <div class="field highlight">
          <label>Commissions QemWork totales – HT</label>
          <input id="commTotalHighlight" readonly value="0 FCFA">
        </div>
        <div class="field highlight">
          <label>TVA QemWork totale</label>
          <input id="tvaTotaleHighlight" readonly value="0 FCFA">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Commentaires internes QemWork</label>
          <textarea id="commentInterne"></textarea>
        </div>
      </div>
    </div>

    <!-- K. Tableau de bord interne (désactivé) -->
    <div class="section" id="dashboardQW" style="margin-top:12px; display:none;">
      <div class="section-title">K. Tableau de bord QemWork (automatique)</div>
      <div id="dashboardContent" style="font-size:0.82rem; line-height:1.35;">
        (Tableau de bord désactivé dans cette version – voir synthèse interne J.)
      </div>
    </div>

  </div> <!-- /#panel-interne -->
  <!-- PANEL CLIENT -->
  <div id="panel-client" class="panel">
    <div class="top-title" id="clientHeaderBar">
      <div class="top-left" id="clientHeaderInfos">
        <!-- Rempli par JS : Client + Chantier -->
      </div>
      <div class="top-right" id="clientDevisMeta">
        <div class="big" id="clientTitle">DEVIS DIGITAL QEMWORK</div>
        <div id="clientDevisMetaInfos">
          <!-- N° Devis, Réf, Date, Validité -->
        </div>
        <div style="margin-top:8px; display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap;">
          <button type="button" class="secondary" id="btnClientPdf">PDF devis</button>
          <button type="button" class="secondary" id="btnClientShare">Partager</button>
          <button type="button" class="secondary" id="btnClientInvoice">Facture</button>
          <button type="button" class="secondary" id="btnClientHtml">Exporter de devis HTML (notes)</button>
        </div>
      </div>
    </div>

    <!-- Coordonnées QemWork + technicien + client -->
    <div class="section two-cols">
      <div class="col">
        <div class="section-title">Coordonnées QemWork & prestataire</div>
        <div style="font-size:0.8rem;">
          <p>
            <strong>QemWork – Digital Factory SARL</strong><br>
            Dépôt de Sable – Etoudi, Yaoundé – Cameroun<br>
            RCCM : CM-NSI-01-2025-B12-01096<br>
            NUI : M062527815914U<br>
            Tél. : +237 676 59 17 25<br>
            Email : support@qemwork.com <br> https://www.qemwork.com
          </p>
          <p style="margin-top:6px;">
            <strong>Technicien / Entreprise intervenant(e) :</strong><br>
            <span id="clientFaceTechNom"></span><br>
            <span id="clientFaceTechType"></span><br>
            <span id="clientFaceTechVille"></span><br>
            <span id="clientFaceTechRccm"></span><br>
            <span id="clientFaceTechNui"></span>
          </p>
        </div>
      </div>
      <div class="col">
        <div class="section-title">Coordonnées du client</div>
        <div style="font-size:0.8rem;">
          <p>
            <strong id="clientFaceNom"></strong><br>
            <span id="clientFaceType"></span><br>
            <span id="clientFaceRccm"></span><br>
            <span id="clientFaceNui"></span><br>
            <span id="clientFaceRep"></span><br>
            <span id="clientFaceTel"></span><br>
            <span id="clientFaceMail"></span>
          </p>
        </div>
      </div>
    </div>

    <!-- Résumé mission -->
    <div class="section">
      <div class="section-title">Objet et résumé de la mission</div>
      <div id="clientMissionResume" style="font-size:0.85rem;"></div>
    </div>

    <!-- Récapitulatif financier -->
    <div class="section">
      <div class="section-title">Récapitulatif financier détaillé</div>
      <div id="clientCoutMdo" style="font-size:0.85rem;margin-bottom:6px;"></div>
      <div id="clientDetailParPhase" style="font-size:0.8rem;margin-top:6px;">
        <!-- tableau phases MO / Mat / Total + détail matériel -->
      </div>
      <div id="clientTotalBloc" style="margin-top:8px;font-weight:bold;font-size:0.86rem;"></div>
      <div id="clientNoteMateriel" class="note">
        Le présent devis peut inclure ou non le coût des fournitures et du matériel selon le type de devis indiqué ci-dessus.
      </div>
    </div>

    <!-- CGV Client (résumé) -->
    <div class="section" id="cgvBlock">
      <div class="section-title">Conditions Générales QemWork applicables au client</div>
      <div class="client-legal" id="conditionsClient">
  <p>Date d'entrée en vigueur : 17 décembre 2025</p>

<h5>PRÉAMBULE</h5>
<p>Les présentes Conditions Générales d'Utilisation (ci-après « CGU ») régissent l'utilisation des services de mise en relation proposés par QemWork, ci-après dénommée «</p>

<h5>ARTICLE 1 - CHAMP D'APPLICATION</h5>
<p>Les présentes Conditions Générales de Vente (CGV) s'appliquent à toutes les prestations de services proposées par QemWork (DIGITAL FACTORY SARL), immatriculée sous le numéro RCCM CM NSI 01 2025 B12 01096, dont le siège social est situé au Dépôt de Sable – Etoudi, Yaoundé, Cameroun.</p>
<p>Toute commande de prestation implique l'acceptation sans réserve par le Client des présentes CGV qui prévalent sur tout autre document, sauf accord écrit préalable de QemWork.</p>

<h5>ARTICLE 2 - OBJET DES PRESTATIONS</h5>
<p>QemWork propose un service de mise en relation entre Clients et Techniciens qualifiés du bâtiment pour :</p>
<ul>
  <li>Interventions d'urgence</li>
  <li>Réparations</li>
  <li>Entretien d'installations</li>
  <li>Petits et gros travaux</li>
  <li>Projets de construction</li>
  <li>Mise à disposition de main-d'œuvre</li>
</ul>
<p>QemWork assure :</p>
<ul>
  <li>La sélection et la vérification des techniciens</li>
  <li>La gestion administrative des devis et factures</li>
  <li>L'encaissement et la sécurisation des paiements</li>
  <li>Le suivi des interventions</li>
  <li>La médiation en cas de litige</li>
</ul>

<h5>ARTICLE 3 - DEVIS</h5>

<h5>3.1 Devis Estimatif</h5>
<p>Le devis estimatif est une estimation préliminaire gratuite portant uniquement sur la main-d'œuvre, fournie avant toute visite terrain. Il n'a aucune valeur contractuelle.</p>

<h5>3.2 Devis Quantitatif</h5>
<p>Le devis quantitatif est établi après visite terrain et constitue le document contractuel définitif. Il détaille :</p>
<ul>
  <li>La description précise des travaux</li>
  <li>Le coût de la main-d'œuvre (détaillé)</li>
  <li>La liste complète du matériel nécessaire</li>
  <li>Les frais de dossier et de garantie de service</li>
  <li>Le montant total TTC</li>
  <li>Les dates de début et de fin d'intervention</li>
  <li>La durée de validité du devis</li>
</ul>

<h5>3.3 Validité des Devis (estimatifs et quantitatifs)</h5>
<ul>
  <li>Urgences : immédiat</li>
  <li>Réparations/Entretien : 24 heures</li>
  <li>Travaux lourds et projets : 10 jours</li>
</ul>
<p>Passé ce délai, un nouveau devis devra être établi.</p>

<h5>3.4 Acceptation du Devis</h5>
<p>L'acceptation du devis peut se faire :</p>
<ul>
  <li>Par signature manuscrite ou électronique</li>
  <li>Par validation écrite (WhatsApp, e-mail)</li>
  <li>Par paiement de l'acompte</li>
</ul>
<p>L'acceptation du devis vaut commande ferme de la prestation.</p>

<h5>ARTICLE 4 - TARIFS</h5>

<h5>4.1 Prix des Prestations</h5>
<p>Les prix indiqués dans les devis sont exprimés en Francs CFA (FCFA) et comprennent :</p>
<ul>
  <li>La main-d'œuvre</li>
  <li>Le matériel et les matériaux nécessaires</li>
  <li>Les Frais de Dossier et de Garantie de Service</li>
</ul>

<h5>4.2 Frais de Dossier et de Garantie de Service</h5>
<p>QemWork applique des Frais de Dossier et de Garantie de Service pour :</p>
<ul>
  <li>La sélection et la vérification des techniciens</li>
  <li>La gestion administrative et le suivi</li>
  <li>L'assurance qualité</li>
  <li>Le support client disponible 24/7</li>
  <li>La garantie de satisfaction</li>
  <li>La couverture par une assurance Responsabilité Civile Professionnelle protégeant le Client, le Technicien et QemWork en cas de dommages survenus lors des travaux (voir Article 15 - Assurances)</li>
</ul>

<p><strong>Barème des frais :</strong></p>
<ul>
  <li><strong>Missions Urgences (variable selon horaire) :</strong>
    <ul>
      <li>Semaine jour (Lu-Ve, 8h-18h) : +10%</li>
      <li>Semaine soir (Lu-Ve, 18h-22h) : +15%</li>
      <li>Week-end jour (Sa-Di, 8h-18h) : +15%</li>
      <li>Week-end soir (Sa-Di, 18h-22h) : +20%</li>
      <li>Nuit (22h-8h) : +25%</li>
    </ul>
  </li>
  <li><strong>Missions Classiques :</strong>
    <ul>
      <li>Devis &lt; 100 000 FCFA : +7%</li>
      <li>Devis 100 000 - 1 000 000 FCFA : +5%</li>
      <li>Devis &gt; 1 000 000 FCFA : +3%</li>
    </ul>
  </li>
  <li><strong>Projets :</strong>
    <ul>
      <li>Construction complète : +3%</li>
      <li>Demande de main d'oeuvre : +10%</li>
    </ul>
  </li>
</ul>

<h5>4.3 Révision de Prix</h5>
<p>Les prix sont fermes et définitifs, sauf :</p>
<ul>
  <li>Modification substantielle du périmètre des travaux constatée lors de la visite terrain</li>
  <li>Découverte de problèmes non identifiés initialement</li>
  <li>Demande expresse du Client pour travaux supplémentaires</li>
</ul>
<p>Toute révision nécessite l'établissement d'un devis complémentaire et l'acceptation préalable du Client.</p>

<h5>4.4 Frais Supplémentaires</h5>
<p>Des frais supplémentaires peuvent s'appliquer pour :</p>
<ul>
  <li>Déplacement au-delà des 3 km : 115 FCFA/km aller-retour pour chaque kilomètre (ces frais sont à payer pour chaque jour de travail et sont exigibles en totalité au début de la prestation)</li>
  <li>Intervention hors ville et dont le technicien fait plus de 10 km jusqu’au lieu du chantier ; si hébergement pris en charge par le client alors, les frais de déplacement aller et retour sont exigibles avant le début de la prestation sur le forfait mentionné ci-dessus. Si hébergement non pris en charge, en plus des frais de transport, des frais d’hébergement sont appliqué au forfait minimum de 2500 FCFA/nuit compté du début à la fin des travaux.</li>
  <li>Devis payant (projets complexes avec validation préalable).</li>
  <li>Frais de visite terrain en cas de refus d'intervention (voir Article 7.7)</li>
</ul>
<p>Ces frais sont mentionnés dans le devis si applicables.</p>

<h5>ARTICLE 5 - MODALITÉS DE PAIEMENT</h5>

<h5>5.1 Moyens de Paiement Acceptés</h5>
<ul>
  <li>ORANGE Mobile Money : #150*47#914946"DIGITAL FACTORY SARL" </li>
  <li>MTN Mobile Money : /</li>
  <li>Virement bancaire : CM21 10005 00001 10798831001 – 05</li>
</ul>
<p>Le Client paie uniquement QemWork, jamais directement le technicien.</p>

<h5>5.2 Échéancier de Paiement</h5>
<ul>
  <li><strong>Interventions courtes (&lt; 1 mois) :</strong> Paiement intégral avant intervention</li>
  <li><strong>Gros travaux et projets (&gt; 1 mois) :</strong> Paiement échelonné par phases :
    <ul>
      <li>Acompte 1 (minimum 30%) : Avant démarrage</li>
      <li>Acomptes intermédiaires : Tous les 30 jours ou par phase</li>
    </ul>
  </li>
  <li><strong>Main-d'œuvre multiple :</strong> Paiement avant démarrage pour chaque semaine de travail.</li>
</ul>

<h5>5.3 Délai de Paiement</h5>
<p>Le paiement doit être effectué :</p>
<ul>
  <li>Urgences : Immédiatement après acceptation du devis</li>
  <li>Missions classiques : Dans les 24h suivant l'acceptation du devis quantitatif</li>
  <li>Projets : Selon l'échéancier défini au devis (dans les 24h suivant acceptation de devis)</li>
</ul>
<p>Les travaux ne démarrent qu'après confirmation du paiement.</p>

<h5>5.4 Justificatif de Paiement</h5>
<p>Le Client doit transmettre à QemWork la preuve de paiement (capture d'écran de la transaction + numéro de transaction) via WhatsApp ou e-mail en mettant en communication le numéro de référence de devis ou de la mission (sur le devis reçu).</p>

<h5>5.5 Retard de Paiement</h5>
<p>En cas de retard de paiement :</p>
<ul>
  <li>Les travaux sont suspendus immédiatement</li>
  <li>Des pénalités de retard de 2% par jour sont appliquées (max 20%)</li>
  <li>Une indemnité forfaitaire de 10 000 FCFA pour frais de recouvrement</li>
  <li>QemWork se réserve le droit d'annuler la prestation après 7 jours de retard</li>
</ul>

<h5>ARTICLE 6 - FACTURATION</h5>

<h5>6.1 Émission de Facture</h5>
<p>Une facture officielle est émise par QemWork :</p>
<ul>
  <li>Après réception du paiement (facture d'acompte si échelonné)</li>
  <li>Après validation finale des travaux (facture définitive)</li>
</ul>

<h5>6.2 Mentions Légales</h5>
<p>Les factures comportent :</p>
<ul>
  <li>Raison sociale et RCCM de QemWork</li>
  <li>Numéro de facture unique</li>
  <li>Date d'émission</li>
  <li>Identification du Client</li>
  <li>Descriptif des prestations</li>
  <li>Montant HT (le cas échéant)</li>
  <li>TVA 19,25% (si applicable)</li>
  <li>Montant TTC</li>
  <li>Modalités de paiement</li>
</ul>

<h5>6.3 Conservation</h5>
<p>Le Client doit conserver les factures pendant 10 ans (obligations fiscales et garanties).</p>

<h5>ARTICLE 7 - EXÉCUTION DES PRESTATIONS</h5>

<h5>7.1 Délais d'Intervention (en moyenne)</h5>
<ul>
  <li>Urgences : immédiat</li>
  <li>Réparations : 24-72 heures</li>
  <li>Petits travaux : 3-7 jours</li>
  <li>Gros travaux : 1-4 semaines</li>
  <li>Projets : 1-06 mois</li>
</ul>
<p>Les délais sont mentionnés au devis et constituent un engagement contractuel.</p>

<h5>7.2 Horaires d'Intervention</h5>
<ul>
  <li>Lundi à vendredi : 08h00 - 18h00</li>
  <li>Samedi : 08h00 - 18h00</li>
  <li>Urgences : 22h00 - 08h00 (si accepté)</li>
</ul>

<h5>7.3 Accès au Lieu d'Intervention</h5>
<p>Le Client s'engage à :</p>
<ul>
  <li>Faciliter l'accès au lieu d'intervention</li>
  <li>Être présent ou désigner un représentant</li>
  <li>Mettre à disposition eau et électricité (si nécessaire)</li>
  <li>Signaler tout danger ou contrainte spécifique</li>
</ul>

<h5>7.4 Modification de Rendez-vous</h5>
<p>Le Client peut modifier le rendez-vous :</p>
<ul>
  <li>Sans frais si demande &gt; 24h avant</li>
  <li>Frais de 5 000 FCFA si demande &lt; 24h</li>
</ul>

<h5>7.5 Matériel et Matériaux</h5>
<ul>
  <li>Petit matériel (&lt; 50K indépendant / &lt; 100K entreprise) : Géré par le technicien</li>
  <li>Gros matériel (≥ seuils) : Géré par QemWork</li>
</ul>

<p><strong>Responsabilités du Client :</strong></p>
<ul>
  <li>Vérifier à la livraison que le matériel correspond exactement au devis (marque, quantité, état)</li>
  <li>Signaler immédiatement toute non-conformité avant utilisation</li>
  <li>Assurer la garde et la conservation du matériel stocké sur le chantier pendant toute la durée des travaux</li>
  <li>Protéger le matériel contre le vol, les intempéries et les dégradations</li>
  <li>Vérifier à la fin des travaux les matériaux restants et le petit matériel et outillage facturés et payés dans le devis et s’assurer que cela vous soit effectivement cédé.</li>
</ul>
<p><strong>Délai de réclamation :</strong> Dans l'heure suivant la livraison. Passé ce délai, le matériel est considéré livré conforme et sous la responsabilité définitive du client.</p>

<h5>7.6 Conformité et Réception</h5>
<p>À la fin des travaux, le Client doit :</p>
<ol>
  <li>Vérifier la conformité avec le devis</li>
  <li>Tester le bon fonctionnement (si applicable)</li>
  <li>Confirmer la réception auprès de QemWork</li>
</ol>

<h5>7.7 Visite Terrain et Refus d'Intervention</h5>
<p>Suite à l'acceptation du devis estimatif par le client, une visite terrain est obligatoire avant la finalisation du contrat. Cette visite permet au prestataire de :</p>
<ul>
  <li>Confirmer les conditions d'accès et de réalisation des travaux</li>
  <li>Vérifier la faisabilité technique du projet</li>
  <li>Établir le devis quantitatif définitif</li>
  <li>Identifier les contraintes spécifiques du site</li>
</ul>
<p>La date et l'heure de cette visite seront fixées d'un commun accord entre les parties.</p>

<h5>7.7.1 Frais de Refus d'Intervention</h5>
<table>
  <thead>
    <tr>
      <th>Distance</th>
      <th>Frais applicables</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Jusqu'à 5 km</td><td>2 000 FCFA</td></tr>
    <tr><td>6 à 15 km</td><td>5 000 FCFA</td></tr>
    <tr><td>16 à 30 km</td><td>15 000 FCFA</td></tr>
    <tr><td>Plus de 30 km</td><td>20 000 FCFA</td></tr>
  </tbody>
</table>
<p>Ces frais couvrent les déplacements, le temps technique et les charges d'exploitation engagés pour la visite.</p>

<h5>7.7.2 Exonération des Frais de Visite</h5>
<p>Le client est exempté du paiement des frais de visite terrain dans les cas suivants si le devis quantitatif établi après visite dépasse le devis estimatif de plus de 30% (main d’œuvre), le client peut refuser sans frais. Exemple : devis estimatif 100 000 FCFA → devis quantitatif supérieur à 120 000 FCFA = refus sans frais.</p>

<h5>7.7.3 Conditions de Paiement des Frais</h5>
<p>En cas de refus d'intervention ne correspondant pas aux exonérations énoncées à l'article 3, le client s'engage à régler les frais de visite dans un délai de 48 heures suivant la notification écrite du refus.</p>
<p>À défaut de paiement dans le délai imparti, le prestataire se réserve le droit de suspendre toute intervention ultérieure jusqu'à régularisation de la situation.</p>

<h5>7.7.4 Acceptation et Engagement</h5>
<p>Par la signature du présent contrat, le client reconnaît avoir pris connaissance de ces dispositions et accepte :</p>
<ul>
  <li>L'obligation de visite terrain</li>
  <li>Les frais applicables en cas de refus</li>
  <li>Les conditions d'exonération</li>
  <li>Les délais de paiement</li>
</ul>

<h5>7.8 Force Majeure</h5>
<p>QemWork ne peut être tenue responsable en cas de retard ou d'inexécution dû à :</p>
<ul>
  <li>Catastrophes naturelles</li>
  <li>Grèves générales</li>
  <li>Coupures électriques prolongées</li>
  <li>Événements politiques majeurs</li>
  <li>Pandémies avec restrictions</li>
</ul>
<p>En cas de force majeure, les prestations sont reportées sans pénalité.</p>

<h5>ARTICLE 8 - GARANTIES</h5>

<h5>8.1 Durées de Garantie</h5>
<table>
  <thead>
    <tr>
      <th>Type de prestation</th>
      <th>Garantie minimale</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Dépannage simple</td><td>4 semaines</td></tr>
    <tr><td>Entretien ou réparation</td><td>3 mois</td></tr>
    <tr><td>Installation ou maintenance lourde</td><td>6 mois</td></tr>
    <tr><td>Travaux lourds (rénovation, construction)</td><td>6 mois</td></tr>
  </tbody>
</table>

<h5>8.2 Étendue de la Garantie</h5>
<p>La garantie couvre :</p>
<ul>
  <li>Les défauts de main-d'œuvre</li>
  <li>Les vices cachés liés aux travaux réalisés</li>
  <li>Les dysfonctionnements dus à une malfaçon</li>
</ul>
<p>La garantie ne couvre pas :</p>
<ul>
  <li>L'usure normale</li>
  <li>Les dommages causés par le Client ou un tiers</li>
  <li>Les modifications non autorisées</li>
  <li>Le non-respect des consignes d'entretien</li>
  <li>Les dommages liés à un événement de force majeure</li>
</ul>

<h5>8.3 Mise en Œuvre de la Garantie</h5>
<p>En cas de problème sous garantie :</p>
<ol>
  <li>Contacter QemWork immédiatement</li>
  <li>Décrire le problème avec photos</li>
  <li>QemWork organise une visite de contrôle</li>
  <li>Correction gratuite si défaut avéré</li>
</ol>

<h5>8.4 Garantie Décennale (Projets)</h5>
<p>Pour les projets de construction, une garantie décennale peut être souscrite pour les dommages compromettant la solidité de l'ouvrage.</p>

<h5>ARTICLE 9 - ANNULATION</h5>

<h5>9.1 Annulation par le Client</h5>

<h5>9.1.1 Avant Acceptation du Devis Estimatif</h5>
<p>L'annulation est gratuite et sans condition jusqu'à l'acceptation formelle du devis estimatif par le client.</p>

<h5>9.1.2 Après Acceptation du Devis, Avant Paiement du Devis Quantitatif</h5>
<table>
  <thead>
    <tr>
      <th>Délai</th>
      <th>Conditions</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Jusqu'à 24h après acceptation</td><td>Annulation gratuite, sans pénalité</td></tr>
    <tr><td>Au-delà de 24h</td><td>Frais de dossier : 10% du montant estimé</td></tr>
  </tbody>
</table>
<p><strong>Justification :</strong> Les frais couvrent les frais administratifs et la réservation des ressources.</p>

<h5>9.1.3 Après Paiement du Devis Quantitatif</h5>
<p>Le paiement du devis quantitatif déclenche automatiquement :</p>
<ul>
  <li>La commande du matériel auprès des fournisseurs</li>
  <li>L'engagement et la mobilisation du technicien</li>
  <li>La réservation du créneau d'intervention</li>
</ul>
<p>Toute annulation après paiement entraîne des frais selon le délai avant la date d'intervention prévue.</p>

<h5>Annulation &gt; 48h avant la Date d'Intervention Prévue</h5>
<ul>
  <li>Remboursement : 50% du montant total payé</li>
  <li>Déductions : Matériel commandé non annulable + frais de gestion + frais de mobilisation du technicien</li>
  <li>Délai de remboursement : 7 jours ouvrables après confirmation de l'annulation</li>
  <li>Justification : QemWork absorbe une partie des frais fixes engendrés</li>
</ul>

<h5>Annulation &lt; 48h avant la Date d'Intervention Prévue</h5>
<p>Le client dispose de deux options :</p>
<p><strong>Option A - Annulation pure :</strong></p>
<ul>
  <li>Aucun remboursement</li>
  <li>Les frais engagés restent à la charge du prestataire</li>
  <li>Le matériel commandé ne peut être annulé auprès des fournisseurs</li>
</ul>
<p><strong>Option B - Report d'Intervention (recommandé) :</strong></p>
<ul>
  <li>L'intervention est reportée à une nouvelle date dans les 30 jours suivants</li>
  <li>Frais de report : 15 000 FCFA</li>
  <li>Le matériel reste réservé pour la nouvelle date</li>
  <li>Aucun frais supplémentaire au-delà des 15 000 FCFA</li>
</ul>

<h5>Report Volontaire de l'Intervention (avant annulation)</h5>
<p>Le client peut reporter <strong>UNE SEULE FOIS</strong> son intervention sans motif justifié, selon les conditions suivantes :</p>
<table>
  <thead>
    <tr>
      <th>Délai du report</th>
      <th>Frais applicables</th>
      <th>Validité</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>&gt; 48h avant RDV</td><td>10 000 FCFA</td><td>Jusqu'à 30 jours</td></tr>
    <tr><td>&lt; 48h avant RDV</td><td>15 000 FCFA</td><td>Jusqu'à 30 jours</td></tr>
  </tbody>
</table>
<ul>
  <li>Matériel réservé : Demeure réservé pour la nouvelle date convenue</li>
  <li>Conditions de report : Une seule opportunité de report. Tout nouveau report après la première utilisation du droit de report sera traité comme une annulation</li>
</ul>

<h5>9.1.4 Après Début d'Intervention</h5>
<ul>
  <li>Aucun remboursement du montant payé</li>
  <li>Travaux réalisés : Le client demeure redevable des prestations déjà exécutées, facturées au taux horaire convenu</li>
  <li>Matériel installé/livré : Reste à la charge du client</li>
  <li>Interventions partielles : Facturation au prorata du travail accompli</li>
</ul>

<h5>9.2 Annulation par QemWork</h5>

<h5>9.2.1 Motifs d'Annulation par QemWork</h5>
<p>QemWork peut annuler l'intervention programmée en cas de :</p>
<ol>
  <li><strong>Force Majeure</strong>
    <ul>
      <li>Conditions météorologiques extrêmes rendant l'accès impossible ou dangereux</li>
      <li>Catastrophe naturelle ou événement non prévisible</li>
      <li>Situation de sécurité publique (confinement, interdiction de circuler, etc.)</li>
    </ul>
  </li>
  <li><strong>Indisponibilité du Technicien</strong>
    <ul>
      <li>Maladie ou accident du technicien assigné</li>
      <li>Urgence médicale familiale</li>
      <li>Tout événement imprévisible affectant la disponibilité</li>
    </ul>
  </li>
  <li><strong>Impossibilité Technique Avérée</strong>
    <ul>
      <li>Découverte sur site d'une contrainte rendant les travaux irréalisables</li>
      <li>Produit ou matériel non disponible auprès des fournisseurs</li>
      <li>Limitation technique découverte trop tard pour modification du planning</li>
    </ul>
  </li>
</ol>

<h5>9.2.2 Procédure et Compensation en Cas d'Annulation par QemWork</h5>
<p>En cas d'annulation par QemWork :</p>
<ul>
  <li>Remboursement intégral : 100% du montant payé</li>
  <li>Délai de remboursement : Immédiat ou sous 48h maximum</li>
  <li>Aucune pénalité : Le client n'engage aucune responsabilité</li>
  <li>Communication rapide : Notification de l'annulation dans les 24h avant l'intervention prévue</li>
  <li>Proposition alternative :
    <ul>
      <li>QemWork propose un technicien de remplacement si disponible</li>
      <li>OU une nouvelle date d'intervention dans les 15 jours suivants</li>
    </ul>
  </li>
</ul>

<h5>9.2.3 Responsabilité et Limitation</h5>
<p>QemWork s'engage à tout mettre en œuvre pour honorer les interventions programmées. Toutefois, en cas de force majeure ou d'événement échappant à son contrôle, QemWork ne peut être tenu responsable de tout préjudice indirect (retard, surcoûts, opportunités manquées, etc.).</p>

<h5>9.3 Dispositions Communes</h5>

<h5>9.3.1 Notification Obligatoire</h5>
<p>Toute demande d'annulation ou de modification doit être notifiée par écrit (email, SMS ou appel téléphonique confirmé par écrit) dans les délais impartis.</p>

<h5>9.3.2 Calcul des Délais</h5>
<p>Les délais s'entendent en jours calendaires (y compris week-ends et jours fériés), calculés à partir de la date de notification de l'annulation par le client ou de la date d'intervention programmée.</p>

<h5>9.3.3 Modalités de Remboursement</h5>
<p>Les remboursements s'effectuent par :</p>
<ul>
  <li>Virement bancaire (délai : 5-7 jours ouvrables)</li>
  <li>Chèque (délai : 7-10 jours)</li>
  <li>Crédit de compte client (à demander)</li>
</ul>
<p>À défaut de coordonnées bancaires, le client dispose de 15 jours pour les communiquer ; passé ce délai, le remboursement sera prescrit.</p>

<h5>ARTICLE 10 - RESPONSABILITÉ</h5>

<h5>10.1 Responsabilité de QemWork</h5>
<p>QemWork est responsable de :</p>
<ul>
  <li>La sélection et la vérification des techniciens</li>
  <li>La gestion administrative et le suivi</li>
  <li>La conformité des devis et factures</li>
</ul>
<p>QemWork est couvert par une assurance responsabilité civile professionnelle (police n°1085 511 25 0013P, Prudential Beneficial Insurance Cameroun).</p>
<p>QemWork ne peut être tenue responsable :</p>
<ul>
  <li>Des dommages causés par une négligence du Client</li>
  <li>Des vices de construction préexistants</li>
  <li>Des retards liés à des fournisseurs tiers</li>
  <li>Des événements de force majeure</li>
</ul>

<h5>10.2 Responsabilité du Technicien</h5>
<p>Le technicien est responsable de :</p>
<ul>
  <li>La qualité de son travail</li>
  <li>Le respect des normes et règles de sécurité</li>
  <li>Les dommages causés par négligence ou malfaçon</li>
</ul>
<p>Tous les techniciens collaborant avec QemWork disposent d'une assurance responsabilité civile professionnelle.</p>

<h5>10.3 Limitation de Responsabilité</h5>
<p>En cas de dommage avéré causé lors de l'intervention, la responsabilité de QemWork est limitée au montant de la prestation facturée, sauf faute lourde ou dol.</p>

<h5>ARTICLE 11 - RÉCLAMATIONS ET LITIGES</h5>

<h5>11.1 Réclamations</h5>
<p>Toute réclamation doit être formulée :</p>
<ul>
  <li>Dans les 24h suivant la fin de l'intervention</li>
  <li>Par écrit (WhatsApp, e-mail) à QemWork</li>
  <li>Avec description précise et preuves (photos, vidéos)</li>
</ul>

<h5>11.2 Procédure de Résolution</h5>
<p><strong>Étape 1 - Signalement (J+0)</strong><br>Le Client notifie le problème à QemWork</p>
<p><strong>Étape 2 - Réponse (J+1)</strong><br>Le technicien propose une correction gratuite ou conteste</p>
<p><strong>Étape 3 - Médiation (J+2 à J+3)</strong><br>Si désaccord, un médiateur indépendant tranche sous 72h :</p>
<ul>
  <li>Correction gratuite obligatoire</li>
  <li>Remboursement partiel ou total</li>
  <li>Rejet de la réclamation (si non fondée)</li>
</ul>

<h5>11.3 Règlement Amiable</h5>
<p>Les parties s'engagent à rechercher un règlement amiable avant toute action judiciaire.</p>

<h5>11.4 Juridiction Compétente</h5>
<p>À défaut d'accord amiable sous 30 jours, le Tribunal de Première Instance de Yaoundé est seul compétent pour connaître de tout litige relatif aux présentes CGV.</p>

<h5>ARTICLE 12 - PROTECTION DES DONNÉES PERSONNELLES</h5>

<h5>12.1 Données Collectées</h5>
<p>QemWork collecte : nom, prénom, téléphone, adresse, photos des chantiers, historique des prestations.</p>

<h5>12.2 Utilisation</h5>
<p>Les données sont utilisées exclusivement pour :</p>
<ul>
  <li>Fournir le service de mise en relation</li>
  <li>Gérer les devis, factures et paiements</li>
  <li>Assurer le suivi des interventions</li>
  <li>Améliorer la qualité des services</li>
</ul>

<h5>12.3 Protection</h5>
<p>QemWork s'engage à :</p>
<ul>
  <li>Ne jamais vendre les données</li>
  <li>Sécuriser les données</li>
  <li>Ne partager qu'avec les techniciens affectés</li>
</ul>

<h5>12.4 Droits du Client</h5>
<p>Le Client dispose d'un droit d'accès, de rectification et de suppression de ses données personnelles.</p>

<h5>ARTICLE 13 - PROPRIÉTÉ INTELLECTUELLE</h5>
<p>Les logos, marques, documents et contenus de QemWork sont protégés par le droit de la propriété intellectuelle. Toute reproduction sans autorisation est interdite.</p>

<h5>ARTICLE 14 - CLAUSE DE RÉSERVE DE PROPRIÉTÉ</h5>
<p>Le matériel et les matériaux commandés auprès des fournisseurs dans le cadre des travaux suivant devis restent la propriété de QemWork jusqu'au paiement intégral du prix par le Client.</p>

<h5>ARTICLE 15 - ASSURANCES</h5>

<h5>15.1 Assurance QemWork</h5>
<p>QemWork est couvert par une assurance Responsabilité Civile Professionnelle et d'Exploitation souscrite auprès de Prudential Beneficial General Insurance, police n° 1085 511 25 0013P.</p>
<p><strong>Montants de garantie :</strong></p>
<ul>
  <li>Dommages corporels : 150 000 000 FCFA</li>
  <li>Dommages matériels : 100 000 000 FCFA</li>
  <li>Dommages immatériels consécutifs : 10 000 000 FCFA</li>
</ul>
<p>Cette couverture protège :</p>
<ul>
  <li>Le Client en cas de dommage causé lors de l'intervention</li>
  <li>Le Technicien en cas d'accident sur le chantier</li>
  <li>QemWork pour sa responsabilité d'intermédiaire</li>
</ul>
<p>La couverture s'applique dans les limites et conditions générales de la police d'assurance.</p>

<h5>15.2 Assurance Techniciens</h5>
<p>Tous les techniciens collaborant avec QemWork doivent disposer d'une assurance responsabilité civile professionnelle en cours de validité.</p>

<h5>15.3 En Cas de Sinistre</h5>
<p>En cas de dommage causé lors d'une intervention :</p>
<ol>
  <li>Contacter QemWork immédiatement</li>
  <li>Documenter les dommages (photos, constat)</li>
  <li>QemWork active la procédure d'assurance endéans les 48h</li>
  <li>Expertise et indemnisation selon les conditions de la police</li>
</ol>
<p><strong>Délai d'indemnisation :</strong> 30 à 60 jours selon la complexité du dossier.</p>

<h5>15.4 Exclusions de Garantie</h5>
<p>L'assurance ne couvre pas :</p>
<ul>
  <li>Les dommages causés intentionnellement par le Client</li>
  <li>Les dommages préexistants aux travaux</li>
  <li>Les dommages résultant d'un usage anormal ou d'un défaut d'entretien</li>
  <li>Les dommages liés à la force majeure (catastrophes naturelles, etc.)</li>
</ul>

<h5>ARTICLE 15 - DISPOSITIONS GÉNÉRALES</h5>

<h5>15.1 Intégralité de l'Accord</h5>
<p>Les présentes CGV constituent l'intégralité de l'accord entre le Client et QemWork.</p>

<h5>15.2 Nullité Partielle</h5>
<p>Si une clause est déclarée nulle, les autres clauses restent en vigueur.</p>

<h5>15.3 Modification des CGV</h5>
<p>QemWork se réserve le droit de modifier les présentes CGV. Les CGV applicables sont celles en vigueur à la date de la commande.</p>

<h5>15.4 Langue</h5>
<p>Les présentes CGV sont rédigées en français, langue qui fera foi en cas de litige.</p>

<h5>15.5 Droit Applicable</h5>
<p>Les présentes CGV sont régies par le droit camerounais.</p>

<h5>ACCEPTATION</h5>
<p>L'acceptation du devis vaut acceptation sans réserve des présentes Conditions Générales de Vente.</p>

<p><strong>QemWork - DIGITAL FACTORY SARL</strong><br>
RCCM : CM NSI 01 2025 B12 01096 <br>
Siège social : Dépôt de sable, Etoudi, Yaoundé<br>
Téléphone / WhatsApp : +237 6 76 59 17 28<br>
Email : support@qemwork.com</p>

<p><strong>Date :</strong> 17 décembre 2025</p>
      </div>
    </div>

    <!-- Validation client -->
    <div class="section client-validation">
      <div class="section-title">Validation du devis par le client</div>
      <div class="row">
        <div class="field" style="flex-basis:100%;flex-grow:0;">
          <label>
            <input type="checkbox" id="clientLuApprouve">
            <span>Je déclare avoir lu et approuvé les Conditions Générales QemWork ci-dessus.</span>
          </label>
        </div>
      </div>
      <div class="row">
        <div class="field-small">
          <label>Décision du client</label>
          <select id="clientDecision">
            <option value="" disabled selected>Choisir...</option>
            <option value="accepte">Devis accepté</option>
            <option value="refuse">Devis refusé</option>
          </select>
        </div>
        <div class="field">
          <label>Nom et prénom du signataire</label>
          <input id="clientSignataire" placeholder="Nom et prénom">
        </div>
        <div class="field-small">
          <label>Date de validation</label>
          <input id="clientValidationDate" type="date">
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Commentaires / réserves éventuelles</label>
          <textarea id="clientCommentaires" placeholder="Commentaires facultatifs"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex-basis:100%;flex-grow:0;text-align:right;">
          <button type="button" class="primary" id="btnClientPay">
            Je valide
          </button>
          <div class="note">
            En cliquant sur ce bouton, vous confirmez avoir lu et accepté les Conditions Générales QemWork.
          </div>
        </div>
      </div>
    </div>

  </div> <!-- /#panel-client -->

</div> <!-- /.page --> 
<script>
/* ============================================================
   JS QemWork – PHASE 2/4
   (général, listes, onglets, phases, client/prestataire)
   ============================================================ */

/* =======================
   0. ONGLETS INTERNE / CLIENT
   ======================= */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.getAttribute('data-tab');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

    tab.classList.add('active');
    document.getElementById(`panel-${target}`).classList.add('active');
  });
});

/* =======================
   1. UTILITAIRES GÉNÉRAUX
   ======================= */

const TVA = 0.1925;

function formatFCFA(v) {
  if (v == null || isNaN(v)) return "0 FCFA";
  return new Intl.NumberFormat("fr-FR").format(Math.round(v)) + " FCFA";
}

function parseFCFA(str) {
  if (!str) return 0;
  if (typeof str === "number") return str;
  return parseFloat(
    (str + "")
      .replace(/\s/g, "")
      .replace(/[^\d.,-]/g, "")
      .replace(",", ".")
  ) || 0;
}

/**
 * getVal : version unique et robuste
 * - Si element.value existe et non vide → value
 * - Sinon → textContent
 */
function getVal(id) {
  const el = document.getElementById(id);
  if (!el) return "";
  if (typeof el.value !== "undefined" && el.value !== "") return el.value;
  return el.textContent || "";
}

/* Pour la face client (utilitaires courts) */
function fc(id) {
  const el = document.getElementById(id);
  return el ? el.value.trim() : "";
}
function fcx(id) {
  const el = document.getElementById(id);
  return el ? el.textContent.trim() : "";
}
function fmt(v) {
  if (!v || isNaN(v)) return "0 FCFA";
  return new Intl.NumberFormat("fr-FR").format(Math.round(v)) + " FCFA";
}

/* =======================
   1.b – INIT AUTO N° DEVIS / RÉF MISSION
   ======================= */
(function initDevisRefs() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, "0");
  const d = String(now.getDate()).padStart(2, "0");
  const rand = Math.floor(Math.random() * 900 + 100);
  const numDefaut = `QW-${y}${m}${d}-${rand}`;
  const refDefaut = `QW-MIS-${y}${m}${d}-${rand}`;

  const devisNumInput = document.getElementById("devisNum");
  const refMissionInput = document.getElementById("refMission");

  if (devisNumInput && !devisNumInput.value) devisNumInput.value = numDefaut;
  if (refMissionInput && !refMissionInput.value) refMissionInput.value = refDefaut;

  const labDevis = document.getElementById("interneDevisNumLabel");
  const labRef = document.getElementById("interneRefMissionLabel");
  if (labDevis && devisNumInput) labDevis.textContent = devisNumInput.value;
  if (labRef && refMissionInput) labRef.textContent = refMissionInput.value;

  devisNumInput?.addEventListener("input", () => {
    if (labDevis) labDevis.textContent = devisNumInput.value;
  });
  refMissionInput?.addEventListener("input", () => {
    if (labRef) labRef.textContent = refMissionInput.value;
  });
})();

/* =======================
   1.c – POST PAYLOAD PAR FORMULAIRES CACHÉS
   ======================= */
function b64utf8(str) {
  return btoa(unescape(encodeURIComponent(str || "")));
}

function postPayloadByForm(payloadObj, onDone) {
  // on utilise un iframe invisible pour recevoir la réponse JSON sans quitter la page
  const iframeName = "qw_post_iframe_" + Date.now();
  const iframe = document.createElement("iframe");
  iframe.name = iframeName;
  iframe.style.display = "none";
  document.body.appendChild(iframe);

  const form = document.createElement("form");
  form.method = "POST";
  form.action = DEVIS_WEBAPP_URL;
  form.target = iframeName;
  form.style.display = "none";

  const inp = document.createElement("input");
  inp.type = "hidden";
  inp.name = "payload";
  inp.value = JSON.stringify(payloadObj);

  form.appendChild(inp);
  document.body.appendChild(form);

  iframe.onload = () => {
    try {
      const txt = iframe.contentDocument?.body?.innerText || "";
      let json = null;
      try { json = JSON.parse(txt); } catch(e) {}
      onDone && onDone(json, txt);
    } finally {
      setTimeout(() => { form.remove(); iframe.remove(); }, 800);
    }
  };

  form.submit();
}
/* =======================
   2. LISTES QEMWORK (quartiers, corps, interventions)
   ======================= */

const QW_QUARTIERS = [
  "Bastos","Oyom-Abang","Mfandena","Messa","Mbankolo","Mballa II","Minkan","Etoudi",
  "Ngousso","Ekounou","Nsam","Nsimeyong","Nkolmesseng","Nkol-Eton","Santa Barbara",
  "Nkolbisson","Odza","Biteng","Biyem-Assi","Emana","Etoug-Ebe","Etoa-Meki","Mendong",
  "Obobogo","Melen","Elig-Essono","Essos","Mvog-Mbi","Mvog-Ada","Mvog-Betsi","Efoulan",
  "Nlongkak","Nkolndongo","Similand","Afanayoa","Carrière","Ekie","Mokolo","Mvan",

  "Akwa","Bonapriso","Bonanjo","Bonaberi","Bépanda","New Bell","Makepe","Bonamoussadi",
  "Ndogbong","Kotto","Logpom","Logbaba","PK8","PK11","PK14","PK17","PK21","Bali","Bonadiwoto",

  "Ebolowa","Bertoua","Bafoussam","Mbouda","Kribi","Garoua","Maroua","Bamenda",
  "Foumban","Foumbot","Ngaoundéré","Yagoua","Kumba","Limbe","Tiko","Edéa"
];

const QW_CORPS_METIER = [
  "Plombier","Électricien","Maçon","Menuisier bois","Menuisier aluminium",
  "Carreleur","Peintre","Serrurier","Climaticien","Technicien froid",
  "Chauffagiste","Couvreur","Charpentier","Domoticien","Soudeur",
  "Ingénieur civil","Technicien réseau","Fibre optique","Vitrier",
  "Staffeur","Étancheur","Technicien piscine","Jardinier",
  "Agent de nettoyage","Désinfection","Dératisation","Technicien CCTV",
  "Technicien alarme","Technicien accès","Menuisier métallique",
  "Façadier","Géomètre","Architecte","Urbaniste","BIM Modeler",
  "Technicien VRD","Technicien groupe électrogène","Technicien solaire",
  "Chef de chantier","Conducteur travaux","Manœuvre","Aide-maçon"
];

const QW_INTERVENTIONS = [
  "Fuite d’eau","Débouchage WC","Débouchage évier","Curage canalisation",
  "Remplacement robinet","Pose chauffe-eau","Réparation tuyauterie",

  "Recherche panne électrique","Court-circuit","Remplacement disjoncteur",
  "Installation tableau électrique","Installation luminaire","Mise à la terre",

  "Installation clim","Recharge gaz clim","Nettoyage clim","Réparation fuite clim",

  "Fabrication dressing","Fabrication porte","Pose fenêtre aluminium","Pose parquet",

  "Construction muret","Dalle béton","Ragréage sol","Ouverture mur porteur",

  "Peinture intérieure","Peinture extérieure","Enduit complet","Anti-humidité",

  "Ouverture porte","Serrure bloquée","Fabrication portail","Soudure réparation",

  "Recherche fuite toiture","Étanchéité terrasse","Réfection toiture complète",

  "Urgence plomberie","Urgence électricité","Urgence serrure",
  "Urgence infiltration toiture","Urgence inondation"
];

/* =======================
   3. AUTOCOMPLÉTION GÉNÉRIQUE
   ======================= */

function setupAutocomplete(input, container, dataset) {
  if (!input || !container) return;

  input.addEventListener("input", () => {
    const q = input.value.trim().toLowerCase();
    container.innerHTML = "";

    if (!q) {
      container.style.display = "none";
      return;
    }

    const matches = dataset.filter(item =>
      item.toLowerCase().includes(q)
    ).slice(0, 30);

    if (!matches.length) {
      container.style.display = "none";
      return;
    }

    matches.forEach(item => {
      const div = document.createElement("div");
      div.className = "autocomplete-item";
      div.textContent = item;
      div.onclick = () => {
        input.value = item;
        container.style.display = "none";
        input.dispatchEvent(new Event("change"));
      };
      container.appendChild(div);
    });

    container.style.display = "block";
  });

  // fermer si clic ailleurs
  document.addEventListener("click", (e) => {
    if (!container.contains(e.target) && e.target !== input) {
      container.style.display = "none";
    }
  });
}

/* Activation autocomplete de base (chantier + corps + intervention) */
setupAutocomplete(
  document.getElementById("clientQuartierInput"),
  document.getElementById("clientQuartierResults"),
  QW_QUARTIERS
);
setupAutocomplete(
  document.getElementById("corpsMetierInput"),
  document.getElementById("corpsMetierResults"),
  QW_CORPS_METIER
);
setupAutocomplete(
  document.getElementById("typeInterventionInput"),
  document.getElementById("typeInterventionResults"),
  QW_INTERVENTIONS
);

/* =======================
   4. TYPE DE DEVIS (estimatif / quantitatif)
   ======================= */

const typeDevisSelect = document.getElementById("typeDevis");
const blocEstimatif = document.getElementById("blocEstimatif");
const blocQuantitatif = document.getElementById("blocQuantitatif");
const typeDevisInterneLabel = document.getElementById("typeDevisInterneLabel");

typeDevisSelect.addEventListener("change", () => {
  const val = typeDevisSelect.value;

  if (val === "estimatif") {
    blocEstimatif.style.display = "block";
    blocQuantitatif.style.display = "none";
    typeDevisInterneLabel.value = "Devis estimatif (M.O seule)";
    document.getElementById("phasesSectionTitle").textContent = "H. Phases estimées";
  } else {
    blocEstimatif.style.display = "none";
    blocQuantitatif.style.display = "block";
    typeDevisInterneLabel.value = "Devis quantitatif (M.O + matériel)";
    document.getElementById("phasesSectionTitle").textContent = "H. Phases définies";
  }

  refreshValidationButtonLabel();
  updateAllCalculations();
});

function refreshDevisTitle() {
  const typeDevis = document.getElementById("typeDevis")?.value;
  const titleEl = document.querySelector("#panel-client .top-title h1");
  if (!titleEl) return;

  if (typeDevis === "quantitatif") {
    titleEl.textContent = "DEVIS QUANTITATIF QEMWORK";
  } else if (typeDevis === "estimatif") {
    titleEl.textContent = "DEVIS ESTIMATIF QEMWORK";
  } else {
    titleEl.textContent = "DEVIS DIGITAL QEMWORK";
  }
}

/* =======================
   5. MISSION + VALIDITÉ + URGENCE
   ======================= */
const missionType = document.getElementById("missionType");
const validiteLabel = document.getElementById("validiteLabel");
const urgenceExtra = document.getElementById("urgenceExtra");
const typeJourEl = document.getElementById("typeJour");
const creneauHeureEl = document.getElementById("creneauHeure");

/* Taux urgence (internes globaux) */
window._tauxUrgenceClient = 0;
window._tauxUrgenceTech = 0;

missionType.addEventListener("change", () => {
  const type = missionType.value;

  // Règle validité
  if (type === "gros" || type === "construction") {
    validiteLabel.value = " 10 jours";
  } else if (type === "urgence") {
    validiteLabel.value = " immédiate (urgence)";
  } else if (type === "placement") {
    validiteLabel.value = " 3 jours";
  } else {
    validiteLabel.value = " 24 heures";
  }

  // Affichage options urgence
  urgenceExtra.style.display = (type === "urgence") ? "flex" : "none";

  // Reset taux urgence si pas urgence
  if (type !== "urgence") {
    window._tauxUrgenceClient = 0;
    window._tauxUrgenceTech = 0;
  }

  // Placement : gestion d'affichage blocs M.O / matériel
  const blocPlacement = document.getElementById("blocPlacement");

  function clearMOAndMat() {
    document.querySelectorAll(
      ".mdo-qte-estim, .mdo-pu-estim," +
      ".mdo-qte-quant, .mdo-pu-quant," +
      ".materiel-qte, .materiel-pu"
    ).forEach(inp => {
      if (inp.tagName === "INPUT") inp.value = "";
    });
    document.querySelectorAll(
      ".mdo-total-estim, .mdo-total-quant, .materiel-total"
    ).forEach(td => td.textContent = "0 FCFA");
  }

  if (type === "placement") {
    // Pour une mission de placement pur : on cache M.O et matériel
    blocEstimatif.style.display = "none";
    blocQuantitatif.style.display = "none";
    if (blocPlacement) blocPlacement.style.display = "block";
    clearMOAndMat();
  } else {
    // Autres missions : on rétablit l'affichage standard selon type de devis
    const val = typeDevisSelect.value;
    if (val === "estimatif") {
      blocEstimatif.style.display = "block";
      blocQuantitatif.style.display = "none";
    } else {
      blocEstimatif.style.display = "none";
      blocQuantitatif.style.display = "block";
    }
    if (blocPlacement) blocPlacement.style.display = "block";
  }

  updateUrgenceRates();
  updateAllCalculations();
});

/* Définition des taux d’urgence selon jour / créneau */
function updateUrgenceRates() {
  if (missionType.value !== "urgence") {
    window._tauxUrgenceClient = 0;
    window._tauxUrgenceTech = 0;
    return;
  }

  const jour = typeJourEl.value || "lundi";
  const cr = creneauHeureEl.value || "08-10";
  const isWeekend = (jour === "samedi" || jour === "dimanche");

  // Taux client
  let tauxClient = 0;
  let heureDeb = parseInt(cr.split("-")[0],10);

  if (!isWeekend) {
    // Lundi–Vendredi
    if (heureDeb >= 6 && heureDeb < 18) tauxClient = 0.10;    // journée semaine
    else if (heureDeb >= 18 && heureDeb < 22) tauxClient = 0.15; // soirée semaine
    else tauxClient = 0.25;                                    // nuit
  } else {
    // Samedi–Dimanche
    if (heureDeb >= 6 && heureDeb < 18) tauxClient = 0.15;    // journée weekend
    else if (heureDeb >= 18 && heureDeb < 22) tauxClient = 0.20; // soirée weekend
    else tauxClient = 0.25;                                   // nuit
  }

  // Taux technicien
  let tauxTech = 0;
  if (!isWeekend) {
    // Lundi–Vendredi (barème interne)
    if (heureDeb >= 6 && heureDeb < 18) tauxTech = 0.10;
    else if (heureDeb >= 18 && heureDeb < 22) tauxTech = 0.07;
    else tauxTech = 0.03;
  } else {
    // Samedi–Dimanche
    if (heureDeb >= 8 && heureDeb < 18) tauxTech = 0.07;
    else tauxTech = 0.03;
  }

  window._tauxUrgenceClient = tauxClient;
  window._tauxUrgenceTech = tauxTech;
}

/* Recalcul taux quand on change le jour ou le créneau */
typeJourEl.addEventListener("change", () => {
  updateUrgenceRates();
  updateAllCalculations();
});
creneauHeureEl.addEventListener("change", () => {
  updateUrgenceRates();
  updateAllCalculations();
});

/* =======================
   6. PRESTATAIRE
   ======================= */
const prestataireTypeEl = document.getElementById("prestataireType");
const prestataireEntrepriseExtra = document.getElementById("prestataireEntrepriseExtra");
const prestataireRepRow = document.getElementById("prestataireRepRow");
const prestataireVille = document.getElementById("prestataireVille");
const prestataireVilleAutreRow = document.getElementById("prestataireVilleAutreRow");
const prestataireVilleAutre = document.getElementById("prestataireVilleAutre");
const prestataireTelIndic = document.getElementById("prestataireTelIndic");
const prestataireTelIndicAutre = document.getElementById("prestataireTelIndicAutre");

/* Type prestataire */
prestataireTypeEl.addEventListener("change", () => {
  const isEnt = prestataireTypeEl.value === "entreprise";
  prestataireEntrepriseExtra.style.display = isEnt ? "flex" : "none";
  prestataireRepRow.style.display = isEnt ? "flex" : "none";

  if (!isEnt) {
    document.getElementById("prestataireRCCM").value = "";
    document.getElementById("prestataireNUI").value = "";
    document.getElementById("prestataireRep").value = "";
  }
});

/* Ville prestataire */
prestataireVille.addEventListener("change", () => {
  if (prestataireVille.value === "autre") {
    prestataireVilleAutreRow.style.display = "flex";
  } else {
    prestataireVilleAutreRow.style.display = "none";
    prestataireVilleAutre.value = "";
  }
});

/* Indicatif téléphonique prestataire */
prestataireTelIndic.addEventListener("change", () => {
  if (prestataireTelIndic.value === "autre") {
    prestataireTelIndicAutre.style.display = "block";
  } else {
    prestataireTelIndicAutre.style.display = "none";
    prestataireTelIndicAutre.value = "";
  }
});


/* =======================
   7. CLIENT
   ======================= */
const clientType = document.getElementById("clientType");
const clientEntrepriseExtra = document.getElementById("clientEntrepriseExtra");
const clientRepRow = document.getElementById("clientRepRow");
const clientTelIndic = document.getElementById("clientTelIndic");
const clientTelIndicAutre = document.getElementById("clientTelIndicAutre");
const clientVille = document.getElementById("clientVille");
const clientVilleAutreRow = document.getElementById("clientVilleAutreRow");
const clientVilleAutre = document.getElementById("clientVilleAutre");

/* Type client */
clientType.addEventListener("change", () => {
  const isEnt = clientType.value === "entreprise";
  clientEntrepriseExtra.style.display = isEnt ? "flex" : "none";
  clientRepRow.style.display = isEnt ? "flex" : "none";

  if (!isEnt) {
    document.getElementById("clientRCCM").value = "";
    document.getElementById("clientNUI").value = "";
    document.getElementById("clientRep").value = "";
  }
});

/* Téléphone client */
clientTelIndic.addEventListener("change", () => {
  if (clientTelIndic.value === "autre") {
    clientTelIndicAutre.style.display = "block";
  } else {
    clientTelIndicAutre.style.display = "none";
    clientTelIndicAutre.value = "";
  }
});

/* Ville chantier (client) */
clientVille.addEventListener("change", () => {
  if (clientVille.value === "autre") {
    clientVilleAutreRow.style.display = "flex";
  } else {
    clientVilleAutreRow.style.display = "none";
    clientVilleAutre.value = "";
  }
});

/* =======================
   8. PHASES
   ======================= */

const tablePhases = document.getElementById("tablePhases").querySelector("tbody");
const addPhaseBtn = document.getElementById("addPhaseBtn");

/* Numérotation automatique : Phase I, Phase II, Phase III… */
function getRoman(n) {
  const romans = ["I","II","III","IV","V","VI","VII","VIII","IX","X"];
  return romans[n - 1] || n;
}

/* Ajout d’une phase */
addPhaseBtn.addEventListener("click", () => {
  const count = tablePhases.querySelectorAll("tr").length + 1;
  const phaseName = "Phase " + getRoman(count);

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="phase-name" value="${phaseName}" readonly></td>
    <td><input class="phase-desc" placeholder="Description de la phase"></td>
    <td><input class="phase-deb" type="date"></td>
    <td><input class="phase-fin" type="date"></td>
    <td><button type="button" class="secondary del-phase-row">Supprimer</button></td>
  `;

  tablePhases.appendChild(tr);
  refreshPhaseLists();
});

/* Suppression phase */
tablePhases.addEventListener("click", e => {
  if (!e.target.classList.contains("del-phase-row")) return;
  e.target.closest("tr").remove();
  renumberPhases();
  refreshPhaseLists();
});

/* Renumérotation après suppression */
function renumberPhases() {
  const trs = tablePhases.querySelectorAll("tr");
  trs.forEach((tr, i) => {
    tr.querySelector(".phase-name").value = "Phase " + getRoman(i + 1);
  });
}

/* Liste des phases courantes */
function getPhases() {
  return Array.from(document.querySelectorAll(".phase-name"))
    .map(e => e.value);
}

/* Mettre à jour les listes “Phase” dans MO et Matériel */
function refreshPhaseLists() {
  const phases = getPhases();

  document.querySelectorAll(".mdo-phase-select-estim").forEach(sel => {
    sel.innerHTML = `<option value="">Sans phase</option>` +
      phases.map(p => `<option value="${p}">${p}</option>`).join("");
  });

  document.querySelectorAll(".mdo-phase-select-quant").forEach(sel => {
    sel.innerHTML = `<option value="">Sans phase</option>` +
      phases.map(p => `<option value="${p}">${p}</option>`).join("");
  });

  document.querySelectorAll(".materiel-phase-select").forEach(sel => {
    sel.innerHTML = `<option value="">Sans phase</option>` +
      phases.map(p => `<option value="${p}">${p}</option>`).join("");
  });
}

/* Initial refresh */
refreshPhaseLists();

/* Petit utilitaire : ville chantier (pour placement) */
function getChantierVille() {
  const v = clientVille.value;
  if (v === "autre") return clientVilleAutre.value || "";
  return v || "";
}
</script>

<script>
/* ============================================================
   JS QemWork – PHASE 3/4
   (M.O, matériel, placement, commissions, dashboard simplifié)
   ============================================================ */

/* =======================
   9. MAIN D’ŒUVRE – ESTIMATIF
   ======================= */

const tableMdoEstim = document.querySelector("#tableMdoEstim tbody");
const btnAddMdoEstim = document.getElementById("btnAddMdoEstim");

/* calcul ligne estimatif */
function calcMdoEstimLine(tr) {
  const qte = parseFloat(tr.querySelector(".mdo-qte-estim").value) || 0;
  const pu  = parseFloat(tr.querySelector(".mdo-pu-estim").value) || 0;

  const total = qte * pu;
  tr.querySelector(".mdo-total-estim").textContent = formatFCFA(total);

  return total;
}

/* total estimatif */
function sumMdoEstimatif() {
  let total = 0;
  tableMdoEstim.querySelectorAll("tr").forEach(tr => {
    total += calcMdoEstimLine(tr);
  });
  return total;
}

/* ajout ligne */
btnAddMdoEstim.addEventListener("click", () => {
  const index = tableMdoEstim.querySelectorAll("tr").length + 1;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>1.${index}</td>
    <td>
      <select class="mdo-phase-select-estim"></select>
    </td>
    <td><input class="mdo-desc-estim" placeholder="Désignation"></td>
    <td><input class="mdo-unite-estim" placeholder="Unité"></td>
    <td><input class="num mdo-qte-estim" type="number" value="1"></td>
    <td><input class="num mdo-pu-estim" type="number" placeholder="PU"></td>
    <td class="num mdo-total-estim">0 FCFA</td>
    <td><button type="button" class="secondary btnDelMdoEstim">X</button></td>
  `;

  tableMdoEstim.appendChild(tr);
  refreshPhaseLists();
  calcMdoEstimLine(tr);
  updateAllCalculations();
});

/* recalculs + suppression */
tableMdoEstim.addEventListener("input", e => {
  if (e.target.closest("tr")) {
    calcMdoEstimLine(e.target.closest("tr"));
    updateAllCalculations();
  }
});

tableMdoEstim.addEventListener("click", e => {
  if (!e.target.classList.contains("btnDelMdoEstim")) return;
  e.target.closest("tr").remove();
  updateAllCalculations();
});

/* init */
tableMdoEstim.querySelectorAll("tr").forEach(calcMdoEstimLine);


/* =======================
   10. MAIN D’ŒUVRE – QUANTITATIF
   ======================= */

const tableMdoQuant = document.querySelector("#tableMdoQuant tbody");
const btnAddMdoQuant = document.getElementById("btnAddMdoQuant");

/* Calcul ligne MO quantitatif */
function calcMdoQuantLine(tr) {
  const qte = parseFloat(tr.querySelector(".mdo-qte-quant").value) || 0;
  const pu  = parseFloat(tr.querySelector(".mdo-pu-quant").value) || 0;

  const total = qte * pu;
  tr.querySelector(".mdo-total-quant").textContent = formatFCFA(total);

  return total;
}

/* Somme MO quantitatif */
function sumMdoQuant() {
  let total = 0;
  tableMdoQuant.querySelectorAll("tr").forEach(tr => {
    total += calcMdoQuantLine(tr);
  });
  return total;
}

/* Ajout ligne MO quantitatif */
btnAddMdoQuant.addEventListener("click", () => {
  const index = tableMdoQuant.querySelectorAll("tr").length + 1;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>1.${index}</td>
    <td>
      <select class="mdo-phase-select-quant"></select>
    </td>
    <td><input class="mdo-desc-quant" placeholder="Désignation"></td>
    <td><input class="mdo-unite-quant" placeholder="Unité"></td>
    <td><input class="num mdo-qte-quant" type="number" value="1"></td>
    <td><input class="num mdo-pu-quant" type="number" placeholder="PU"></td>
    <td class="num mdo-total-quant">0 FCFA</td>
    <td><button type="button" class="secondary btnDelMdoQuant">X</button></td>
  `;

  tableMdoQuant.appendChild(tr);
  refreshPhaseLists();
  calcMdoQuantLine(tr);
  updateAllCalculations();
});

/* recalcul auto */
tableMdoQuant.addEventListener("input", e => {
  if (e.target.closest("tr")) {
    calcMdoQuantLine(e.target.closest("tr"));
    updateAllCalculations();
  }
});

/* suppression ligne */
tableMdoQuant.addEventListener("click", e => {
  if (!e.target.classList.contains("btnDelMdoQuant")) return;
  e.target.closest("tr").remove();
  updateAllCalculations();
});

/* init */
tableMdoQuant.querySelectorAll("tr").forEach(calcMdoQuantLine);


/* =======================
   11. MATÉRIEL – QUANTITATIF
   ======================= */

const tableMateriel = document.querySelector("#tableMateriel tbody");
const btnAddMateriel = document.getElementById("btnAddMateriel");

/* Calcul ligne matériel */
function calcMaterielLine(tr) {
  const qte = parseFloat(tr.querySelector(".materiel-qte").value) || 0;
  const pu  = parseFloat(tr.querySelector(".materiel-pu").value) || 0;

  const total = qte * pu;
  tr.querySelector(".materiel-total").textContent = formatFCFA(total);

  return total;
}

/* total matériel */
function sumMateriel() {
  let total = 0;
  tableMateriel.querySelectorAll("tr").forEach(tr => {
    total += calcMaterielLine(tr);
  });
  return total;
}

/* ajout matériel */
btnAddMateriel.addEventListener("click", () => {
  const index = tableMateriel.querySelectorAll("tr").length + 1;

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>2.${index}</td>
    <td><select class="materiel-phase-select"></select></td>
    <td><input class="materiel-desc" placeholder="Désignation"></td>
    <td><input class="materiel-unite" placeholder="Unité"></td>
    <td><input class="num materiel-qte" type="number" value="1"></td>
    <td><input class="num materiel-pu" type="number" placeholder="PU"></td>
    <td class="num materiel-total">0 FCFA</td>
    <td><button type="button" class="secondary btnDelLigneMat">X</button></td>
  `;

  tableMateriel.appendChild(tr);
  refreshPhaseLists();
  calcMaterielLine(tr);
  updateAllCalculations();
});

/* recalcul matériel */
tableMateriel.addEventListener("input", e => {
  if (e.target.closest("tr")) {
    calcMaterielLine(e.target.closest("tr"));
    updateAllCalculations();
  }
});

/* suppression */
tableMateriel.addEventListener("click", e => {
  if (!e.target.classList.contains("btnDelLigneMat")) return;
  e.target.closest("tr").remove();
  updateAllCalculations();
});


/* =======================
   12. PLACEMENT DE PERSONNEL
   ======================= */

const tablePlacement = document.querySelector("#tablePlacement tbody");
const btnAddPlacement = document.getElementById("btnAddPlacement");

/* Autocomplete corps de métiers pour placement */
function initPlacementAutocomplete() {
  document.querySelectorAll(".place-corps-input").forEach((input) => {
    const container = input.nextElementSibling;
    setupAutocomplete(input, container, QW_CORPS_METIER);
  });
}
initPlacementAutocomplete();

/* Calcul ligne placement (barème QemWork) */
function calcPlacementLine(tr) {

  const qteTech   = parseFloat(tr.querySelector(".place-qte").value) || 0;
  const tarifJour = parseFloat(tr.querySelector(".place-tarif").value) || 0;
  const jours     = parseFloat(tr.querySelector(".place-jours").value) || 0;
  const km        = parseFloat(tr.querySelector(".place-km").value) || 0;
  const hebChoisi = tr.querySelector(".place-heberg-prise").value;
  const villeTech = tr.querySelector(".place-ville-tech").value;
  const villeChantier = getChantierVille();

  let heberg = parseFloat(tr.querySelector(".place-heberg").value) || 0;

  /* 1. Frais de déplacement */
  let fraisDep = 0;

  if (km <= 3) {
    fraisDep = 0;
  } else {
    if (hebChoisi === "oui") {
      // Hébergement pris en charge, déplacement forfaité par km
      fraisDep = km * 230;
    } else {
      // Pas d'hébergement pris en charge : déplacement par jour et par technicien
      fraisDep = km * 230 * jours * qteTech;
    }
  }
  tr.querySelector(".place-depl").textContent = formatFCFA(fraisDep);

  /* 2. Hébergement obligatoire (distance + ville différente) */
  if (villeTech && villeChantier && villeTech !== villeChantier && km > 10 && hebChoisi === "non") {
    if (heberg < 2500) {
      heberg = 2500;
      tr.querySelector(".place-heberg").value = 2500;
    }
  }

  /* hébergement total */
  const totHeberg = heberg * jours * qteTech;

  /* 3. Total ligne */
  const total = (tarifJour * jours * qteTech) + fraisDep + totHeberg;

  tr.querySelector(".place-total").textContent = formatFCFA(total);

  /* Alerte distance */
  tr.querySelector(".place-km-alert").style.display = km >= 20 ? "block" : "none";

  return total;
}

/* Somme placement */
function sumPlacement() {
  let total = 0;
  tablePlacement.querySelectorAll("tr").forEach(tr => {
    total += calcPlacementLine(tr);
  });
  return total;
}

/* Ajout d’une ligne placement */
btnAddPlacement.addEventListener("click", () => {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <div class="autocomplete-container">
        <input class="place-corps-input" placeholder="Ex : Maçon, Plombier...">
        <div class="autocomplete-results place-corps-results" style="display:none;"></div>
      </div>
    </td>
    <td>
      <select class="place-ville-tech">
        <option value="" disabled selected>Ville technicien</option>
        <option value="Yaoundé">Yaoundé</option>
        <option value="Douala">Douala</option>
        <option value="autre">Autre</option>
      </select>
      <input class="place-ville-tech-autre" placeholder="Autre ville" style="display:none;margin-top:4px;">
    </td>
    <td>
      <select class="place-heberg-prise">
        <option value="non">Non</option>
        <option value="oui">Oui</option>
      </select>
    </td>
    <td><input class="num place-qte" type="number" value="1"></td>
    <td><input class="num place-tarif" type="number"></td>
    <td><input class="num place-jours" type="number" value="1"></td>
    <td>
      <input class="num place-km" type="number" value="0">
      <div class="alert-red place-km-alert" style="display:none;">Distance ≥ 20 km : hébergement min. 2 500 FCFA/pers/jour.</div>
    </td>
    <td class="num place-depl">0 FCFA</td>
    <td><input class="num place-heberg" type="number" value="2500"></td>
    <td class="num place-total">0 FCFA</td>
    <td><button type="button" class="secondary btnDelLignePlacement">X</button></td>
  `;

  tablePlacement.appendChild(tr);
  initPlacementAutocomplete();
  calcPlacementLine(tr);
  updateAllCalculations();
});

/* recalcul placement */
tablePlacement.addEventListener("input", e => {
  if (e.target.closest("tr")) {
    calcPlacementLine(e.target.closest("tr"));
    updateAllCalculations();
  }
});

/* suppression */
tablePlacement.addEventListener("click", e => {
  if (!e.target.classList.contains("btnDelLignePlacement")) return;
  e.target.closest("tr").remove();
  updateAllCalculations();
});

/* init first row */
tablePlacement.querySelectorAll("tr").forEach(calcPlacementLine);


/* =======================
   13. TOTAUX GLOBAUX – ACCÈS UTILITAIRES
   ======================= */

/* Get total M.O selon type de devis */
function getTotalMO() {
  const type = document.getElementById("typeDevis").value;
  const mission = missionType.value;

  // Pour une mission de placement pur, on ignore la M.O saisie
  if (mission === "placement") return 0;

  if (type === "estimatif") {
    return sumMdoEstimatif();
  } else {
    return sumMdoQuant();
  }
}

/* Get total matériel */
function getTotalMateriel() {
  const type = document.getElementById("typeDevis").value;
  const mission = missionType.value;

  if (mission === "placement") return 0;
  return type === "quantitatif" ? sumMateriel() : 0;
}

/* Get total placement */
function getTotalPlacement() {
  return sumPlacement();
}

/* Total TTC global (simple) avant détail commissions */
function getTotalTTCGlobal() {
  return getTotalMO() + getTotalMateriel() + getTotalPlacement();
}

/* Petit utilitaire vers nombre */
function toNumber(str) {
  return parseFCFA(str);
}
</script>
<script>
/* =======================
   14. COMMISSIONS & SYNTHÈSE INTERNE – BARÈMES QEMWORK
   ======================= */

/**
 * Barème TECHNICIEN sur la MO (en moins sur la MO)
 */
function getTauxTechBase(typeMission, totalMO) {
  const m = totalMO || 0;

  // Cas URGENCE : les taux horaires sont déjà gérés par updateUrgenceRates()
  // => ici on ne remet pas un barème, on complète juste pour les missions non-urgence.
  if (typeMission === "urgence") {
    // En urgence, la part technicien est gérée par _tauxUrgenceTech (sur la MO côté client)
    // donc getTauxTechBase retourne 0, et on ajoute ensuite _tauxUrgenceTech.
    return 0;
  }

  // Missions classiques : Réparation / Entretien / Petits travaux / Gros travaux
  if (typeMission === "reparation" ||
      typeMission === "entretien" ||
      typeMission === "petits" ||
      typeMission === "gros") {

    if (m < 100000) return 0.17;
    return 0.15;
  }

  // Construction complète
  if (typeMission === "construction") {
    return 0.15;
  }

  // Placement : la commission technicien est 10 % sur le tarif journalier de base
  // C'est géré sur le bloc placement via un taux dédié, donc ici : 0 sur la MO.
  if (typeMission === "placement") {
    return 0;
  }

  // Par défaut (sécurité)
  return 0.17;
}

/**
 * Barème CLIENT (en plus du total devis TTC : MO + Mat + Placement)
 */
function getTauxClientBase(typeMission, totalTTC) {
  const t = totalTTC || 0;

  // URGENCE : barème spécifique déjà géré via _tauxUrgenceClient (par jour/créneau)
  if (typeMission === "urgence") {
    // On considère que la composante "client" en urgence est
    // intégralement _tauxUrgenceClient ; donc ici base = 0.
    return 0;
  }

  // Missions classiques (Réparation / Entretien / Petits / Gros)
  if (typeMission === "reparation" ||
      typeMission === "entretien" ||
      typeMission === "petits" ||
      typeMission === "gros") {

    if (t < 100000) return 0.07;
    if (t <= 1000000) return 0.05;
    return 0.03;
  }

  // Projets
  if (typeMission === "construction") {
    return 0.03;   // Construction complète : +3 %
  }
  if (typeMission === "placement") {
    return 0.10;  // Placement : +10 %
  }

  // Par défaut
  return 0.07;
}

/**
 * Calcule toutes les commissions et remplit la synthèse interne.
 * Respecte :
 *  - barème TECH ci-dessus (en moins sur la MO et le placement),
 *  - barème CLIENT ci-dessus (en plus du total TTC),
 *  - total face client = (MO + Mat + Placement) + frais front TTC client,
 *  - TVA 19,25 % sur les commissions QemWork.
 */
function getPlacementTarifJournalierTotalTTC() {
  // Somme TTC "tarif journalier" uniquement (hors déplacement/hébergement)
  let total = 0;
  document.querySelectorAll("#tablePlacement tbody tr").forEach(tr => {
    const qte   = parseFloat(tr.querySelector(".place-qte")?.value) || 0;
    const jours = parseFloat(tr.querySelector(".place-jours")?.value) || 0;
    const tarif = parseFloat(tr.querySelector(".place-tarif")?.value) || 0;
    total += qte * jours * tarif;
  });
  return total;
}

function computeCommissions() {
  const typeDevis    = document.getElementById("typeDevis")?.value || "estimatif";
  const typeMission  = document.getElementById("missionType")?.value || "";
  const isPlacement  = (typeMission === "placement");
  const isUrgence    = (typeMission === "urgence");

  const tvaRate = (typeof TVA === "number") ? TVA : 0.1925;
  const divTVA  = 1 + tvaRate;

  // 1) Totaux TTC (hors commissions QW)
  const totalMO_TTC        = getTotalMO();         // 0 si placement pur (chez toi)
  const totalMat_TTC       = getTotalMateriel();   // 0 si placement pur
  const totalPlacement_TTC = getTotalPlacement();  // tarif+dep+heberg

  // 2) Urgence (si applicable)
  const tauxUrgClient = isUrgence ? (window._tauxUrgenceClient || 0) : 0;
  const tauxUrgTech   = isUrgence ? (window._tauxUrgenceTech || 0) : 0;

  const majClientMO = totalMO_TTC * tauxUrgClient;
  const majTechMO   = totalMO_TTC * tauxUrgTech;

  const moClientTTC = totalMO_TTC + majClientMO;
  const moTechTTC   = totalMO_TTC + majTechMO;

  // 3) Total brut TTC (sans frais front client)
  const totalBrutTTC = moClientTTC + totalMat_TTC + totalPlacement_TTC;

  // 4) Taux (placement forcé à 10% / 10%)
  let tauxTechTotal, tauxClientTotal;

  if (isPlacement) {
    tauxTechTotal   = 0.10;
    tauxClientTotal = 0.10;
  } else {
    const tauxTechBase   = getTauxTechBase(typeMission, totalMO_TTC);
    const tauxClientBase = getTauxClientBase(typeMission, totalBrutTTC);
    tauxTechTotal   = tauxTechBase + tauxUrgTech;
    tauxClientTotal = tauxClientBase + tauxUrgClient;
  }

  // 5) Base placement "tarif journalier" (TTC) et MO TTC pris en compte (commission TTC)
  const totalTarifJour_TTC = isPlacement ? getPlacementTarifJournalierTotalTTC() : 0;

  // MO TTC pris en compte (champ demandé) :
  // - placement: totalTarifJour * 10%
  // - hors placement: commission tech sur la MO client (comme avant)
  const moTTCPrisEnCompte = isPlacement
    ? (totalTarifJour_TTC * tauxTechTotal)
    : (moClientTTC * tauxTechTotal);

  // 6) Conversions HT/TVA selon ta règle unique
  const moHTPrisEnCompte  = moTTCPrisEnCompte / divTVA;
  const tvaMOPrisEnCompte = moTTCPrisEnCompte - moHTPrisEnCompte;

  // 7) Commission CLIENT TTC (frais front) sur total brut TTC
  const commissionClient_TTC = totalBrutTTC * tauxClientTotal;
  const commissionClient_HT  = commissionClient_TTC / divTVA;
  const tvaClient            = commissionClient_TTC - commissionClient_HT;

  // 8) Part QemWork TECH (si tu veux “total tech” TTC = moTTCPrisEnCompte + (placement*10% hors placement))
  // En placement, tu ne veux PAS prendre le placement global, uniquement le tarif journalier.
  const commissionPlacementTech_TTC = (!isPlacement) ? (totalPlacement_TTC * 0.10) : 0;

  const commissionTech_TTC = moTTCPrisEnCompte + commissionPlacementTech_TTC;
  const commissionTech_HT  = commissionTech_TTC / divTVA;
  const tvaTechTotal       = commissionTech_TTC - commissionTech_HT;

  const commissionTotale_HT = commissionTech_HT + commissionClient_HT;
  const tvaTotale_QW        = tvaTechTotal + tvaClient;

  // 9) Net technicien TTC
  // Placement (ta règle): net = totalTarifJour - (totalTarifJour*10%)
  // Hors placement: net MO = moTechTTC - (moClientTTC*tauxTechTotal), net placement = totalPlacement - placement*10%
  const netTech_TTC = isPlacement
    ? (totalTarifJour_TTC - moTTCPrisEnCompte)
    : ((moTechTTC - (moClientTTC * tauxTechTotal)) + (totalPlacement_TTC - commissionPlacementTech_TTC));

  // 10) Total TTC client
  const totalClientTTC = totalBrutTTC + commissionClient_TTC;
  const fraisFront_TTC = commissionClient_TTC;

  // 11) Affichage taux
  document.getElementById("tauxTechInterne").value =
    (tauxTechTotal * 100).toFixed(1) + " %";
  document.getElementById("tauxClientInterne").value =
    (tauxClientTotal * 100).toFixed(1) + " %";

  // 12) Champs internes (mêmes champs)
  // MO TTC pris en compte (cas placement = totalTarifJour*10%)
  document.getElementById("mdoDisplayInterne").value   = formatFCFA(moTTCPrisEnCompte);
  document.getElementById("totalDevisInterne").value   = formatFCFA(totalBrutTTC);

  // Part QemWork MO HT (technicien) = HT de la MO TTC pris en compte
  document.getElementById("partQemInterne").value      = formatFCFA(moHTPrisEnCompte);

  // TVA sur part MO technicien = TTC - HT
  document.getElementById("tvaTech").value             = formatFCFA(tvaMOPrisEnCompte);

  // Net TTC technicien
  document.getElementById("netTechInterne").value      = formatFCFA(netTech_TTC);

  // Client HT/TVA (même règle)
  document.getElementById("commClientHT").value        = formatFCFA(commissionClient_HT);
  document.getElementById("tvaClient").value           = formatFCFA(tvaClient);

  // Totaux QW
  document.getElementById("commissionTotaleHT").value  = formatFCFA(commissionTotale_HT);
  document.getElementById("tvaTotaleQW").value         = formatFCFA(tvaTotale_QW);

  // Frais front + total client TTC
  document.getElementById("fraisFrontInterne").value     = formatFCFA(fraisFront_TTC);
  document.getElementById("totalClientTTCInterne").value = formatFCFA(totalClientTTC);

  // Highlights
  document.getElementById("netTechHighlight").value   = formatFCFA(netTech_TTC);
  document.getElementById("commTotalHighlight").value = formatFCFA(commissionTotale_HT);
  document.getElementById("tvaTotaleHighlight").value = formatFCFA(tvaTotale_QW);

  return {
    totalMO_TTC,
    totalMat_TTC,
    totalPlacement_TTC,
    totalTarifJour_TTC,
    totalBrutTTC,
    totalClientTTC,
    tauxTechTotal,
    tauxClientTotal,
    moTTCPrisEnCompte,
    moHTPrisEnCompte,
    tvaMOPrisEnCompte,
    commissionClient_TTC,
    commissionClient_HT,
    tvaClient,
    commissionPlacementTech_TTC,
    commissionTech_TTC,
    commissionTech_HT,
    tvaTechTotal,
    commissionTotale_HT,
    tvaTotale_QW,
    netTech_TTC,
    fraisFront_TTC
  };
}

/* Mise à jour globale */
function updateFinalTotals() {
  computeCommissions();
}

/* =======================
   15. FONCTION CENTRALE – UPDATE ALL
   ======================= */
function updateAllCalculations() {
  updateFinalTotals();
}

/* Lancement automatique au chargement */
setTimeout(() => {
  updateAllCalculations();
}, 400);
</script>

<script>
/* ============================================================
   JS QemWork – PHASE 4/4
   (face client, export, factures, validation)
   ============================================================ */

/* ------------------------------------------------------------
   16. UTILITAIRES POUR RÉCAP PHASES
------------------------------------------------------------ */
function buildDevisFilename(extension) {
  const typeDevis = document.getElementById("typeDevis")?.value;
  let prefix = "devis_client_qemwork";

  if (typeDevis === "quantitatif") {
    prefix = "devis_client_quantitatif_qemwork";
  } else if (typeDevis === "estimatif") {
    prefix = "devis_client_estimatif_qemwork";
  }

  const clientNom  = document.getElementById("clientNom")?.value || "client";
  const missionNum = document.getElementById("devisNum")?.value || ""; // adapte si ton champ a un autre id

  const safeClientNom = clientNom
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^a-zA-Z0-9_-]/g, "");

  const safeMission = missionNum
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^a-zA-Z0-9_-]/g, "");

  const base = `${prefix}_N${safeMission}_${safeClientNom}`;
  return extension ? `${base}.${extension.replace(/^\./, "")}` : base;
}

function getLinesMDOEstim() {
  return Array.from(document.querySelectorAll("#tableMdoEstim tbody tr")).map(tr => ({
    phase: tr.querySelector(".mdo-phase-select-estim")?.value || "",
    desc: tr.querySelector(".mdo-desc-estim")?.value || "",
    qte: parseFloat(tr.querySelector(".mdo-qte-estim")?.value) || 0,
    pu:  parseFloat(tr.querySelector(".mdo-pu-estim")?.value) || 0,
    total: (parseFloat(tr.querySelector(".mdo-qte-estim")?.value) || 0) *
           (parseFloat(tr.querySelector(".mdo-pu-estim")?.value) || 0)
  }));
}
function getLinesMDOQuant() {
  return Array.from(document.querySelectorAll("#tableMdoQuant tbody tr")).map(tr => ({
    phase: tr.querySelector(".mdo-phase-select-quant")?.value || "",
    desc: tr.querySelector(".mdo-desc-quant")?.value || "",
    qte: parseFloat(tr.querySelector(".mdo-qte-quant")?.value) || 0,
    pu:  parseFloat(tr.querySelector(".mdo-pu-quant")?.value) || 0,
    total: (parseFloat(tr.querySelector(".mdo-qte-quant")?.value) || 0) *
           (parseFloat(tr.querySelector(".mdo-pu-quant")?.value) || 0)
  }));
}
function getLinesMateriel() {
  return Array.from(document.querySelectorAll("#tableMateriel tbody tr")).map(tr => ({
    phase: tr.querySelector(".materiel-phase-select")?.value || "",
    desc: tr.querySelector(".materiel-desc")?.value || "",
    qte: parseFloat(tr.querySelector(".materiel-qte")?.value) || 0,
    pu:  parseFloat(tr.querySelector(".materiel-pu")?.value) || 0,
    total: (parseFloat(tr.querySelector(".materiel-qte")?.value) || 0) *
           (parseFloat(tr.querySelector(".materiel-pu")?.value) || 0)
  }));
}
function getLinesPlacement() {
  return Array.from(document.querySelectorAll("#tablePlacement tbody tr")).map(tr => {
    const corps = tr.querySelector(".place-corps-input")?.value || "";
    const villeTechSel = tr.querySelector(".place-ville-tech")?.value || "";
    const villeTechAutre = tr.querySelector(".place-ville-tech-autre")?.value || "";
    const villeTech = villeTechSel === "autre" ? villeTechAutre : villeTechSel;

    const hebergPrise = tr.querySelector(".place-heberg-prise")?.value || "non";
    const qte        = parseFloat(tr.querySelector(".place-qte")?.value) || 0;
    const tarif      = parseFloat(tr.querySelector(".place-tarif")?.value) || 0;
    const jours      = parseFloat(tr.querySelector(".place-jours")?.value) || 0;
    const km         = parseFloat(tr.querySelector(".place-km")?.value) || 0;
    const hebergUnit = parseFloat(tr.querySelector(".place-heberg")?.value) || 0;

    // Total ligne affiché (TTC) déjà calculé dans le tableau
    const totalLine  = parseFCFA(tr.querySelector(".place-total")?.textContent || "0");

    // Total tarif jour
    const totalTarifJour = qte * jours * tarif;

    // Total hébergement
    const totalHeberg = hebergUnit * jours * qte;

    return {
      corps,
      villeTech,
      hebergPrise,
      qte,
      tarif,
      jours,
      km,
      hebergUnit,
      totalHeberg,
      total: totalLine,
      totalTarifJour
    };
  });
}/* structuration par phases pour face client
   + AJOUT : détail matériel (Qté / PU / Total) pour devis quantitatif */
function genererRecapParPhase() {
  const typeDevis   = document.getElementById("typeDevis").value;
  const typeMission = document.getElementById("missionType").value || "";

  const synth = computeCommissions();
  const fraisFrontGlobal = synth.fraisFront_TTC || 0;
  const totalClientTTC   = synth.totalClientTTC || 0;

  // CAS 1 : MISSION PLACEMENT (récap spécifique)
  if (typeMission === "placement") {
    const lines = getLinesPlacement();

    let totalPlacement = 0;
    let totalHeberg   = 0;
    lines.forEach(l => {
      totalPlacement += l.total || 0;
      totalHeberg   += l.totalHeberg || 0;
    });

    const totalFraisQW = fraisFrontGlobal;
    const totalFacture = totalClientTTC;

    let html = `
      <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
        <tr style="background:#e6f0ff; font-weight:bold;">
          <td>Corps de métier</td>
          <td>Ville technicien</td>
          <td style="text-align:right;">Qté</td>
          <td style="text-align:right;">Jours</td>
          <td style="text-align:right;">Tarif jour TTC</td>
          <td>Hébergement pris en charge</td>
          <td style="text-align:right;">Distance (km)</td>
          <td style="text-align:right;">Frais hébergement TTC</td>
          <td style="text-align:right;">Total ligne TTC</td>
        </tr>
    `;

    lines.forEach(l => {
      html += `
        <tr>
          <td>${l.corps}</td>
          <td>${l.villeTech}</td>
          <td style="text-align:right;">${l.qte}</td>
          <td style="text-align:right;">${l.jours}</td>
          <td style="text-align:right;">${fmt(l.tarif)}</td>
          <td>${l.hebergPrise === "oui" ? "Oui" : "Non"}</td>
          <td style="text-align:right;">${l.km}</td>
          <td style="text-align:right;">${fmt(l.totalHeberg)}</td>
          <td style="text-align:right;">${fmt(l.total)}</td>
        </tr>
      `;
    });

    // LIGNE TOTAL POUR LE PLACEMENT
    html += `
        <tr style="background:#f5f9ff;font-weight:bold;">
          <td colspan="7" style="text-align:right;">TOTAL</td>
          <td style="text-align:right;">${fmt(totalHeberg)}</td>
          <td style="text-align:right;">${fmt(totalPlacement)}</td>
        </tr>
      </table>
    `;

    // Bloc récapitulatif dessous
    html += `
      <div style="margin-top:8px; font-size:0.82rem;">
        <strong>Récapitulatif placement :</strong><br>
        • Total placement TTC : ${fmt(totalPlacement)}<br>
        • Total frais QemWork (frais front client) TTC : ${fmt(totalFraisQW)}
      </div>
    `;

    return {
      html,
      totalGlobal: totalFacture,
      totalGlobalFmt: fmt(totalFacture),
      totalMO: 0
    };
  }

  // CAS 2 : DEVIS ESTIMATIF (M.O + frais QW)
  if (typeDevis === "estimatif") {
    const phases = Array.from(document.querySelectorAll("#tablePhases tbody tr")).map(tr => ({
      name: tr.querySelector(".phase-name")?.value || "",
      desc: tr.querySelector(".phase-desc")?.value || ""
    }));

    const mdoEstim = getLinesMDOEstim();   // lignes de M.O. (estimatif)

    const phaseTotals = [];
    phases.forEach(ph => {
      const phName = ph.name;
      let totalMOP = 0;

      // Somme de la M.O. de la phase
      mdoEstim.filter(l => l.phase === phName).forEach(l => totalMOP += l.total);

      phaseTotals.push({
        name: phName,
        desc: ph.desc || "",
        totalMOP
      });
    });

    // Répartition des frais QW sur les phases, au prorata de la M.O.
    const baseRepart = phaseTotals.reduce((acc, ph) => acc + ph.totalMOP, 0) || 1;
    phaseTotals.forEach(ph => {
      const ratio = ph.totalMOP / baseRepart;
      ph.fraisFront       = fraisFrontGlobal * ratio;
      ph.totalPhaseClient = ph.totalMOP + ph.fraisFront;
    });

    let totalGlobalMOTTC  = 0;
    let totalGlobalFrais  = 0;
    let totalGlobalClient = 0;

    let html = `
      <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
        <tr style="background:#e6f0ff; font-weight:bold;">
          <td>Phase</td>
          <td>Libellé phase</td>
          <td style="text-align:right;">Main d'œuvre (TTC)</td>
          <td style="text-align:right;">Frais QemWork client (TTC)</td>
          <td style="text-align:right;">Total phase TTC (client)</td>
        </tr>
    `;

    phaseTotals.forEach(ph => {
      totalGlobalMOTTC  += ph.totalMOP;
      totalGlobalFrais  += ph.fraisFront;
      totalGlobalClient += ph.totalPhaseClient;

      html += `
        <tr>
          <td><strong>${ph.name}</strong></td>
          <td>${ph.desc}</td>
          <td style="text-align:right;">${fmt(ph.totalMOP)}</td>
          <td style="text-align:right;">${fmt(ph.fraisFront)}</td>
          <td style="text-align:right;"><strong>${fmt(ph.totalPhaseClient)}</strong></td>
        </tr>
      `;
    });

    // Ligne TOTAL
    html += `
        <tr style="background:#f5f9ff;font-weight:bold;">
          <td colspan="2" style="text-align:right;">TOTAL</td>
          <td style="text-align:right;">${fmt(totalGlobalMOTTC)}</td>
          <td style="text-align:right;">${fmt(totalGlobalFrais)}</td>
          <td style="text-align:right;">${fmt(totalGlobalClient)}</td>
        </tr>
      </table>
      <div style="margin-top:8px; font-size:0.82rem;">
        <strong>Récapitulatif des montants :</strong><br>
        • Total main d'œuvre TTC : ${fmt(totalGlobalMOTTC)}<br>
        • Total frais QemWork (front client) TTC : ${fmt(totalGlobalFrais)}
      </div>
    `;

    return {
      html,
      totalGlobal: totalGlobalClient,
      totalGlobalFmt: fmt(totalGlobalClient),
      totalMO: totalGlobalMOTTC,
      phaseTotalsEstimatif: phaseTotals
    };
  }

  // CAS 3 : DEVIS QUANTITATIF (MO + Mat + Frais QW par phase)
  const phases = Array.from(document.querySelectorAll("#tablePhases tbody tr")).map(tr => ({
    name: tr.querySelector(".phase-name")?.value || "",
    desc: tr.querySelector(".phase-desc")?.value || ""
  }));

  const mdoQuant = getLinesMDOQuant();
  const mat      = getLinesMateriel();

  const phaseTotals = [];
  phases.forEach(ph => {
    const phName = ph.name;
    let totalMOP = 0;
    let totalMatP = 0;

    mdoQuant.filter(l => l.phase === phName).forEach(l => totalMOP += l.total);
    mat     .filter(l => l.phase === phName).forEach(l => totalMatP += l.total);

    const totalPhaseSansFrais = totalMOP + totalMatP;
    phaseTotals.push({
      name: phName,
      desc: ph.desc || "",
      totalMOP,
      totalMatP,
      totalPhaseSansFrais
    });
  });

  const baseRepartQ = phaseTotals.reduce((acc, ph) => acc + ph.totalPhaseSansFrais, 0) || 1;
  phaseTotals.forEach(ph => {
    const ratio = ph.totalPhaseSansFrais / baseRepartQ;
    ph.fraisFront       = fraisFrontGlobal * ratio;
    ph.totalPhaseClient = ph.totalPhaseSansFrais + ph.fraisFront;
  });

  let totalGlobalMOTTC  = 0;
  let totalGlobalMatTTC = 0;
  let totalGlobalFrais  = 0;
  let totalGlobalClient = 0;

  let html = `
    <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
      <tr style="background:#e6f0ff; font-weight:bold;">
        <td>Phase</td>
        <td>Libellé phase</td>
        <td style="text-align:right;">Main d'œuvre (TTC)</td>
        <td style="text-align:right;">Matériel (TTC)</td>
        <td style="text-align:right;">Frais QemWork client (TTC)</td>
        <td style="text-align:right;">Total phase TTC (client)</td>
      </tr>
  `;

    phaseTotals.forEach(ph => {
    totalGlobalMOTTC  += ph.totalMOP;
    totalGlobalMatTTC += ph.totalMatP;
    totalGlobalFrais  += ph.fraisFront;
    totalGlobalClient += ph.totalPhaseClient;

    html += `
      <tr>
        <td><strong>${ph.name}</strong></td>
        <td>${ph.desc}</td>
        <td style="text-align:right;">${fmt(ph.totalMOP)}</td>
        <td style="text-align:right;">${fmt(ph.totalMatP)}</td>
        <td style="text-align:right;">${fmt(ph.fraisFront)}</td>
        <td style="text-align:right;"><strong>${fmt(ph.totalPhaseClient)}</strong></td>
      </tr>
    `;
  });

  // LIGNE TOTAL
  html += `
    <tr style="background:#f5f9ff;font-weight:bold;">
      <td colspan="2" style="text-align:right;">TOTAL</td>
      <td style="text-align:right;">${fmt(totalGlobalMOTTC)}</td>
      <td style="text-align:right;">${fmt(totalGlobalMatTTC)}</td>
      <td style="text-align:right;">${fmt(totalGlobalFrais)}</td>
      <td style="text-align:right;">${fmt(totalGlobalClient)}</td>
    </tr>
  `;
  html += `</table>`;

  // Détail matériel
  let htmlMateriel = "";
  if (mat.length > 0) {
    htmlMateriel += `
      <div style="margin-top:10px;font-size:0.8rem;">
        <strong>Détail du matériel et fournitures (quantités et prix unitaires) :</strong>
        <table style="width:100%; border-collapse:collapse; margin-top:4px;">
          <tr style="background:#f5f5f5; font-weight:bold;">
            <td>Phase</td>
            <td>Désignation</td>
            <td style="text-align:right;">Qté</td>
            <td style="text-align:right;">P. Unit. TTC</td>
            <td style="text-align:right;">Total TTC</td>
          </tr>
    `;

    mat.forEach(l => {
      if (!l.desc && !l.total) return;
      htmlMateriel += `
        <tr>
          <td>${l.phase || "-"}</td>
          <td>${l.desc || ""}</td>
          <td style="text-align:right;">${l.qte || ""}</td>
          <td style="text-align:right;">${l.pu ? fmt(l.pu) : ""}</td>
          <td style="text-align:right;">${fmt(l.total || 0)}</td>
        </tr>
      `;
    });

    htmlMateriel += `</table></div>`;
  }

  return {
    html: html + htmlMateriel,
    totalGlobal: totalGlobalClient,
    totalGlobalFmt: fmt(totalGlobalClient),
    totalMO: totalGlobalMOTTC
  };
}


(function () {
  function toggleBlocPlacement() {
    const missionEl = document.getElementById("missionType");
    const bloc = document.getElementById("blocPlacement");
    if (!missionEl || !bloc) return;

    bloc.style.display = (missionEl.value === "placement") ? "block" : "none";
  }

  // Au chargement
  document.addEventListener("DOMContentLoaded", toggleBlocPlacement);

  // À chaque changement de mission
  document.addEventListener("change", function (e) {
    if (e.target && e.target.id === "missionType") {
      toggleBlocPlacement();
      if (typeof updateAllCalculations === "function") updateAllCalculations();
    }
  });
})();

function buildMaterielTableHTML(lines) {
  if (!lines || !lines.length) return "";

  const totalMat = lines.reduce((s, l) => s + (l.total || 0), 0);

  return (
    '<h3>Détail matériel</h3>' +
    '<table>' +
      '<tr>' +
        '<th>Désignation</th>' +
        '<th style="text-align:right;">Qté</th>' +
        '<th style="text-align:right;">PU TTC</th>' +
        '<th style="text-align:right;">Total TTC</th>' +
      '</tr>' +
      lines.map(l =>
        '<tr>' +
          '<td>' + (l.desc || "") + '</td>' +
          '<td style="text-align:right;">' + (l.qte || 0) + '</td>' +
          '<td style="text-align:right;">' + fmt(l.pu || 0) + '</td>' +
          '<td style="text-align:right;">' + fmt(l.total || 0) + '</td>' +
        '</tr>'
      ).join("") +
      '<tr style="font-weight:bold;background:#f7f7f7;">' +
        '<td colspan="3" style="text-align:right;">Total matériel</td>' +
        '<td style="text-align:right;">' + fmt(totalMat) + '</td>' +
      '</tr>' +
    '</table>'
  );
}

/* ------------------------------------------------------------
   17. REMPLISSAGE DE LA FACE CLIENT
------------------------------------------------------------ */
function remplirFaceClient() {

  const typeDevis   = document.getElementById("typeDevis")?.value || "";
  const typeMission = document.getElementById("missionType")?.value || "";

  const titleEl = document.getElementById("clientTitle");
  if (titleEl) {
    if (typeDevis === "quantitatif") {
      titleEl.textContent = "DEVIS DIGITAL QEMWORK QUANTITATIF";
    } else if (typeDevis === "estimatif") {
      titleEl.textContent = "DEVIS DIGITAL QEMWORK ESTIMATIF";
    } else {
      // valeur par défaut si autre chose / vide
      titleEl.textContent = "DEVIS DIGITAL QEMWORK";
    }
  }
  // 17.1 – Meta devis
  const devisNum = fc("devisNum");
  const refMission = fc("refMission");
  const dateEtab = fc("dateEtab");
  const validite = fc("validiteLabel");

  document.getElementById("clientDevisMetaInfos").innerHTML = `
    <div>N° : <strong>${devisNum}</strong></div>
    <div>Mission : <strong>${refMission}</strong></div>
    <div>Date : <strong>${dateEtab}</strong></div>
    <div>Validité : <strong>${validite}</strong></div>
  `;

  // 17.2 – Coordonnées technicien (prestataire)
  const typeP = fc("prestataireType") === "entreprise" ? "Entreprise" : "Technicien indépendant";

  const telP =
    (fc("prestataireTelIndic") !== "autre" ? fc("prestataireTelIndic") : fc("prestataireTelIndicAutre"))
    + " " + fc("prestataireTel");

  const villeP = fc("prestataireVille") === "autre"
    ? fc("prestataireVilleAutre")
    : fc("prestataireVille");

  document.getElementById("clientFaceTechNom").textContent = fc("prestataireNom");
  document.getElementById("clientFaceTechType").textContent = typeP;
  document.getElementById("clientFaceTechVille").textContent = "Ville : " + villeP;
  document.getElementById("clientFaceTechRccm").textContent = fc("prestataireRCCM") ? ("RCCM : " + fc("prestataireRCCM")) : "";
  document.getElementById("clientFaceTechNui").textContent = fc("prestataireNUI") ? ("NUI : " + fc("prestataireNUI")) : "";

  // 17.3 – Coordonnées client
  const telC =
    (fc("clientTelIndic") !== "autre" ? fc("clientTelIndic") : fc("clientTelIndicAutre"))
    + " " + fc("clientTel");

  document.getElementById("clientFaceNom").textContent = fc("clientNom");
  document.getElementById("clientFaceType").textContent = fc("clientType") === "entreprise" ? "Entreprise" : "Particulier";
  document.getElementById("clientFaceRccm").textContent = fc("clientRCCM") ? ("RCCM : " + fc("clientRCCM")) : "";
  document.getElementById("clientFaceNui").textContent = fc("clientNUI") ? ("NUI : " + fc("clientNUI")) : "";
  document.getElementById("clientFaceRep").textContent = fc("clientRep") ? ("Représentant : " + fc("clientRep")) : "";
  document.getElementById("clientFaceTel").textContent = "Tél : " + telC;
  document.getElementById("clientFaceMail").textContent = fc("clientMail");

  // 17.4 – Mission + chantier
  const villeC = fc("clientVille") === "autre" ? fc("clientVilleAutre") : fc("clientVille");
  const quartier = fc("clientQuartierInput");
  const corpsMetier = fc("corpsMetierInput");
  const typeInterv = fc("typeInterventionInput");
  const description = fc("description");

  document.getElementById("clientMissionResume").innerHTML = `
    <strong>Adresse :</strong> ${fc("clientAdresse")}<br>
    <strong>Ville :</strong> ${villeC}<br>
    <strong>Quartier :</strong> ${quartier}<br><br>

    <strong>Corps de métier :</strong> ${corpsMetier}<br>
    <strong>Intervention :</strong> ${typeInterv}<br><br>

    <strong>Description :</strong><br>${description.replace(/\n/g, "<br>")}
  `;

  // 17.5 – Récap phases
  const recap = genererRecapParPhase();
  document.getElementById("clientDetailParPhase").innerHTML = recap.html;

  // 17.6 – Total TTC global
  document.getElementById("clientTotalBloc").textContent =
    "TOTAL TTC À PAYER : " + recap.totalGlobalFmt;

  // 17.7 – Coût M.O résumé
  //document.getElementById("clientCoutMdo").innerHTML =
    //"<strong>Main d’œuvre totale :</strong> " + fmt(recap.totalMO);
  
 // 17.8 – Header client (côté gauche barre) : on le désactive pour éviter le doublon
const header = document.getElementById("clientHeaderInfos");
if (header) header.innerHTML = ""; 
}

/* Bouton "Générer la face client" (interne → client) */
document.getElementById("btnGenererClient").addEventListener("click", () => {
  remplirFaceClient();

  // message UI existant
  alert("Face client mise à jour avec succès !");
  document.querySelector('.tab[data-tab="client"]').click();

  // --- déclenchement stockage + email (interne) ---
  try {
    const refMission = (document.getElementById("refMission")?.value || "").trim();
    if (!refMission) return alert("Référence mission manquante: impossible de stocker/envoyer.");

    // 1) Récap
    const recapText = (buildWhatsappRecapFull() || "").replace(/\*/g, "");

    // 2) Devis HTML (export autoportant)
    const devisHtml = generateClientExportHTML();

    // 3) Devis PDF HTML (sans CGV/validation) -> doit exister chez toi
    const devisPdfHtml = buildClientPDFHTML_NoCGV_NoValidation();

    // 4) Factures: TOTAL + phases
    const phases = getPhases();
    const invoices = [];

    let total = 0;
    phases.forEach(p => total += getPhaseTotal(p));
    invoices.push({ label: "TOTAL", htmlBase64: b64utf8(buildInvoiceHTML("TOTAL", total)) });

    phases.forEach(p => {
      const amt = getPhaseTotal(p);
      if (amt > 0) invoices.push({ label: p, htmlBase64: b64utf8(buildInvoiceHTML(p, amt)) });
    });

    const payload = {
      action: "interneGenerateFaceClient",
      devisNum: (document.getElementById("devisNum")?.value || ""),
      refMission,
      clientNom: (document.getElementById("clientNom")?.value || ""),
      clientMail: (document.getElementById("clientMail")?.value || ""),
      typeDevis: (document.getElementById("typeDevis")?.value || ""),
      typeMission: (document.getElementById("missionType")?.value || ""),
      recapText,

      devisHtml: { filename: buildDevisFilename("html"), base64: b64utf8(devisHtml) },
      devisPdfHtml: { filename: buildDevisFilename("pdf"), base64: b64utf8(devisPdfHtml) },

      invoices
    };

    postPayloadByForm(payload, (json, rawTxt) => {
      if (json && json.success) {
        alert("Email envoyé + documents stockés dans Drive.\nDossier: " + (json.folderUrl || ""));
      } else {
        alert("Face client OK, mais envoi/stockage a échoué.\n" + ((json && json.error) ? json.error : rawTxt));
      }
    });

  } catch (e) {
    console.error(e);
    alert("Face client OK, mais erreur envoi/stockage: " + (e.message || e));
  }
});

/* ------------------------------------------------------------
   18. FACTURATION SIMPLE (PAR PHASE OU TOTALE)
------------------------------------------------------------ */

/* Récupération données facture */
function getInvoiceData() {
  return {
    devis: getVal("devisNum"),
    mission: getVal("refMission"),
    date: new Date().toLocaleDateString("fr-FR"),

    client: {
      nom: getVal("clientNom"),
      type: getVal("clientType") === "entreprise" ? "Entreprise" : "Particulier",
      tel: ((getVal("clientTelIndic") === "autre" ? getVal("clientTelIndicAutre") : getVal("clientTelIndic"))
           + " " + getVal("clientTel")),
      mail: getVal("clientMail")
    },

    prestataire: {
      nom: getVal("prestataireNom"),
      type: getVal("prestataireType") === "entreprise" ? "Entreprise" : "Technicien individuel",
      ville: getVal("prestataireVille") === "autre"
             ? getVal("prestataireVilleAutre")
             : getVal("prestataireVille")
    }
  };
}

/* HTML facture */
function buildInvoiceHTML(phase, amount) {
  const d = getInvoiceData();
  const isTotal = (phase === "TOTAL");

  // Résumé mission (mêmes champs que remplirFaceClient)
  const corpsMetier = getVal("corpsMetierInput") || "";
  const typeInterv  = getVal("typeInterventionInput") || "";
  const description = (getVal("description") || "").replace(/\n/g, "<br>");

  // Coordonnées QemWork (fixes)
  const qwBloc =
    '<h3>QemWork – Digital Factory SARL</h3>' +
    '<p>' +
    'Dépôt de Sable – Etoudi, Yaoundé – Cameroun<br>' +
    'RCCM : CM-NSI-01-2025-B12-01096 <br>' +
    'NUI : M062527815914U<br>' +
    'Tél. : +237 676 59 17 25<br>' +
    'Email : support@qemwork.com<br>' +
    'Site : https://www.qemwork.com' +
    '</p>';

  // Récap global (même HTML que la face client) pour la facture TOTALE
  const recapGlobal = genererRecapParPhase();
  const recapGlobalHTML = recapGlobal.html || "";

  // Données détaillées pour la phase (ou global selon mode)
  const recapPhase = getPhaseRecapData(phase);
  const matPhaseLines = getLinesMateriel().filter(l => l.phase === phase && (l.qte || l.pu || l.total));
  const matTableHTML  = buildMaterielTableHTML(matPhaseLines);

  let montantFacture = amount; // fallback

if (phase === "TOTAL") {
  // total client TTC global (si dispo)
  montantFacture = recapPhase.totalFacture || (computeCommissions()?.totalClientTTC || amount);
} else if (recapPhase.phase?.totalPhaseClient != null) {
  // total TTC client pour la phase
  montantFacture = recapPhase.phase.totalPhaseClient;
} else if (recapPhase.isPlacement && recapPhase.totalFacture != null) {
  montantFacture = recapPhase.totalFacture;
}

  // Construction du bloc "tableau financier" selon le cas
  let financeBlock = "";

  // 1) Facture TOTALE : récap global complet
  if (isTotal) {
    financeBlock =
      '<h3>Récapitulatif financier détaillé</h3>' +
      recapGlobalHTML +
      '<p style="font-size:0.8rem;color:#555;margin-top:8px;">' +
      'Ce tableau reprend le détail des montants tels que présentés sur le devis QemWork ' +
      '(phases, main d’œuvre, matériel, frais QemWork…).' +
      '</p>';
  }
  // 2) PLACEMENT
  else if (recapPhase.isPlacement) {
    const lines = recapPhase.placementLines || [];
    financeBlock =
      '<h3>Détail financier – Placement</h3>' +
      '<table>' +
      '<tr>' +
      '<th>Corps de métier</th>' +
      '<th>Ville technicien</th>' +
      '<th style="text-align:right;">Qté</th>' +
      '<th style="text-align:right;">Jours</th>' +
      '<th style="text-align:right;">Tarif jour TTC</th>' +
      '<th>Hébergement pris en charge</th>' +
      '<th style="text-align:right;">Distance (km)</th>' +
      '<th style="text-align:right;">Frais hébergement TTC</th>' +
      '<th style="text-align:right;">Total ligne TTC</th>' +
      '</tr>' +
      lines.map(function (l) {
        return (
          '<tr>' +
          '<td>' + l.corps + '</td>' +
          '<td>' + l.villeTech + '</td>' +
          '<td style="text-align:right;">' + l.qte + '</td>' +
          '<td style="text-align:right;">' + l.jours + '</td>' +
          '<td style="text-align:right;">' + fmt(l.tarif) + '</td>' +
          '<td>' + (l.hebergPrise === "oui" ? "Oui" : "Non") + '</td>' +
          '<td style="text-align:right;">' + l.km + '</td>' +
          '<td style="text-align:right;">' + fmt(l.totalHeberg) + '</td>' +
          '<td style="text-align:right;">' + fmt(l.total) + '</td>' +
          '</tr>'
        );
      }).join("") +
      '</table>';
  }
  
 // 3) ESTIMATIF
else if (recapPhase.isEstimatif) {
  // Cas phase isolée : recapPhase.phase rempli
  if (recapPhase.phase) {
    const ph = recapPhase.phase;
    financeBlock =
      '<h3>Récapitulatif financier – ' + ph.name + ' (devis estimatif)</h3>' +
      '<table>' +
      '<tr>' +
      '<th>Phase</th>' +
      '<th>Libellé</th>' +
      '<th style="text-align:right;">Main d’œuvre (TTC)</th>' +
      '<th style="text-align:right;">Frais QemWork client (TTC)</th>' +
      '<th style="text-align:right;">Total phase TTC (client)</th>' +
      '</tr>' +
      '<tr>' +
      '<td><strong>' + ph.name + '</strong></td>' +
      '<td>' + (ph.desc || "") + '</td>' +
      '<td style="text-align:right;">' + fmt(ph.totalMOP || 0) + '</td>' +
      '<td style="text-align:right;">' + fmt(ph.fraisFront || 0) + '</td>' +
      '<td style="text-align:right;"><strong>' + fmt(ph.totalPhaseClient || 0) + '</strong></td>' +
      '</tr>' +
      '</table>' +
      '<div style="margin-top:6px;font-size:0.8rem;">' +
      '<strong>Récapitulatif des montants :</strong><br>' +
      '• Total main d\'œuvre TTC : ' + fmt(ph.totalMOP || 0) + '<br>' +
      '• Total frais QemWork (frais front client) TTC : ' + fmt(ph.fraisFront || 0) +
      '</div>';
  }
  // Cas global : TOTAL estimatif
  else {
    const totalMO_TTC  = recapPhase.totalMO_TTC || 0;
    const totalFraisQW = recapPhase.totalFraisQW || 0;
    financeBlock =
      '<h3>Récapitulatif financier – Devis estimatif (global)</h3>' +
      '<table>' +
      '<tr>' +
      '<th>Poste</th>' +
      '<th style="text-align:right;">Montant TTC</th>' +
      '</tr>' +
      '<tr>' +
      '<td>Main d’œuvre</td>' +
      '<td style="text-align:right;">' + fmt(totalMO_TTC) + '</td>' +
      '</tr>' +
      '<tr>' +
      '<td>Frais QemWork (frais front client)</td>' +
      '<td style="text-align:right;">' + fmt(totalFraisQW) + '</td>' +
      '</tr>' +
      '<tr style="background:#f5f9ff;font-weight:bold;">' +
      '<td>Total TTC (main d\'œuvre + frais QemWork)</td>' +
       '<td style="text-align:right;">' + fmt(totalMO_TTC + totalFraisQW) + '</td>' +
      '</tr>' +
      '</table>';
  }
}
  // 4) QUANTITATIF – Phase isolée
  else if (recapPhase.isQuantitatif && recapPhase.phase) {
    const ph = recapPhase.phase;
    financeBlock =
      '<h3>Récapitulatif financier – ' + ph.name + '</h3>' +
      '<table>' +
      '<tr>' +
      '<th>Phase</th>' +
      '<th>Libellé</th>' +
      '<th style="text-align:right;">Main d’œuvre (TTC)</th>' +
      '<th style="text-align:right;">Matériel (TTC)</th>' +
      '<th style="text-align:right;">Frais QemWork client (TTC)</th>' +
      '<th style="text-align:right;">Total phase TTC (client)</th>' +
      '</tr>' +
      '<tr>' +
      '<td><strong>' + ph.name + '</strong></td>' +
      '<td>' + ph.desc + '</td>' +
      '<td style="text-align:right;">' + fmt(ph.totalMOP) + '</td>' +
      '<td style="text-align:right;">' + fmt(ph.totalMatP) + '</td>' +
      '<td style="text-align:right;">' + fmt(ph.fraisFront) + '</td>' +
      '<td style="text-align:right;"><strong>' + fmt(ph.totalPhaseClient) + '</strong></td>' +
      '</tr>' +
      '</table>' +
      '<div style="margin-top:6px;font-size:0.8rem;">' +
      '<strong>Récapitulatif des montants :</strong><br>' +
      '• Total main d\'œuvre TTC : ' + fmt(ph.totalMOP) + '<br>' +
      '• Total matériel TTC : ' + fmt(ph.totalMatP) + '<br>' +
      '• Total frais QemWork (frais front client) TTC : ' + fmt(ph.fraisFront) +
      '</div>'+
      matTableHTML;
  }

  // Gabarit final de la facture
  const html =
    '<html>' +
    '<head>' +
    '<meta charset="UTF-8">' +
    '<title>FACTURE DIGITALE QEMWORK – ' + phase + '</title>' +
    '<style>' +
    'body { font-family: Arial, sans-serif; padding: 20px; font-size: 14px; }' +
    'h1 { text-align: center; margin-bottom: 20px; }' +
    'h3 { margin-top: 20px; }' +
    'table { width: 100%; border-collapse: collapse; margin-top: 10px; }' +
    'td, th { border: 1px solid #444; padding: 6px; }' +
    '.total { font-size: 1.2rem; font-weight: bold; }' +
    '.paid { font-size: 1.2rem; margin-top:20px; color: green; font-weight:bold; text-align:center; }' +
    '</style>' +
    '</head>' +
    '<body>' +

    '<h1>FACTURE DIGITALE QEMWORK – ' + phase + '</h1>' +

    // Bloc QemWork
    qwBloc +

    '<h3>Références</h3>' +
    '<p>' +
    'Devis : <strong>' + d.devis + '</strong><br>' +
    'Mission : <strong>' + d.mission + '</strong><br>' +
    'Date facture : <strong>' + d.date + '</strong>' +
    '</p>' +

    '<h3>Mission</h3>' +
    '<p>' +
    (corpsMetier ? ('<strong>Corps de métier :</strong> ' + corpsMetier + '<br>') : '') +
    (typeInterv ? ('<strong>Intervention :</strong> ' + typeInterv + '<br>') : '') +
    (description ? ('<strong>Description :</strong><br>' + description) : '') +
    '</p>' +

    '<h3>Client</h3>' +
    '<p>' +
    '<strong>' + d.client.nom + '</strong><br>' +
    d.client.type + '<br>' +
    d.client.tel + '<br>' +
    d.client.mail +
    '</p>' +

    '<h3>Prestataire (technicien)</h3>' +
    '<p>' +
    '<strong>' + d.prestataire.nom + '</strong><br>' +
    d.prestataire.type + '<br>' +
    'Ville : ' + d.prestataire.ville +
    '</p>' +

    '<h3>Montant total facturé</h3>' +
    '<p class="total">' + fmt(montantFacture) + '</p>' +

    financeBlock +

    '<p class="paid">FACTURE PAYÉE ✔</p>' +

    '</body>' +
    '</html>';

  return html;
}

//Nomination des export pdf facture 
function printInvoiceHTML(fullHtml, phaseLabel) {
  // Récup infos pour le nom
  const typeDevis = document.getElementById("typeDevis")?.value;
  let prefix = "facture_client_qemwork";

  if (typeDevis === "quantitatif") {
    prefix = "facture_client_quantitatif_qemwork";
  } else if (typeDevis === "estimatif") {
    prefix = "facture_client_estimatif_qemwork";
  }

  const clientNom = document.getElementById("clientNom")?.value || "client";
  const devisNum  = document.getElementById("devisNum")?.value || "";

  const safeClientNom = clientNom.trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_-]/g, "");
  const numDevis      = devisNum.trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_-]/g, "");
  const safePhase     = (phaseLabel || "TOTAL").toString().trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_-]/g, "");

  const filename = `${prefix}_N${numDevis}_${safeClientNom}_${safePhase}`;

  const w = window.open("", "_blank");
  if (!w) return;

  // On écrit la page complète telle que renvoyée par buildInvoiceHTML
  w.document.write(fullHtml);
  w.document.close();

  // On change le titre APRÈS avoir écrit le document
  w.addEventListener("load", () => {
    try {
      w.document.title = filename;
    } catch (e) {
      // au cas où, on ignore l'erreur
    }
    setTimeout(() => w.print(), 400);
  });
}
/* Impression PDF via iframe invisible */
function printHTML(htmlString) {

  const iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow.document;
  doc.open();
  doc.write(htmlString);
  doc.close();

  iframe.onload = () => {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
    setTimeout(() => iframe.remove(), 1500);
  };
}

/* Total TTC d’une phase (pour factures) */
function getPhaseTotal(phase) {

  const type = getVal("typeDevis");

  const mdoEstim = getLinesMDOEstim();
  const mdoQuant = getLinesMDOQuant();
  const mat = getLinesMateriel();

  let total = 0;

  if (type === "estimatif") {
    mdoEstim.filter(l => l.phase === phase).forEach(l => total += l.total);
  } else {
    mdoQuant.filter(l => l.phase === phase).forEach(l => total += l.total);
    mat.filter(l => l.phase === phase).forEach(l => total += l.total);
  }

  return total;
}
// Récupération des infos récap par phase (pour facture phase)
function getPhaseRecapData(phaseName) {
  const typeDevis   = document.getElementById("typeDevis").value;
  const typeMission = document.getElementById("missionType").value || "";
  const synth       = computeCommissions();
  const fraisFrontGlobal = synth.fraisFront_TTC || 0;

  // Cas placement : chaque "phase" n'existe pas, on renvoie juste la ligne globale de placement
  if (typeMission === "placement") {
    const linesPlacement = getLinesPlacement();
    let totalPlacement = 0;
    linesPlacement.forEach(l => totalPlacement += l.total);
    const totalFraisQW = fraisFrontGlobal;
    const totalFacture = synth.totalClientTTC || 0;

    return {
      isPlacement: true,
      placementLines: linesPlacement,
      totalPlacement,
      totalFraisQW,
      totalFacture
    };
  }


  // ESTIMATIF : détail par phase (M.O + frais QW, pas de matériel)
if (typeDevis === "estimatif") {
  const phases = Array.from(document.querySelectorAll("#tablePhases tbody tr")).map(tr => ({
    name: tr.querySelector(".phase-name")?.value || "",
    desc: tr.querySelector(".phase-desc")?.value || ""
  }));

  const mdoEstim = getLinesMDOEstim();
  const phaseTotals = [];

  phases.forEach(ph => {
    const phName = ph.name;
    let totalMOP = 0;

    mdoEstim.filter(l => l.phase === phName).forEach(l => totalMOP += l.total);

    phaseTotals.push({
      name: phName,
      desc: ph.desc || "",
      totalMOP
    });
  });

  const baseRepart = phaseTotals.reduce((acc, ph) => acc + ph.totalMOP, 0) || 1;
  phaseTotals.forEach(ph => {
    const ratio = ph.totalMOP / baseRepart;
    ph.fraisFront       = fraisFrontGlobal * ratio;
    ph.totalPhaseClient = ph.totalMOP + ph.fraisFront;
  });

  // Si on demande une phase précise
  if (phaseName && phaseName !== "TOTAL") {
    const phaseData = phaseTotals.find(p => p.name === phaseName) || null;
    return {
      isEstimatif: true,
      phase: phaseData
    };
  }

  // Si on facture le TOTAL estimatif (global)
  const totalMO_TTC  = phaseTotals.reduce((s, p) => s + p.totalMOP, 0);
  const totalFraisQW = phaseTotals.reduce((s, p) => s + p.fraisFront, 0);
  const totalFacture = totalMO_TTC + totalFraisQW;

  return {
    isEstimatif: true,
    totalMO_TTC,
    totalFraisQW,
    totalFacture,
    phaseTotals // utile si tu veux le détail plus tard
  };
}

  // QUANTITATIF : on recalcule la répartition par phase
  const phases = Array.from(document.querySelectorAll("#tablePhases tbody tr")).map(tr => ({
    name: tr.querySelector(".phase-name")?.value || "",
    desc: tr.querySelector(".phase-desc")?.value || ""
  }));

  const mdoQuant = getLinesMDOQuant();
  const mat      = getLinesMateriel();

  const phaseTotals = [];
  phases.forEach(ph => {
    const phName = ph.name;
    let totalMOP = 0;
    let totalMatP = 0;

    mdoQuant.filter(l => l.phase === phName).forEach(l => totalMOP += l.total);
    mat     .filter(l => l.phase === phName).forEach(l => totalMatP += l.total);

    const totalPhaseSansFrais = totalMOP + totalMatP;
    phaseTotals.push({
      name: phName,
      desc: ph.desc || "",
      totalMOP,
      totalMatP,
      totalPhaseSansFrais
    });
  });

  const baseRepart = phaseTotals.reduce((acc, ph) => acc + ph.totalPhaseSansFrais, 0) || 1;
  phaseTotals.forEach(ph => {
    const ratio = ph.totalPhaseSansFrais / baseRepart;
    ph.fraisFront = fraisFrontGlobal * ratio;
    ph.totalPhaseClient = ph.totalPhaseSansFrais + ph.fraisFront;
  });

  // On renvoie les données de la phase demandée
  const phaseData = phaseTotals.find(p => p.name === phaseName);
  return {
    isQuantitatif: true,
    phase: phaseData
  };
}

/* Facture pour une phase */
function generateInvoiceForPhase(phase) {
  const amount = getPhaseTotal(phase);

  if (amount <= 0) {
    alert("Aucun montant pour cette phase.");
    return;
  }

  const html = buildInvoiceHTML(phase, amount);
  printInvoiceHTML(html, phase);
}

/* Facture totale */
function generateInvoiceTotal() {

  const phases = getPhases();
  let total = 0;

  phases.forEach(p => total += getPhaseTotal(p));

  const html = buildInvoiceHTML("TOTAL", total);
  printInvoiceHTML(html, "TOTAL");
}

/* Menu dynamique des factures (par phase + totale) */
function openInvoiceMenu() {

  let menu = document.getElementById("invoiceMenu");
  if (menu) menu.remove();

  menu = document.createElement("div");
  menu.id = "invoiceMenu";
  menu.style.position = "absolute";
  menu.style.top = "40px";
  menu.style.right = "10px";
  menu.style.background = "#fff";
  menu.style.border = "1px solid #ccc";
  menu.style.padding = "0";
  menu.style.boxShadow = "0 3px 10px rgba(0,0,0,.15)";
  menu.style.zIndex = 9999;
  menu.style.borderRadius = "6px";
  menu.style.minWidth = "180px";
  menu.style.fontSize = "0.8rem";

  const phases = getPhases();

  phases.forEach(phase => {
    const btn = document.createElement("div");
    btn.textContent = "Facture – " + phase;
    btn.style.padding = "8px 12px";
    btn.style.cursor = "pointer";

    btn.onclick = () => {
      generateInvoiceForPhase(phase);
      menu.remove();
    };

    btn.onmouseenter = () => btn.style.background = "#eef5ff";
    btn.onmouseleave = () => btn.style.background = "#fff";

    menu.appendChild(btn);
  });

  // facture totale
  const total = document.createElement("div");
  total.textContent = "Facture totale (toutes phases)";
  total.style.padding = "8px 12px";
  total.style.cursor = "pointer";
  total.style.fontWeight = "bold";

  total.onclick = () => {
    generateInvoiceTotal();
    menu.remove();
  };

  total.onmouseenter = () => total.style.background = "#eef5ff";
  total.onmouseleave = () => total.style.background = "#fff";

  menu.appendChild(total);

  document.body.appendChild(menu);
}

/* Bouton Facture (face client) */
document.getElementById("btnClientInvoice").addEventListener("click", openInvoiceMenu);


/* ------------------------------------------------------------
   19. EXPORT PDF & HTML & PARTAGE FACE CLIENT
------------------------------------------------------------ */
/* 19.1 – PDF face client (nouvelle fenêtre, impression) avec pagination plus propre */
document.getElementById("btnClientPdf")?.addEventListener("click", () => {
  const panel = document.getElementById("panel-client");
  if (!panel) return alert("Erreur : panneau client introuvable.");

  // 1) Titre visible dans le PDF selon type de devis
  const typeDevis = document.getElementById("typeDevis")?.value;
  let titrePdf = "DEVIS DIGITAL QEMWORK";

  if (typeDevis === "quantitatif") {
    titrePdf = "DEVIS QUANTITATIF QEMWORK";
  } else if (typeDevis === "estimatif") {
    titrePdf = "DEVIS ESTIMATIF QEMWORK";
  }

  // 2) Nom de fichier harmonisé (comme HTML et factures)
  const filename = buildDevisFilename(); // sans extension, pour document.title

  const w = window.open("", "_blank");
  if (!w) return;

  const styleTag   = document.querySelector("style");
  const baseStyles = styleTag ? styleTag.innerHTML : "";

  w.document.write(`
    <html>
    <head>
      <meta charset="UTF-8">
      <title>${filename}</title>
      <style>
        * { box-sizing: border-box; }
        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          padding: 10px;
          background:#fff;
        }
        @page {
          margin: 12mm;
        }
        header, .top-title, .section, .client-validation, .two-cols {
          page-break-inside: avoid;
        }
        table {
          page-break-inside: avoid;
        }
        button {
          display:none !important;
        }
        .tabs-top {
          display:none !important;
        }
        .page {
          box-shadow:none;
          border-radius:0;
          margin:0;
        }
        ${baseStyles}
      </style>
    </head>
    <body>
      <div class="page">
        ${(function(){
  const clone = panel.cloneNode(true);

  // retirer CGV (id à adapter si nécessaire)
  // tu as un gros bloc CGV: donne-lui un id côté HTML : id="cgvBlock"
  clone.querySelector("#cgvBlock")?.remove();

  // retirer validation
  clone.querySelector(".client-validation")?.remove();

  // retirer boutons
  clone.querySelector("#btnClientInvoice")?.remove();
  clone.querySelector("#btnClientHtml")?.remove();
  clone.querySelector("#btnClientPdf")?.remove();
  clone.querySelector("#btnClientShare")?.remove();

  return clone.outerHTML;
})()}
      </div>
    </body>
    </html>
  `);
  w.document.close();

  // on s'assure que le titre est bien appliqué avant impression
  w.addEventListener("load", () => {
    try {
      w.document.title = filename;
    } catch (e) {}
    setTimeout(() => w.print(), 400);
  });
});

/* 19.2 – Récap WhatsApp complet (client + finances + phases) */
function buildWhatsappRecapFull() {
  try {
    let msg = "📄 *DEVIS QemWork — Récap complet*\n\n";

    const meta = document.getElementById("clientDevisMetaInfos");
    if (meta) msg += meta.innerText + "\n\n";

    const infos = document.getElementById("clientHeaderInfos");
    if (infos) msg += infos.innerText + "\n\n";

    const resume = document.getElementById("clientMissionResume");
    if (resume) msg += "📌 Mission :\n" + resume.innerText + "\n\n";

    const detail = document.getElementById("clientDetailParPhase");
    if (detail) msg += "🧱 Détail par phase :\n" + detail.innerText + "\n\n";

    const total = document.getElementById("clientTotalBloc");
    if (total) msg += "💰 Total :\n" + total.innerText + "\n\n";

    const com = document.getElementById("clientCommentaires");
    if (com?.value.trim() !== "") {
      msg += "✏ Commentaires :\n" + com.value.trim() + "\n\n";
    }

    return msg;
  } catch (e) {
    console.error(e);
    return null;
  }
}

/* 19.3 – Bouton Partager (WhatsApp) */
document.getElementById("btnClientShare")?.addEventListener("click", () => {
  const recap = buildWhatsappRecapFull();
  if (!recap) return alert("Erreur lors de la génération du récapitulatif.");

  const url = "https://wa.me/237676591725?text=" + encodeURIComponent(recap);
  window.open(url, "_blank");
});

/* 19.4 – Export HTML complet de la face client (avec script interne) */
const btnExportClient = document.getElementById("btnClientHtml");

if (btnExportClient) {
  btnExportClient.addEventListener("click", () => {
    const html = generateClientExportHTML();
    downloadExportClient(html);
  });
}

/* Génération HTML export client (autoportant) */
function generateClientExportHTML() {

  const panelClient = document.getElementById("panel-client");
  if (!panelClient) return "";

  const clone = panelClient.cloneNode(true);

  // On supprime les boutons dans la copie
  const invoiceBtn = clone.querySelector("#btnClientInvoice");
  if (invoiceBtn) invoiceBtn.remove();
  const htmlBtn = clone.querySelector("#btnClientHtml");
  if (htmlBtn) htmlBtn.remove();
  const pdfBtn = clone.querySelector("#btnClientPdf");
  if (pdfBtn) pdfBtn.remove();
  const shareBtn = clone.querySelector("#btnClientShare");
  if (shareBtn) shareBtn.remove();

  const styleTag = document.querySelector("style");
  const styles = styleTag ? styleTag.innerHTML : "";

  // Titre selon typeDevis
  const typeDevis = document.getElementById("typeDevis")?.value;
  let titreExport = "DEVIS DIGITAL QEMWORK ";
  if (typeDevis === "quantitatif") {
    titreExport = "DEVIS QUANTITATIF QEMWORK";
  } else if (typeDevis === "estimatif") {
    titreExport = "DEVIS ESTIMATIF QEMWORK";
  }

  return `
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>${titreExport}</title>
<style>${styles}</style>
</head>
<body>
<div class="page">
${clone.outerHTML}
</div>

<script>
// ======== Script interne à l'export (validation + WhatsApp) ==========

const DEVIS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzCqZsuCBwS-oNEUjbJ_YW-GK-QeB5nqF5bfyYOffFtthxm_c80D-LdaXITz9F5lIFV/exec";

function postPayloadByFormNewTab(payloadObj) {
  var form = document.createElement("form");
  form.method = "POST";
  form.action = DEVIS_WEBAPP_URL;
  form.target = "_blank";
  form.style.display = "none";

  var inp = document.createElement("input");
  inp.type = "hidden";
  inp.name = "payload";
  inp.value = JSON.stringify(payloadObj);

  form.appendChild(inp);
  document.body.appendChild(form);
  form.submit();
  setTimeout(function(){ form.remove(); }, 1200);
}

function checkClientValidationExport() {
  const lu = document.getElementById("clientLuApprouve");
  const decision = document.getElementById("clientDecision");
  const signataire = document.getElementById("clientSignataire");
  const dateVal = document.getElementById("clientValidationDate");

  if (!lu || !lu.checked) { alert("Veuillez cocher « Lu et approuvé »"); return false; }
  if (!decision || !decision.value) { alert("Veuillez sélectionner la décision"); return false; }
  if (!signataire || !signataire.value.trim()) { alert("Entrez le nom du signataire"); return false; }
  if (!dateVal || !dateVal.value) { alert("Entrez la date de validation"); return false; }

  return true;
}

function buildWhatsappRecapExport() {

  let txt = "DEVIS QemWork — Récapitulatif%0A%0A";

  const meta = document.getElementById("clientDevisMetaInfos");
  if (meta) txt += meta.innerText.replace(/\\n/g, "%0A") + "%0A%0A";

  const header = document.getElementById("clientHeaderInfos");
  if (header) txt += header.innerText.replace(/\\n/g, "%0A") + "%0A%0A";

  const mission = document.getElementById("clientMissionResume");
  if (mission) txt += "Mission :%0A" + mission.innerText.replace(/\\n/g, "%0A") + "%0A%0A";

  const phases = document.getElementById("clientDetailParPhase");
  if (phases) txt += "Détail par phase :%0A" + phases.innerText.replace(/\\n/g, "%0A") + "%0A%0A";

  const total = document.getElementById("clientTotalBloc");
  if (total) txt += total.innerText.replace(/\\n/g, "%0A") + "%0A%0A";

  const com = document.getElementById("clientCommentaires");
  if (com && com.value.trim() !== "") {
      txt += "Commentaires client :%0A" + com.value.trim().replace(/\\n/g, "%0A") + "%0A%0A";
  }

  return txt;
}

function handleClientValidationExport() {

  if (!checkClientValidationExport()) return;

  const recap = decodeURIComponent(buildWhatsappRecapExport());
  const decision = document.getElementById("clientDecision").value;
  const signataire = document.getElementById("clientSignataire").value;
  const dateVal = document.getElementById("clientValidationDate").value;

  // Récup du montant total indiqué sur le devis
  const totalBloc = document.getElementById("clientTotalBloc");
  let montantTexte = totalBloc ? totalBloc.innerText : "";
  let montant = (montantTexte.match(/([0-9\\s]+) FCFA/) || [])[1] || "";
  montant = montant.trim();

  // Nom prestataire
  var prestNomEl = document.getElementById("clientFaceTechNom");
  var prestNom = prestNomEl ? prestNomEl.innerText : "l'entreprise en charge de vos travaux";

  let extraPopup = "";

  // Déterminer si le bouton "Je valide" mentionne "paie" (devis quantitatif)
  const btn = document.getElementById("btnClientPay");
  let typeDevis = "estimatif";
  if (btn && btn.textContent.toLowerCase().includes("paie")) {
    typeDevis = "quantitatif";
  }

  if (decision === "refuse") {
    extraPopup =
      "Nous avons pris note de votre décision de ne pas poursuivre avec cette offre. " +
      "N'hésitez pas à nous recontacter pour toute autre demande ou à laisser un commentaire pour nous évaluer. " +
      "Votre équipe Qemwork !";
  } else {
    if (typeDevis === "estimatif") {
      extraPopup =
        "Nous avons pris note de votre confirmation, l'entreprise " + prestNom +
        " vous contactera dans les plus brefs délais afin de fixer un rdv pour une visite.";
    } else {
      extraPopup =
        "Nous avons pris acte de votre confirmation, veuillez procéder au paiement du " +
        (montant || "montant indiqué sur le devis") + " FCFA" + 
        " afin que nous puissions procéder à la planification de vos travaux.";
    }
  }

  // IMPORTANT: construire extra AVANT l'envoi email
  const extra =
      "\\n--- Validation ---\\n" +
      "Décision : " + (decision === "accepte" ? "Devis accepté" : "Devis refusé") + "\\n" +
      "Signataire : " + signataire + "\\n" +
      "Date : " + dateVal + "\\n";

  // Envoi des données de validation par formulaire POST vers Google Apps Script
  try {
    var meta = document.getElementById("clientDevisMetaInfos");
    var refMission = "";
    if (meta && meta.innerText) {
      var m = meta.innerText.match(/Mission\\s*:\\s*(.*)/i);
      if (m && m[1]) refMission = m[1].trim();
    }

    postPayloadByFormNewTab({
      action: "clientValidationEmail",
      refMission: refMission || "MISSION_SANS_REF",
      recapText: recap + extra,
      validation: { decision: decision, signataire: signataire, dateVal: dateVal }
    });
  } catch(e) {
    // Optionnel: pour debug, décommente
    // alert("Erreur envoi email: " + e);
  }

  const fullMsg = recap + extra;
  const url = "https://wa.me/237676591725?text=" + encodeURIComponent(fullMsg);
  window.open(url, "_blank");

  alert(extraPopup || "Validation enregistrée.");
}
window.addEventListener("load", () => {
  const btn = document.getElementById("btnClientPay");
  if (btn) btn.addEventListener("click", handleClientValidationExport);
});
<\/script>
</body>
</html>
`;
}

/* Téléchargement du fichier exporté */
function downloadExportClient(html) {
  const blob = new Blob([html], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = buildDevisFilename("html"); // <-- nouveau nom
  a.click();
  URL.revokeObjectURL(url);
}


/* ------------------------------------------------------------
   20. VALIDATION CLIENT (Je valide) – INTERNE
------------------------------------------------------------ */

/* 20.1 – Vérification des champs obligatoires */
function checkClientValidationFields() {
  const lu = document.getElementById("clientLuApprouve").checked;
  const decision = document.getElementById("clientDecision").value;
  const signataire = document.getElementById("clientSignataire").value.trim();
  const date = document.getElementById("clientValidationDate").value;

  if (!lu) {
    alert("Vous devez cocher « Lu et approuvé » pour valider le devis.");
    return false;
  }
  if (!decision) {
    alert("Veuillez indiquer la décision du client (accepté / refusé).");
    return false;
  }
  if (!signataire) {
    alert("Le nom du signataire est obligatoire.");
    return false;
  }
  if (!date) {
    alert("La date de validation est obligatoire.");
    return false;
  }

  return true;
}



/* 20.3 – Synchronisation interne après validation */
function finalizeClientValidationSync() {

  const accepted = document.getElementById("clientDecision")?.value === "accepte";
  const date = document.getElementById("clientValidationDate")?.value || "";
  const signataire = document.getElementById("clientSignataire")?.value || "";

  const meta = document.getElementById("interneDevisMeta");
  if (meta) {
    meta.querySelector(".valid-sync")?.remove();

    meta.innerHTML += `
      <div class="valid-sync" style="margin-top:4px;font-weight:700;color:${accepted ? "green" : "red"}">
        ${accepted ? "✔ Devis accepté par le client" : "✖ Devis refusé par le client"}
        — ${signataire} (${date})
      </div>
    `;
  }

  document.querySelector('.tab[data-tab="interne"]')?.click();
}

/* 20.4 – Libellé dynamique du bouton "Je valide" */
function refreshValidationButtonLabel() {
  const btn = document.getElementById("btnClientPay");
  const typeDevisEl = document.getElementById("typeDevis");
  if (!btn || !typeDevisEl) return;

  const val = typeDevisEl.value;
  if (val === "estimatif") {
    btn.textContent = "Je valide (pas de paiement requis)";
  } else if (val === "quantitatif") {
    btn.textContent = "Je valide (paiement requis)";
  } else {
    btn.textContent = "Je valide";
  }
}
function refreshDevisTitle() {
  const typeDevis = document.getElementById("typeDevis")?.value;
  const titleEl = document.querySelector("#panel-client .top-title h1");
  if (!titleEl) return;

  if (typeDevis === "quantitatif") {
    titleEl.textContent = "DEVIS QUANTITATIF QEMWORK";
  } else if (typeDevis === "estimatif") {
    titleEl.textContent = "DEVIS ESTIMATIF QEMWORK";
  } else {
    titleEl.textContent = "DEVIS DIGITAL QEMWORK";
  }
}

/* 20.5 – Handler principal du bouton JE VALIDE (interne + WhatsApp) */
/* 20.5 – Handler principal du bouton JE VALIDE (interne + WhatsApp) */
const btnValidate = document.getElementById("btnClientPay");
if (btnValidate) {
  btnValidate.addEventListener("click", function () {
    if (!checkClientValidationFields()) return;

    const typeDevis = document.getElementById("typeDevis")?.value;
    const recap = buildWhatsappRecapFull();
    const url = "https://wa.me/237676591725?text=" + encodeURIComponent(recap || "");

    // Message (plus de paiement simulé)
    if (typeDevis === "estimatif") {
      alert("Validation enregistrée (devis estimatif).");
    } else if (typeDevis === "quantitatif") {
      alert("Validation enregistrée (devis quantitatif).");
    } else {
      alert("Validation enregistrée.");
    }

    finalizeClientValidationSync();
    if (recap) window.open(url, "_blank");
  });
}

const DEVIS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzCqZsuCBwS-oNEUjbJ_YW-GK-QeB5nqF5bfyYOffFtthxm_c80D-LdaXITz9F5lIFV/exec";
function buildClientPDFHTML_NoCGV_NoValidation() {
  const panel = document.getElementById("panel-client");
  if (!panel) return "";

  const clone = panel.cloneNode(true);

  // Retirer CGV + validation
  clone.querySelector("#cgvBlock")?.remove();
  clone.querySelector(".client-validation")?.remove();

  // Retirer les boutons de la copie
  clone.querySelector("#btnClientInvoice")?.remove();
  clone.querySelector("#btnClientHtml")?.remove();
  clone.querySelector("#btnClientPdf")?.remove();
  clone.querySelector("#btnClientShare")?.remove();
  clone.querySelector("#btnClientConfirm")?.remove();

  // Styles existants
  const styleTag = document.querySelector("style");
  const baseStyles = styleTag ? styleTag.innerHTML : "";

  const filename = buildDevisFilename(); // sans extension

  return `
  <html>
    <head>
      <meta charset="UTF-8">
      <title>${filename}</title>
      <style>
        * { box-sizing: border-box; }
        body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          margin: 0;
          padding: 10px;
          background: #fff;
        }
        @page { margin: 12mm; }
        button, .tabs-top { display: none !important; }
        .page { box-shadow: none; border-radius: 0; margin: 0; }
        ${baseStyles}
      </style>
    </head>
    <body>
      <div class="page">${clone.outerHTML}</div>
    </body>
  </html>`;
}
/* Fin PHASE 4/4 */
</script>
</body>
</html>