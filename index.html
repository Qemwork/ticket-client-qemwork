<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QemWork - Demande d'intervention</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; padding:20px; margin:0; }
    .container { max-width:900px; margin:auto; background:white; padding:25px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
    h1, h2, h3, h4 { color:#1a1a1a; margin-bottom:6px; }
    .section-desc { color:#555; font-size:14px; margin:-6px 0 15px; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; margin-bottom:15px; border:1px solid #ccc; border-radius:8px; background:#fafafa; box-sizing:border-box; }
    textarea { min-height:120px; }
    button { width:100%; padding:15px; background:#25D366; border:none; border-radius:10px; font-size:18px; color:white; font-weight:bold; cursor:pointer; }
    button:hover { background:#1ebe5d; }
    button:disabled { background:#9adfb6; cursor:not-allowed; }

    .addMetierBtn { background:#007bff; margin-bottom:20px; }
    .removeMetierBtn { background:#dc3545; padding:8px; font-size:14px; margin-top:-5px; margin-bottom:10px; }
    .metierBlock { border:1px solid #ddd; background:#fafafa; padding:15px; border-radius:10px; margin-bottom:20px; }

    .autocomplete-container { position: relative; width: 100%; }
    .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-radius: 8px; max-height: 180px; overflow-y: auto; z-index: 50; }
    .autocomplete-item { padding: 10px; cursor: pointer; }
    .autocomplete-item:hover { background: #f0f0f0; }

    #photoPreview { display:flex; gap:10px; flex-wrap:wrap; }
    #photoPreview img { width:100px; height:100px; object-fit:cover; border-radius:8px; border:1px solid #ddd; }

    .moExtras { margin-top:10px; padding:10px; border-radius:8px; background:#eef8ff; border:1px dashed #79a9ff; }
    .notice { background:#fff6e5; border:1px solid #ffd59a; padding:10px; border-radius:10px; margin:10px 0 15px; color:#5a3b00; font-size:13px; }

    .checkbox-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin: 8px 0 15px; }
    .cb-row{ display:flex; align-items:center; gap:8px; }
    .cb-row label{ margin:0; }

    .muted{color:#666;font-size:13px}
  </style>
</head>

<body>
  <div class="container">
    <div style="text-align:center;">
      <img src="https://www.qemwork.com/icons/logo-qemwork-new.png" style="max-width:220px;" alt="QemWork">
    </div>

    <h1>Bienvenue chez QemWork !</h1>
    <p class="muted">Envoi via POST (form) vers Apps Script, sans fetch.</p>

    <form id="qemForm"
          method="POST"
          action="https://script.google.com/macros/s/AKfycbyHfnqWTMTU2AHPTaOZRtEnFscg0ssIyJVN63wWQrua3UjGo0TBiMjioV_IZJXQNZBwuA/exec"
          target="hidden_iframe">
      <input type="hidden" id="payloadField" name="payload" value="">

      <h2>1. Coordonnées du client</h2>

      <select id="typeClient" required>
        <option value="">Êtes-vous un client privé ou une entreprise ?</option>
        <option value="prive">Client privé</option>
        <option value="entreprise">Entreprise</option>
      </select>

      <div id="clientPrive" style="display:none;">
        <input id="nomPrive" placeholder="Nom du client *">
        <input id="telephonePrive" placeholder="Téléphone *">
        <input id="emailPrive" placeholder="E-mail" type="email">
      </div>

      <div id="clientEntreprise" style="display:none;">
        <input id="nomEntreprise" placeholder="Nom de l'entreprise *">
        <input id="nui" placeholder="Numéro de NUI">
        <input id="rccm" placeholder="Numéro de RCCM">
        <input id="siege" placeholder="Adresse du siège social">
        <input id="telephoneEntreprise" placeholder="Téléphone de l'entreprise *">
        <input id="emailEntreprise" placeholder="E-mail professionnel" type="email">
      </div>

      <h2>2. Coordonnées du chantier</h2>
      <p class="section-desc">Indiquez où se situe exactement le chantier.</p>

      <select id="ville">
        <option value="">Sélectionner la ville...</option>
        <option value="Yaoundé">Yaoundé</option>
        <option value="Douala">Douala</option>
        <option value="Autre">Autre</option>
      </select>

      <input id="villeAutre" placeholder="Précisez la ville" style="display:none;">

      <div class="autocomplete-container">
        <input id="quartier" placeholder="Quartier" autocomplete="off">
        <div id="quartierResults" class="autocomplete-results" style="display:none;"></div>
      </div>

      <input id="lieudit" placeholder="Lieu dit (optionnel)">

      <h2>3. Type d’intervention</h2>
      <p class="section-desc">Sélectionnez la nature de votre demande.</p>

      <select id="intervention">
        <option value="">Sélectionner...</option>
        <option>Mission urgence</option>
        <option>Mission classique</option>
        <option>Demande de main d'œuvre</option>
        <option>Projet de construction complète</option>
        <option>Projet de rénovation</option>
      </select>

      <div id="sectionProjet" style="display:none;">
        <h2>3B. Questionnaire projet</h2>
        <p class="section-desc">Merci de compléter ces informations pour permettre une première estimation.</p>
        <div id="projetContainer"></div>
      </div>

      <h2>4. Corps de métier</h2>
      <p class="section-desc">Vous pouvez ajouter plusieurs métiers si nécessaire.</p>

      <div id="metiersContainer"></div>
      <button type="button" class="addMetierBtn" id="btnAddMetier">Ajouter un corps de métier</button>

      <h2>5. Informations complémentaires</h2>
      <textarea id="description" placeholder="Renseignez vos informations ici..."></textarea>

      <h2>6. Photos du chantier (optionnel)</h2>
      <div class="notice">
        Limites : <b>2 photos max</b> par envoi. Si vous en choisissez plus, seules les 2 premières seront envoyées.
      </div>

      <input type="file" id="photos" accept="image/*" multiple>
      <div id="photoPreview"></div>

      <div id="sectionDisponibilites">
        <h2>7. Disponibilités</h2>
        <input type="datetime-local" id="c1">
        <input type="datetime-local" id="c2">
        <input type="datetime-local" id="c3">
      </div>

      <div id="sectionDateSouhaitee">
        <h2>8. Date souhaitée pour l’intervention</h2>
        <input type="date" id="dateSouhaitee">
      </div>

      <button type="button" id="submitBtn">Envoyer la demande</button>
      <div id="status" class="muted" style="margin-top:10px;"></div>
    </form>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
  </div>

<script>
/************************************************************
 * CONFIG
 ************************************************************/
const MAX_PHOTOS = 2;
const INTERVENTION_MO = "Demande de main d'œuvre";

/************************************************************
 * QUESTIONNAIRES PROJET (TES LISTES)
 ************************************************************/
const QUESTIONNAIRE_CONSTRUCTION = [
  { section:"PC. Nature du projet", question:"Type de projet ?", options:["Construction neuve","Extension / Surélévation","Projet clé en main"] },
  { section:"PC. Nature du projet", question:"Bâtiment concerné ?", options:["Maison individuelle","Immeuble d’habitation","Bâtiment commercial","Bureaux","Entrepôt / atelier"] },
  { section:"PC. Dimensions", question:"Surface totale approximative ?", options:["<50 m²","50–100 m²","100–200 m²","200–500 m²","500+ m²"] },
  { section:"PC. Dimensions", question:"Nombre de niveaux ?", options:["RDC seul","R+1","R+2","R+3 et +"] },
  { section:"PC. Lots", question:"Lots à construire ? (choix multiple)", type:"checkboxes", options:[
    "Études / conception","Terrassement","VRD / Raccordements","Fondations","Gros œuvre / Maçonnerie","Charpente",
    "Toiture / Couverture","Zinguerie","Étanchéité","Façade / Enduit","Isolation","Menuiseries extérieures (portes/fenêtres)",
    "Menuiseries intérieures","Plâtrerie / Cloisons / Faux plafond","Électricité","Plomberie / Sanitaires","Chauffage",
    "Climatisation / Ventilation (VMC)","Peinture","Revêtements murs (faïence, etc.)","Revêtements sols (carrelage/parquet)",
    "Cuisine","Salle de bain","Escalier / Garde-corps","Aménagements extérieurs (clôture, portail, terrasse)",
    "Nettoyage fin de chantier","Tout"
  ]},
  { section:"PC. Terrain", question:"Terrain disponible ?", options:["Oui","Non","En cours d’acquisition"] },
  { section:"PC. Terrain", question:"Étude de sol ?", options:["Oui – disponible","Non","À faire"] },
  { section:"PC. Plans", question:"Plans disponibles ?", options:["Oui – architecte","Oui – croquis","Non"] },
  { section:"PC. Administratif", question:"Permis de construire ?", options:["Oui obtenu","Oui en cours","Non","Non requis"] },
  { section:"PC. Phase à chiffrer", question:"Phase demandée ?", options:["Études / conception","Fondations","Gros œuvre","Second œuvre","Finitions","Projet complet"] },
  { section:"PC. Logistique", question:"Accès chantier ?", options:["Accès camion facile","Accès moyen","Accès difficile"] },
  { section:"PC. Logistique", question:"Eau & électricité disponibles ?", options:["Oui les deux","Eau seulement","Électricité seulement","Aucun"] },
  { section:"PC. Budget / Délais", question:"Budget estimatif ?", options:["<5 M","5–10 M","10–25 M","25–50 M","50 M+","À définir"] },
  { section:"PC. Budget / Délais", question:"Délai souhaité ?", options:["Urgent","1–3 mois","3–6 mois","6–12 mois","12 mois+"] }
];

const QUESTIONNAIRE_RENOVATION = [
  { section:"PR. Nature du projet", question:"Type de rénovation ?", options:["Rénovation complète","Rénovation partielle","Réhabilitation lourde"] },
  { section:"PR. Bâtiment", question:"Bâtiment concerné ?", options:["Maison","Appartement","Immeuble","Commerce / bureaux"] },
  { section:"PR. Âge / état", question:"Âge du bâtiment ?", options:["<10 ans","10–30 ans","30–50 ans","50+ ans","Inconnu"] },
  { section:"PR. Âge / état", question:"État général ?", options:["Bon","Moyen","Dégradé","Très dégradé"] },
  { section:"PR. Structure", question:"Structure touchée ?", options:["Non","Oui – murs porteurs","Oui – planchers","Oui – toiture","Inconnu"] },
  { section:"PR. Risques", question:"Présence amiante / plomb ?", options:["Oui","Non","Inconnu"] },
  { section:"PR. Occupation", question:"Bâtiment occupé pendant travaux ?", options:["Oui","Non","Partiellement"] },
  { section:"PR. Surfaces", question:"Surface concernée ?", options:["<50 m²","50–100 m²","100–200 m²","200+ m²"] },
  { section:"PR. Lots", question:"Lots à rénover ? (choix multiple)", type:"checkboxes", options:[
    "Gros œuvre","Plomberie","Électricité","Climatisation","Menuiseries","Peinture","Carrelage",
    "Toiture","Étanchéité","Voirie et Réseaux Divers / Extérieurs","Plâtrerie / Faux plafond",
    "Serrurerie","Cuisine","Salle de bain","Tout"
  ]},
  { section:"PR. Objectif", question:"Objectif principal ?", options:["Remise à neuf","Modernisation","Mise en conformité","Réparation dégâts (eau/feu)"] },
  { section:"PR. Logistique", question:"Accès chantier ?", options:["Accès camion facile","Accès moyen","Accès difficile"] },
  { section:"PR. Budget / Délais", question:"Budget estimatif ?", options:["<5 M","5–10 M","10–25 M","25–50 M","50 M+","À définir"] },
  { section:"PR. Budget / Délais", question:"Délai souhaité ?", options:["Urgent","1–3 mois","3–6 mois","3–6 mois","6–12 mois","12 mois+"] }
];

/************************************************************
 * BASE DE DONNÉES MÉTIERS (TES LISTES)
 ************************************************************/
const data = {
  Carreleur_Solier: [
    { section:"I. Type de surface", question:"Quel type de surface ?", options:["Sol intérieur","Mur","Terrasse"] },
    { section:"II. Type de travaux", question:"Quel type de pose ?", options:["Pose neuve","Dépose + repose","Réparation"] },
    { section:"III. Surface (m²)", question:"Surface à poser (m²) ?", options:["0–10","10–30","30–60","60+"] },
    { section:"IV. Support existant", question:"Type de support existant ?", options:["Béton","Ancien carrelage","Bois","Plancher"] }
  ],
  Charpentier_Couvreur: [
    { section:"I. Type de structure", question:"Type de structure ?", options:["Charpente bois","Charpente métallique","Ossature mixte"] },
    { section:"II. Type de couverture", question:"Type de couverture ?", options:["Tôle simple","Bac aluminium","Tôle isolée","Tuile locale","Membrane bitumeuse"] },
    { section:"III. Type d’intervention", question:"Nature de l’intervention ?", options:["Construction neuve","Réfection partielle","Réparation fuite","Réparation rouille","Étanchéité toiture-terrasse"] },
    { section:"IV. Superficie du toit", question:"Superficie du toit ?", options:["0–30","30–80","80–150","150+"] },
    { section:"V. Inclinaison", question:"Inclinaison ?", options:["Toit plat","Pente moyenne","Forte pente"] },
    { section:"VI. Accès toiture", question:"Accès à la toiture ?", options:["Facile (plain-pied)","Moyen (maison étage)","Difficile (hauteur >6m)"] }
  ],
  Chauffagiste: [
    { section:"I. Type d’équipement", question:"Quel équipement ?", options:["Chauffe-eau électrique","Chauffe-eau solaire","Chaudière gaz/fioul","Chauffe-eau instantané"] },
    { section:"II. Type d’intervention", question:"Quel type d’intervention ?", options:["Plus d’eau chaude","Réparation panne","Entretien / détartrage","Remplacement pièce","Remplacement complet","Installation neuve"] },
    { section:"III. Capacité / volume", question:"Capacité ?", options:["10–30 L","50–100 L","100–200 L","200+ L"] },
    { section:"IV. Localisation", question:"Localisation ?", options:["Salle de bain","Cuisine","Local technique","Extérieur"] },
    { section:"V. Alimentation disponible", question:"Source d’alimentation ?", options:["Électricité stable","Gaz","Solaire"] }
  ],
  Climaticien_Frigoriste: [
    { section:"I. Type de service", question:"Type de service ?", options:["Installation neuve","Entretien","Réparation","Remplacement"] },
    { section:"II. Système", question:"Type de système ?", options:["Split mural","Multi-split","Gainable","PAC","Chambre froide"] },
    { section:"III. Capacité", question:"Surface / capacité ?", options:["0–30 m²","30–60 m²","60–100 m²","100+ m²"] },
    { section:"IV. Symptômes", question:"Problème constaté ?", options:["Ne refroidit pas","Fuite","Bruit","Ne démarre pas","Entretien"] },
    { section:"V. Installation", question:"Accès installation ?", options:["Simple","Moyen","Difficile"] }
  ],
  Deboucheur: [
    { section:"I. Canalisation", question:"Quel type de canalisation ?", options:["Évier","Douche","WC","Égout"] },
    { section:"II. Intervention", question:"Type d’intervention ?", options:["Débouchage","Inspection caméra","Curage complet","Réparation"] },
    { section:"III. Longueur", question:"Longueur estimée ?", options:["<5 m","5–10 m","10–20 m","+20 m"] },
    { section:"IV. Accès", question:"Accès ?", options:["Facile","Moyen","Difficile"] }
  ],
  Désinsectiseur: [
    { section:"I. Intervention", question:"Type d’intervention ?", options:["Désinsectisation","Dératisation","Retrait amiante"] },
    { section:"II. Surface", question:"Surface ?", options:["0–50","50–100","100–200","200+"] },
    { section:"III. Site", question:"Type de site ?", options:["Logement","Local commercial","Chantier","Sous-sol","Combles"] },
    { section:"IV. Infestation", question:"Niveau ?", options:["Léger","Moyen","Fort"] },
    { section:"V. Fréquence", question:"Fréquence ?", options:["Unique","3 mois","Annuel"] }
  ],
  Électricien: [
    { section:"I. Type d’intervention", question:"Type d’intervention ?", options:["Nouvelle ligne","Éclairage","Prise/interrupteur","Panne électrique","Mise en conformité","Compteur prépayé"] },
    { section:"II. Localisation", question:"Localisation ?", options:["Salon/chambre","Cuisine","Salle de bain","Extérieur","Tableau principal"] },
    { section:"III. Courant", question:"Type de courant ?", options:["Monophasé","Triphasé","Solaire"] },
    { section:"IV. Équipement", question:"Équipement concerné ?", options:["Prise","Éclairage","Ventilateur","Clim","Tableau électrique","Pompe"] },
    { section:"V. Problème", question:"Problème constaté ?", options:["Disjonction","Court-circuit","Odeur de brûlé","Panne totale","Réfection complète"] },
    { section:"VI. Contexte", question:"Contexte ?", options:["Maison","Appartement","Commerce","Industriel"] }
  ],
  Enduiseur_Façadier: [
    { section:"I. Type", question:"Type d'enduit/revêtement ?", options:["Enduit neuf","Ravalement","Réparation fissures","ITE"] },
    { section:"II. Support", question:"Support ?", options:["Brique","Béton","Parpaing","Pierre"] },
    { section:"III. Finition", question:"Finition ?", options:["Grattée","Talochée","Lisse","Projetée"] },
    { section:"IV. Surface", question:"Surface ?", options:["0–50","50–100","100–200","200+"] },
    { section:"V. Hauteur", question:"Hauteur façade ?", options:["<3 m","3–6 m",">6 m"] },
    { section:"VI. Accès", question:"Accès chantier ?", options:["Rue directe","Cour","Échafaudage"] }
  ],
  Etancheur: [
    { section:"I. Surface", question:"Quelle surface ?", options:["Toiture terrasse","Mur enterré","Balcon/dalle","Réserve d’eau"] },
    { section:"II. Intervention", question:"Type d’intervention ?", options:["Neuf","Réfection","Réparation fuites","Diagnostic"] },
    { section:"III. Revêtement", question:"Type de revêtement ?", options:["Bitume","Résine","EPDM/PVC","Hydrofuge"] },
    { section:"IV. Surface totale", question:"Surface totale ?", options:["0–20","20–50","50–100","100+"] },
    { section:"V. Accès", question:"Accès chantier ?", options:["Facile","Moyen","Difficile"] },
    { section:"VI. Eau", question:"Présence d'eau ?", options:["Oui","Non","Occasionnelle"] }
  ],
  Jardinier_Paysagiste: [
    { section:"I. Prestation", question:"Type de prestation ?", options:["Entretien","Taille","Aménagement","Gazon"] },
    { section:"II. Surface", question:"Surface ?", options:["0–100","100–500","500–1000","1000+"] },
    { section:"III. Accès", question:"Accès ?", options:["Facile","Moyen","Difficile"] },
    { section:"IV. Équipements", question:"Éléments ?", options:["Gazon","Haies","Arbres","Massifs","Arrosage auto"] }
  ],
  Maçon: [
    { section:"I. Travail", question:"Type de structure ?", options:["Fondation","Mur porteur","Chape/dalle","Escalier","Rénovation"] },
    { section:"II. Bâtiment", question:"Type de bâtiment ?", options:["Maison simple","Immeuble R+1 à R+4","Commercial","Mur de clôture"] },
    { section:"III. Surface", question:"Surface ?", options:["0–20","20–50","50–100","100+"] },
    { section:"IV. Matériaux", question:"Matériaux ?", options:["Parpaings","Briques","Béton armé","Pierre"] },
    { section:"V. Sol", question:"Nature du sol ?", options:["Argileux","Sablonneux","Compact","Rocailleux","Humide"] },
    { section:"VI. Accès", question:"Accès chantier ?", options:["Camion","Allée","Brouette","Manuel"] }
  ],
  Peintre_Decorateur: [
    { section:"I. Surface", question:"Surface à peindre ?", options:["Murs","Plafonds","Menuiseries","Façade extérieure"] },
    { section:"II. Travaux", question:"Type de travaux ?", options:["Peinture neuve","Rénovation","Décoration"] },
    { section:"III. Surface m²", question:"Surface (m²)", options:["0–20","20–50","50–100","100+"] },
    { section:"IV. Support", question:"État du support ?", options:["Neuf","Ancien","Très abîmé"] },
    { section:"V. Finition", question:"Niveau de finition ?", options:["Standard","Haut de gamme"] }
  ],
  Plâtrier_Plaquiste: [
    { section:"I. Travaux", question:"Type de travaux ?", options:["Cloisons","Isolation","Plafond","Finition sèche"] },
    { section:"II. Surface", question:"Surface (m²) ?", options:["0–20","20–50","50–100","100+"] },
    { section:"III. Support", question:"Type de support ?", options:["Mur neuf","Mur ancien","Plafond","Combles"] },
    { section:"IV. Finition", question:"Niveau de finition ?", options:["Standard","Haut de gamme","Décorative"] },
    { section:"V. Accès", question:"Accès ?", options:["Libre","Hauteur >3m","Chantier occupé"] }
  ],
  Pisciniste: [
    { section:"I. Service", question:"Type de service ?", options:["Construction","Rénovation","Entretien","Dépannage"] },
    { section:"II. Type", question:"Type de piscine ?", options:["Béton","Coque","Hors-sol","Naturelle"] },
    { section:"III. Volume", question:"Volume (m³) ?", options:["<20","20–50","50–100","100+"] },
    { section:"IV. Traitement", question:"Traitement ?", options:["Chlore","Sel","UV","Ozone","Autre"] },
    { section:"V. Accès", question:"Accès ?", options:["Facile","Moyen","Difficile"] }
  ],
  Plombier: [
    { section:"I. Intervention", question:"Quel type d’intervention ?", options:["Fuite","WC bouché","Robinet/lavabo","Chauffe-eau","Pression faible","Salle de bain complète"] },
    { section:"II. Localisation", question:"Localisation ?", options:["Salle de bain","Cuisine","Mur/sol","Extérieur","Toiture/réservoir"] },
    { section:"III. Matériel", question:"Tuyauterie ?", options:["PVC","Cuivre","Galva","Multicouche","Inconnu"] },
    { section:"IV. Gravité", question:"Gravité ?", options:["Majeure","Faible pression","Bouchage","Eau stagnante","Mineur"] },
    { section:"V. Accès", question:"Accès ?", options:["Visible","Encastre","Réservoir","Pompe"] },
    { section:"VI. Environnement", question:"Lieu ?", options:["Appartement","Maison","Commerce","Collectif"] }
  ],
  Ramoneur: [
    { section:"I. Équipement", question:"Équipement ?", options:["Cheminée","Poêle","Chaudière","VMC"] },
    { section:"II. Entretien", question:"Dernier entretien ?", options:["<6 mois","6–12 mois",">1 an","Inconnu"] },
    { section:"III. Intervention", question:"Type ?", options:["Ramonage","Nettoyage","Bistre","Inspection caméra"] },
    { section:"IV. Accès", question:"Accès ?", options:["Facile","Moyen","Difficile"] },
    { section:"V. Conduits", question:"Nombre ?", options:["1","2–3","+3"] }
  ],
  Staffeur_Stucateur: [
    { section:"I. Travail", question:"Type de travail ?", options:["Moulures","Restauration","Décor mural","Sur mesure"] },
    { section:"II. Surface", question:"Surface/éléments ?", options:["1–5 m","5–20 m","20+ m","Surface >10 m²"] },
    { section:"III. Lieu", question:"Lieu ?", options:["Résidentiel","Patrimoine","Commerce","Institution"] },
    { section:"IV. Finition", question:"Finition ?", options:["Lisse","Patinée","Dorée"] },
    { section:"V. Accès", question:"Difficulté ?", options:["Facile","Moyen","Difficile"] }
  ],
  Technicien_Humidite: [
    { section:"I. Problème", question:"Type de problème ?", options:["Capillarité","Infiltration","Condensation","Ventilation"] },
    { section:"II. Localisation", question:"Où ?", options:["Sous-sol","Mur intérieur","Salle de bain","Combles"] },
    { section:"III. Surface", question:"Surface ?", options:["0–10","10–30","30–50","50+"] },
    { section:"IV. Traces", question:"Traces visibles ?", options:["Taches","Odeurs","Salpêtre","Structure abîmée"] },
    { section:"V. Bâtiment", question:"Type de bâtiment ?", options:["Maison","Appartement"] }
  ]
};

/************************************************************
 * QUARTIERS (COLLE TES LISTES COMPLÈTES ICI)
 ************************************************************/
const quartiersYaounde = [
  /* COLLE ICI TA LISTE COMPLÈTE YAOUNDÉ */
];
const quartiersDouala = [
  /* COLLE ICI TA LISTE COMPLÈTE DOUALA */
];

/************************************************************
 * DOM
 ************************************************************/
const typeClient = document.getElementById("typeClient");
const clientPrive = document.getElementById("clientPrive");
const clientEntreprise = document.getElementById("clientEntreprise");

const nomPrive = document.getElementById("nomPrive");
const telephonePrive = document.getElementById("telephonePrive");
const emailPrive = document.getElementById("emailPrive");

const nomEntrepriseEl = document.getElementById("nomEntreprise");
const nuiEl = document.getElementById("nui");
const rccmEl = document.getElementById("rccm");
const siegeEl = document.getElementById("siege");
const telephoneEntrepriseEl = document.getElementById("telephoneEntreprise");
const emailEntrepriseEl = document.getElementById("emailEntreprise");

const villeSelect = document.getElementById('ville');
const villeAutre = document.getElementById('villeAutre');
const quartierInput = document.getElementById('quartier');
const quartierResults = document.getElementById('quartierResults');
const lieudit = document.getElementById('lieudit');

const intervention = document.getElementById("intervention");
const sectionDisponibilites = document.getElementById("sectionDisponibilites");
const sectionDateSouhaitee = document.getElementById("sectionDateSouhaitee");
const c1 = document.getElementById("c1");
const c2 = document.getElementById("c2");
const c3 = document.getElementById("c3");
const dateSouhaitee = document.getElementById("dateSouhaitee");

const description = document.getElementById("description");
const photosInput = document.getElementById("photos");
const photoPreview = document.getElementById("photoPreview");

const submitBtn = document.getElementById("submitBtn");
const btnAddMetier = document.getElementById("btnAddMetier");

const sectionProjet = document.getElementById("sectionProjet");
const projetContainer = document.getElementById("projetContainer");
let projetReponses = {};

let quartiersActifs = [];
let compteurMetiers = 0;

const statusEl = document.getElementById("status");

/************************************************************
 * PRIVÉ / ENTREPRISE
 ************************************************************/
typeClient.addEventListener("change", () => {
  clientPrive.style.display = typeClient.value === "prive" ? "block" : "none";
  clientEntreprise.style.display = typeClient.value === "entreprise" ? "block" : "none";
  updateSubmitButtonLabel_();
});

/************************************************************
 * AUTOCOMPLETE QUARTIERS
 ************************************************************/
villeSelect.addEventListener('change', () => {
  villeAutre.style.display = (villeSelect.value === 'Autre') ? 'block' : 'none';

  quartiersActifs =
    villeSelect.value === "Yaoundé" ? quartiersYaounde :
    villeSelect.value === "Douala" ? quartiersDouala :
    [];

  quartierInput.value = "";
  quartierResults.innerHTML = "";
  quartierResults.style.display = "none";
  updateSubmitButtonLabel_();
});

quartierInput.addEventListener('input', () => {
  const term = quartierInput.value.toLowerCase();
  quartierResults.innerHTML = "";

  if (term.length === 0 || quartiersActifs.length === 0) {
    quartierResults.style.display = 'none';
    updateSubmitButtonLabel_();
    return;
  }

  const filtered = quartiersActifs.filter(q => q.toLowerCase().includes(term)).slice(0, 30);
  if (!filtered.length) {
    quartierResults.style.display = 'none';
    updateSubmitButtonLabel_();
    return;
  }

  filtered.forEach(q => {
    const div = document.createElement('div');
    div.className = 'autocomplete-item';
    div.textContent = q;
    div.onclick = () => {
      quartierInput.value = q;
      quartierResults.style.display = 'none';
      updateSubmitButtonLabel_();
    };
    quartierResults.appendChild(div);
  });

  quartierResults.style.display = 'block';
  updateSubmitButtonLabel_();
});

document.addEventListener('click', e => {
  if (!quartierResults.contains(e.target) && e.target !== quartierInput) {
    quartierResults.style.display = 'none';
  }
});

/************************************************************
 * PHOTOS (preview + limite)
 ************************************************************/
photosInput.addEventListener("change", () => {
  const files = Array.from(photosInput.files || []).slice(0, MAX_PHOTOS);

  if ((photosInput.files || []).length > MAX_PHOTOS) {
    alert(`Maximum ${MAX_PHOTOS} photos. Seules les ${MAX_PHOTOS} premières seront envoyées.`);
  }

  const dt = new DataTransfer();
  files.forEach(f => dt.items.add(f));
  photosInput.files = dt.files;

  photoPreview.innerHTML = "";
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement("img");
      img.src = e.target.result;
      photoPreview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

/************************************************************
 * PROJET: rendu dynamique
 ************************************************************/
function slug_(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/[’']/g, "")
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "");
}

function renderQuestionnaireProjet_(items, prefix) {
  projetContainer.innerHTML = "";
  projetReponses = {};

  items.forEach((item, idx) => {
    const qid = `${prefix}_${idx}_${slug_(item.question)}`;

    const h = document.createElement("h4");
    h.textContent = item.section;
    projetContainer.appendChild(h);

    const label = document.createElement("label");
    label.textContent = item.question;
    projetContainer.appendChild(label);

    if (item.type === "checkboxes") {
      const boxWrap = document.createElement("div");
      boxWrap.className = "checkbox-grid";

      item.options.forEach(opt => {
        const id = `${qid}_${slug_(opt)}`;

        const row = document.createElement("div");
        row.className = "cb-row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.dataset.qid = qid;
        cb.value = opt;

        cb.addEventListener("change", () => {
          if (opt === "Tout" && cb.checked) {
            document.querySelectorAll(`input[type="checkbox"][data-qid="${qid}"]`).forEach(x => {
              if (x.value !== "Tout") x.checked = false;
            });
            projetReponses[item.question] = ["Tout"];
          } else {
            const tout = document.getElementById(`${qid}_${slug_("Tout")}`);
            if (tout && tout.checked && opt !== "Tout") tout.checked = false;

            const selected = Array.from(document.querySelectorAll(`input[type="checkbox"][data-qid="${qid}"]:checked`))
              .map(x => x.value);

            projetReponses[item.question] = selected;
          }
          updateSubmitButtonLabel_();
        });

        const lb = document.createElement("label");
        lb.setAttribute("for", id);
        lb.textContent = opt;

        row.appendChild(cb);
        row.appendChild(lb);
        boxWrap.appendChild(row);
      });

      projetContainer.appendChild(boxWrap);
      projetReponses[item.question] = [];
    } else {
      const select = document.createElement("select");
      select.id = qid;
      select.innerHTML = `<option value="">Sélectionner...</option>`;

      (item.options || []).forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        select.appendChild(opt);
      });

      const optAutre = document.createElement("option");
      optAutre.value = "Autre";
      optAutre.textContent = "Autre";
      select.appendChild(optAutre);

      select.addEventListener("change", () => {
        projetReponses[item.question] = select.value;
        updateSubmitButtonLabel_();
      });

      projetContainer.appendChild(select);
      projetReponses[item.question] = "";
    }
  });
}

function clearProjet_() {
  projetContainer.innerHTML = "";
  projetReponses = {};
}

function majAffichageProjet_() {
  const v = intervention.value;

  if (v === "Projet de construction complète") {
    sectionProjet.style.display = "block";
    renderQuestionnaireProjet_(QUESTIONNAIRE_CONSTRUCTION, "PC");
  } else if (v === "Projet de rénovation") {
    sectionProjet.style.display = "block";
    renderQuestionnaireProjet_(QUESTIONNAIRE_RENOVATION, "PR");
  } else {
    sectionProjet.style.display = "none";
    clearProjet_();
  }
}

/************************************************************
 * MULTI-MÉTIERS
 ************************************************************/
function ajouterMetier() {
  compteurMetiers++;

  const block = document.createElement("div");
  block.className = "metierBlock";
  block.id = "metierBlock_" + compteurMetiers;

  block.innerHTML = `
    <h3>Métier #${compteurMetiers}</h3>

    <select class="metierSelect" data-id="${compteurMetiers}">
      <option value="">Sélectionner...</option>
      ${Object.keys(data).map(m => `<option value="${m}">${m}</option>`).join("")}
      <option value="Autre">Autre</option>
    </select>

    <div class="questionsTechniques" id="questions_${compteurMetiers}"></div>

    <textarea class="descMetier" id="descMetier_${compteurMetiers}" placeholder="Description spécifique du métier"></textarea>

    <div class="moExtras" id="mo_${compteurMetiers}" style="display:none;">
      <h4>Demande de main d'œuvre – Infos</h4>

      <label>Nombre de techniciens nécessaires</label>
      <input type="number" id="techniciens_${compteurMetiers}" min="1" placeholder="Ex : 3">

      <label>Forfait par jour (Main d'œuvre)</label>
      <input type="text" id="forfait_${compteurMetiers}" placeholder="Ex : 50 000 FCFA / jour">

      <label>Vous prenez en charge l'hébergement ?</label>
      <select id="hebergement_${compteurMetiers}">
        <option value="">Sélectionner...</option>
        <option value="Oui">Oui</option>
        <option value="Non">Non</option>
      </select>

      <label>Date début de prestation</label>
      <input type="date" id="debut_${compteurMetiers}">

      <label>Date fin de prestation</label>
      <input type="date" id="fin_${compteurMetiers}">
    </div>

    <button type="button" class="removeMetierBtn" onclick="supprimerMetier(${compteurMetiers})">
      Supprimer ce métier
    </button>
  `;

  document.getElementById("metiersContainer").appendChild(block);
  majAffichageMainOeuvre_();
  updateSubmitButtonLabel_();
}

function supprimerMetier(id) {
  const el = document.getElementById("metierBlock_" + id);
  if (el) el.remove();
  updateSubmitButtonLabel_();
}

document.addEventListener("change", function(e) {
  if (e.target.classList.contains("metierSelect")) {
    const id = e.target.dataset.id;
    const metier = e.target.value;
    const container = document.getElementById("questions_" + id);

    container.innerHTML = "";
    if (!metier || !data[metier]) { updateSubmitButtonLabel_(); return; }

    data[metier].forEach(item => {
      const h = document.createElement("h4");
      h.textContent = item.section;
      container.appendChild(h);

      const label = document.createElement("label");
      label.textContent = item.question;
      container.appendChild(label);

      const select = document.createElement("select");
      select.className = "questionSelect";
      select.dataset.metierId = id;
      select.dataset.question = item.question;
      select.innerHTML = `<option value="">Sélectionner...</option>`;

      item.options.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        select.appendChild(opt);
      });

      const optAutre = document.createElement("option");
      optAutre.value = "Autre";
      optAutre.textContent = "Autre";
      select.appendChild(optAutre);

      container.appendChild(select);
    });

    updateSubmitButtonLabel_();
  }
});

/************************************************************
 * LOGIQUE MO
 ************************************************************/
function majAffichageMainOeuvre_() {
  const isMO = (intervention.value === INTERVENTION_MO);

  sectionDisponibilites.style.display = isMO ? "none" : "block";
  sectionDateSouhaitee.style.display = isMO ? "none" : "block";

  document.querySelectorAll(".moExtras").forEach(div => {
    div.style.display = isMO ? "block" : "none";
  });
}

/************************************************************
 * COMPLETUDE (front)
 * - "coordonnées" = typeClient + nom + tel + description (point 5) uniquement
 * - "complet" = + intervention + chantier + (métier OU projet)
 ************************************************************/
function buildPayloadLight_() {
  return {
    typeClient: typeClient.value,
    nom: (typeClient.value === "prive") ? nomPrive.value : nomEntrepriseEl.value,
    telephone: (typeClient.value === "prive") ? telephonePrive.value : telephoneEntrepriseEl.value,
    email: (typeClient.value === "prive") ? emailPrive.value : emailEntrepriseEl.value,

    ville: (villeSelect.value === "Autre") ? villeAutre.value : villeSelect.value,
    quartier: quartierInput.value,
    intervention: intervention.value,
    description: description.value,

    metiers: Array.from(document.querySelectorAll(".metierBlock")).map(block => ({
      metier: block.querySelector(".metierSelect")?.value || ""
    })),
    projet: (intervention.value === "Projet de construction complète" || intervention.value === "Projet de rénovation")
      ? { type: intervention.value }
      : null
  };
}

function isCoordonneesOnlyFront_(p) {
  const hasClient =
    String(p.typeClient || "").trim() &&
    String(p.nom || "").trim() &&
    String(p.telephone || "").trim() &&
    String(p.description || "").trim();

  const nothingElse =
    !String(p.ville || "").trim() &&
    !String(p.quartier || "").trim() &&
    !String(p.intervention || "").trim() &&
    !(Array.isArray(p.metiers) && p.metiers.some(m => String(m?.metier || "").trim())) &&
    !p.projet;

  return !!(hasClient && nothingElse);
}

function isTicketCompleteFront_(p) {
  const hasClient =
    String(p.typeClient || "").trim() &&
    String(p.nom || "").trim() &&
    String(p.telephone || "").trim();

  const hasChantierEtType =
    String(p.ville || "").trim() &&
    String(p.quartier || "").trim() &&
    String(p.intervention || "").trim();

  const hasMetier = Array.isArray(p.metiers) && p.metiers.some(m => String(m?.metier || "").trim());
  const hasProjet = !!(p.projet && String(p.projet.type || "").trim());

  return !!(hasClient && hasChantierEtType && (hasMetier || hasProjet));
}

function updateSubmitButtonLabel_() {
  const p = buildPayloadLight_();
  if (isTicketCompleteFront_(p)) submitBtn.textContent = "Envoyer la demande";
  else if (isCoordonneesOnlyFront_(p)) submitBtn.textContent = "Enregistrer mes coordonnées";
  else submitBtn.textContent = "Enregistrer / Continuer";
}

/************************************************************
 * DEVICE ID
 ************************************************************/
function getDeviceId_() {
  const KEY = "qemwork_device_id";
  let id = localStorage.getItem(KEY);
  if (!id) {
    id = (crypto?.randomUUID?.() || ("dev_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
    localStorage.setItem(KEY, id);
  }
  return id;
}

/************************************************************
 * SUBMIT (POST iframe)
 ************************************************************/
let isSending = false;

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Impossible de lire le fichier."));
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

async function submitForm_() {
  if (isSending) return;
  isSending = true;
  submitBtn.disabled = true;
  statusEl.textContent = "Envoi en cours...";

  try {
    if (!typeClient.value) throw new Error("Veuillez sélectionner le type de client.");

    const nom = (typeClient.value === "prive") ? nomPrive.value : nomEntrepriseEl.value;
    const telephone = (typeClient.value === "prive") ? telephonePrive.value : telephoneEntrepriseEl.value;
    const email = (typeClient.value === "prive") ? emailPrive.value : emailEntrepriseEl.value;

    if (!String(nom || "").trim()) throw new Error("Veuillez renseigner le nom.");
    if (!String(telephone || "").trim()) throw new Error("Veuillez renseigner le téléphone.");

    const files = Array.from(photosInput.files || []).slice(0, MAX_PHOTOS);
    const photos = [];
    for (const file of files) {
      const dataUrl = await toBase64(file);
      photos.push({
        filename: file.name,
        mimeType: file.type || "image/jpeg",
        base64: String(dataUrl).split(",")[1] || ""
      });
    }

    const metiers = [];
    document.querySelectorAll(".metierBlock").forEach(block => {
      const id = block.id.split("_")[1];
      const metier = block.querySelector(".metierSelect")?.value || "";
      if (!metier) return;

      const descMetier = block.querySelector(".descMetier")?.value || "";

      const reponses = {};
      block.querySelectorAll(".questionSelect").forEach(sel => {
        reponses[sel.dataset.question] = sel.value;
      });

      metiers.push({
        metier,
        description: descMetier,
        questions: reponses,
        techniciens: document.getElementById(`techniciens_${id}`)?.value || "",
        forfait: document.getElementById(`forfait_${id}`)?.value || "",
        hebergement: document.getElementById(`hebergement_${id}`)?.value || "",
        debut: document.getElementById(`debut_${id}`)?.value || "",
        fin: document.getElementById(`fin_${id}`)?.value || ""
      });
    });

    const payload = {
      deviceId: getDeviceId_(),
      typeClient: typeClient.value,
      nom, telephone, email,

      nomEntreprise: typeClient.value === "entreprise" ? nomEntrepriseEl.value : "",
      nui: typeClient.value === "entreprise" ? nuiEl.value : "",
      rccm: typeClient.value === "entreprise" ? rccmEl.value : "",
      siege: typeClient.value === "entreprise" ? siegeEl.value : "",

      ville: (villeSelect.value === "Autre") ? villeAutre.value : villeSelect.value,
      quartier: quartierInput.value,
      lieudit: lieudit.value,

      intervention: intervention.value,

      projet: (intervention.value === "Projet de construction complète" || intervention.value === "Projet de rénovation")
        ? { type: intervention.value, reponses: projetReponses }
        : null,

      c1: c1.value,
      c2: c2.value,
      c3: c3.value,
      dateSouhaitee: dateSouhaitee.value,

      description: description.value,
      metiers,
      photos
    };

    document.getElementById("payloadField").value = JSON.stringify(payload);
    document.getElementById("qemForm").submit();

    statusEl.textContent = "Envoyé.";
  } catch (err) {
    statusEl.textContent = "Erreur: " + (err?.message || err);
  } finally {
    isSending = false;
    submitBtn.disabled = false;
    updateSubmitButtonLabel_();
  }
}

/************************************************************
 * INIT
 ************************************************************/
btnAddMetier.addEventListener("click", ajouterMetier);
intervention.addEventListener("change", () => {
  majAffichageProjet_();
  majAffichageMainOeuvre_();
  updateSubmitButtonLabel_();
});
submitBtn.addEventListener("click", submitForm_);

ajouterMetier();
updateSubmitButtonLabel_();
</script>
</body>
</html>

