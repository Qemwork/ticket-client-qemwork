<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QemWork - Demande d'intervention</title>

<style>
  body { font-family: Arial, sans-serif; background:#f4f6f9; padding:20px; margin:0; }
  .container {
    max-width:900px; margin:auto; background:white;
    padding:25px; border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
  }
  h1, h2, h3 { color:#1a1a1a; margin-bottom:6px; }
  .section-desc { color:#555; font-size:14px; margin:-6px 0 15px; }
  input, select, textarea {
    width:100%; padding:10px;
    margin-top:6px; margin-bottom:15px;
    border:1px solid #ccc; border-radius:8px; background:#fafafa;
  }
  textarea { min-height:120px; }
  button {
    width:100%; padding:15px; background:#25D366;
    border:none; border-radius:10px; font-size:18px;
    color:white; font-weight:bold; cursor:pointer;
  }
  button:hover { background:#1ebe5d; }
  button:disabled { background:#9adfb6; cursor:not-allowed; }
  .addMetierBtn { background:#007bff; margin-bottom:20px; }
  .removeMetierBtn { background:#dc3545; padding:8px; font-size:14px; margin-top:-5px; margin-bottom:10px; }
  .metierBlock { border:1px solid #ddd; background:#fafafa; padding:15px; border-radius:10px; margin-bottom:20px; }
  .hint { font-size:12px; color:#666; margin-top:-10px; margin-bottom:12px; }
  .notice { background:#fff6e5; border:1px solid #ffd59a; padding:10px; border-radius:10px; margin:10px 0 15px; color:#5a3b00; }

  /* AUTOCOMPLETE */
  .autocomplete-container { position: relative; width: 100%; }
  .autocomplete-results {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 1px solid #ccc; border-radius: 8px;
    max-height: 180px; overflow-y: auto; z-index: 50;
  }
  .autocomplete-item { padding: 10px; cursor: pointer; }
  .autocomplete-item:hover { background: #f0f0f0; }

  #photoPreview img {
    width:100px; height:100px; object-fit:cover; border-radius:8px; border:1px solid #ddd;
  }
  .moExtras {
    margin-top:10px; padding:10px; border-radius:8px;
    background:#eef8ff; border:1px dashed #79a9ff;
  }
</style>
</head>

<body>
<div class="container">
  <div style="text-align:center;">
    <img src="https://www.qemwork.com/icons/logo-qemwork-new.png" style="max-width:220px;" />
  </div>

  <h1>Bienvenue chez QemWork !</h1>
  <p>Ce formulaire nous permet de recueillir les informations n√©cessaires pour traiter votre demande.</p>

  <form id="qemForm">

    <h2>1. Coordonn√©es du client</h2>

    <select id="typeClient" required>
      <option value="">√ätes-vous un client priv√© ou une entreprise ?</option>
      <option value="prive">Client priv√©</option>
      <option value="entreprise">Entreprise</option>
    </select>

    <div id="clientPrive" style="display:none;">
      <input id="nomPrive" placeholder="Nom du client *" />
      <input id="telephonePrive" placeholder="T√©l√©phone * (ex: 6xxxxxxxx)" />
      <input id="emailPrive" placeholder="E-mail *" type="email" />
    </div>

    <div id="clientEntreprise" style="display:none;">
      <input id="nomEntreprise" placeholder="Nom de l'entreprise *" />
      <input id="nui" placeholder="Num√©ro de NUI *" />
      <input id="rccm" placeholder="Num√©ro de RCCM *" />
      <input id="siege" placeholder="Adresse du si√®ge social *" />
      <input id="telephoneEntreprise" placeholder="T√©l√©phone de l'entreprise * (ex: 6xxxxxxxx)" />
      <input id="emailEntreprise" placeholder="E-mail professionnel *" type="email" />
    </div>

    <h2>2. Coordonn√©es du chantier</h2>
    <p class="section-desc">Indiquez o√π se situe exactement le chantier.</p>

    <select id="ville">
      <option value="">S√©lectionner la ville...</option>
      <option value="Yaound√©">Yaound√©</option>
      <option value="Douala">Douala</option>
      <option value="Autre">Autre</option>
    </select>

    <input id="villeAutre" placeholder="Pr√©cisez la ville" style="display:none;" />

    <div class="autocomplete-container">
      <input id="quartier" placeholder="Quartier" autocomplete="off" />
      <div id="quartierResults" class="autocomplete-results" style="display:none;"></div>
    </div>

    <input id="lieudit" placeholder="Lieu dit" />

    <h2>3. Type d‚Äôintervention</h2>
    <p class="section-desc">S√©lectionnez la nature de votre demande.</p>
    <select id="intervention">
      <option value="">S√©lectionner...</option>
      <option>Mission urgence</option>
      <option>Mission classique</option>
      <option>Mains d'≈ìuvres multiples</option>
      <option>Projet de construction compl√®te</option>
      <option>Projet de r√©novation</option>
    </select>

    <h2>4. Corps de m√©tier</h2>
    <p class="section-desc">Vous pouvez ajouter plusieurs m√©tiers si n√©cessaire.</p>

    <div id="metiersContainer"></div>

    <button type="button" class="addMetierBtn" onclick="ajouterMetier()">‚ûï Ajouter un corps de m√©tier</button>

    <h2>5. Informations compl√©mentaires</h2>
    <p class="section-desc">Donnez toute information utile.</p>
    <textarea id="description" placeholder="Renseignez vos informations ici..."></textarea>

    <h2>6. Photos du chantier (optionnel)</h2>
    <p class="section-desc">Ajoutez des photos (max 2).</p>
    <div class="notice">
      Pour √©viter les limites Google (quotas) : <b>max 2 photos</b> et √©vitez les tr√®s grosses images.
    </div>
    <input type="file" id="photos" accept="image/*" multiple />
    <div class="hint">Max 2 photos. Si vous en choisissez plus, seules les 2 premi√®res seront envoy√©es.</div>
    <div id="photoPreview" style="display:flex; gap:10px; flex-wrap:wrap;"></div>

    <div id="sectionDisponibilites">
      <h2>7. Disponibilit√©s</h2>
      <p class="section-desc">Jusqu‚Äô√† trois cr√©neaux pour une visite.</p>
      <input type="datetime-local" id="c1" />
      <input type="datetime-local" id="c2" />
      <input type="datetime-local" id="c3" />
    </div>

    <div id="sectionDateSouhaitee">
      <h2>8. Date souhait√©e pour l‚Äôintervention</h2>
      <input type="date" id="dateSouhaitee" />
    </div>

    <button type="button" id="submitBtn" onclick="submitForm()">üì© Envoyer la demande</button>

  </form>
</div>

<script>
/************************************************************
 * CONFIG (URLs + limites c√¥t√© client)
 ************************************************************/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMBbbkY1LxTgStN1GUBd4zkwNkbohZBKpUq-pZOKSFaJJbanAbSTVv3QHi_63Boww_/exec";
const WHATSAPP_GROUP_LINK = "https://chat.whatsapp.com/EW1WhlaUzzw3qTlrIhqAsf";
const WHATSAPP_ADMIN_NUMBER = "237676591725"; // optionnel (r√©cap interne)

const MAX_PHOTOS = 2;
// Anti double-clic (et pour r√©duire les erreurs fetch)
let isSending = false;

/************************************************************
 * 1. BASE DE DONN√âES M√âTIERS (LISTE COMPL√àTE fournie)
 ************************************************************/
const data = {
  Carreleur_Solier: [
    { section:"I. Type de surface", question:"Quel type de surface ?", options:["Sol int√©rieur","Mur","Terrasse"] },
    { section:"II. Type de travaux", question:"Quel type de pose ?", options:["Pose neuve","D√©pose + repose","R√©paration"] },
    { section:"III. Surface (m¬≤)", question:"Surface √† poser (m¬≤) ?", options:["0‚Äì10","10‚Äì30","30‚Äì60","60+"] },
    { section:"IV. Support existant", question:"Type de support existant ?", options:["B√©ton","Ancien carrelage","Bois","Plancher"] }
  ],
  Charpentier_Couvreur: [
    { section:"I. Type de structure", question:"Type de structure ?", options:["Charpente bois","Charpente m√©tallique","Ossature mixte"] },
    { section:"II. Type de couverture", question:"Type de couverture ?", options:["T√¥le simple","Bac aluminium","T√¥le isol√©e","Tuile locale","Membrane bitumeuse"] },
    { section:"III. Type d‚Äôintervention", question:"Nature de l‚Äôintervention ?", options:["Construction neuve","R√©fection partielle","R√©paration fuite","R√©paration rouille","√âtanch√©it√© toiture-terrasse"] },
    { section:"IV. Superficie du toit", question:"Superficie du toit ?", options:["0‚Äì30","30‚Äì80","80‚Äì150","150+"] },
    { section:"V. Inclinaison", question:"Inclinaison ?", options:["Toit plat","Pente moyenne","Forte pente"] },
    { section:"VI. Acc√®s toiture", question:"Acc√®s √† la toiture ?", options:["Facile (plain-pied)","Moyen (maison √©tage)","Difficile (hauteur >6m)"] }
  ],
  Chauffagiste: [
    { section:"I. Type d‚Äô√©quipement", question:"Quel √©quipement ?", options:["Chauffe-eau √©lectrique","Chauffe-eau solaire","Chaudi√®re gaz/fioul","Chauffe-eau instantan√©"] },
    { section:"II. Type d‚Äôintervention", question:"Quel type d‚Äôintervention ?", options:["Plus d‚Äôeau chaude","R√©paration panne","Entretien / d√©tartrage","Remplacement pi√®ce","Remplacement complet","Installation neuve"] },
    { section:"III. Capacit√© / volume", question:"Capacit√© ?", options:["10‚Äì30 L","50‚Äì100 L","100‚Äì200 L","200+ L"] },
    { section:"IV. Localisation", question:"Localisation ?", options:["Salle de bain","Cuisine","Local technique","Ext√©rieur"] },
    { section:"V. Alimentation disponible", question:"Source d‚Äôalimentation ?", options:["√âlectricit√© stable","Gaz","Solaire"] }
  ],
  Climaticien_Frigoriste: [
    { section:"I. Type de service", question:"Type de service ?", options:["Installation neuve","Entretien","R√©paration","Remplacement"] },
    { section:"II. Syst√®me", question:"Type de syst√®me ?", options:["Split mural","Multi-split","Gainable","PAC","Chambre froide"] },
    { section:"III. Capacit√©", question:"Surface / capacit√© ?", options:["0‚Äì30 m¬≤","30‚Äì60 m¬≤","60‚Äì100 m¬≤","100+ m¬≤"] },
    { section:"IV. Sympt√¥mes", question:"Probl√®me constat√© ?", options:["Ne refroidit pas","Fuite","Bruit","Ne d√©marre pas","Entretien"] },
    { section:"V. Installation", question:"Acc√®s installation ?", options:["Simple","Moyen","Difficile"] }
  ],
  Deboucheur: [
    { section:"I. Canalisation", question:"Quel type de canalisation ?", options:["√âvier","Douche","WC","√âgout"] },
    { section:"II. Intervention", question:"Type d‚Äôintervention ?", options:["D√©bouchage","Inspection cam√©ra","Curage complet","R√©paration"] },
    { section:"III. Longueur", question:"Longueur estim√©e ?", options:["<5 m","5‚Äì10 m","10‚Äì20 m","+20 m"] },
    { section:"IV. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] }
  ],
  D√©sinsectiseur: [
    { section:"I. Intervention", question:"Type d‚Äôintervention ?", options:["D√©sinsectisation","D√©ratisation","Retrait amiante"] },
    { section:"II. Surface", question:"Surface ?", options:["0‚Äì50","50‚Äì100","100‚Äì200","200+"] },
    { section:"III. Site", question:"Type de site ?", options:["Logement","Local commercial","Chantier","Sous-sol","Combles"] },
    { section:"IV. Infestation", question:"Niveau ?", options:["L√©ger","Moyen","Fort"] },
    { section:"V. Fr√©quence", question:"Fr√©quence ?", options:["Unique","3 mois","Annuel"] }
  ],
  √âlectricien: [
    { section:"I. Type d‚Äôintervention", question:"Type d‚Äôintervention ?", options:["Nouvelle ligne","√âclairage","Prise/interrupteur","Panne √©lectrique","Mise en conformit√©","Compteur pr√©pay√©"] },
    { section:"II. Localisation", question:"Localisation ?", options:["Salon/chambre","Cuisine","Salle de bain","Ext√©rieur","Tableau principal"] },
    { section:"III. Courant", question:"Type de courant ?", options:["Monophas√©","Triphas√©","Solaire"] },
    { section:"IV. √âquipement", question:"√âquipement concern√© ?", options:["Prise","√âclairage","Ventilateur","Clim","Tableau √©lectrique","Pompe"] },
    { section:"V. Probl√®me", question:"Probl√®me constat√© ?", options:["Disjonction","Court-circuit","Odeur de br√ªl√©","Panne totale","R√©fection compl√®te"] },
    { section:"VI. Contexte", question:"Contexte ?", options:["Maison","Appartement","Commerce","Industriel"] }
  ],
  Enduiseur_Fa√ßadier: [
    { section:"I. Type", question:"Type d'enduit/rev√™tement ?", options:["Enduit neuf","Ravalement","R√©paration fissures","ITE"] },
    { section:"II. Support", question:"Support ?", options:["Brique","B√©ton","Parpaing","Pierre"] },
    { section:"III. Finition", question:"Finition ?", options:["Gratt√©e","Taloch√©e","Lisse","Projet√©e"] },
    { section:"IV. Surface", question:"Surface ?", options:["0‚Äì50","50‚Äì100","100‚Äì200","200+"] },
    { section:"V. Hauteur", question:"Hauteur fa√ßade ?", options:["<3 m","3‚Äì6 m",">6 m"] },
    { section:"VI. Acc√®s", question:"Acc√®s chantier ?", options:["Rue directe","Cour","√âchafaudage"] }
  ],
  Etancheur: [
    { section:"I. Surface", question:"Quelle surface ?", options:["Toiture terrasse","Mur enterr√©","Balcon/dalle","R√©serve d‚Äôeau"] },
    { section:"II. Intervention", question:"Type d‚Äôintervention ?", options:["Neuf","R√©fection","R√©paration fuites","Diagnostic"] },
    { section:"III. Rev√™tement", question:"Type de rev√™tement ?", options:["Bitume","R√©sine","EPDM/PVC","Hydrofuge"] },
    { section:"IV. Surface totale", question:"Surface totale ?", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"V. Acc√®s", question:"Acc√®s chantier ?", options:["Facile","Moyen","Difficile"] },
    { section:"VI. Eau", question:"Pr√©sence d'eau ?", options:["Oui","Non","Occasionnelle"] }
  ],
  Jardinier_Paysagiste: [
    { section:"I. Prestation", question:"Type de prestation ?", options:["Entretien","Taille","Am√©nagement","Gazon"] },
    { section:"II. Surface", question:"Surface ?", options:["0‚Äì100","100‚Äì500","500‚Äì1000","1000+"] },
    { section:"III. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] },
    { section:"IV. √âquipements", question:"√âl√©ments ?", options:["Gazon","Haies","Arbres","Massifs","Arrosage auto"] }
  ],
  Ma√ßon: [
    { section:"I. Travail", question:"Type de structure ?", options:["Fondation","Mur porteur","Chape/dalle","Escalier","R√©novation"] },
    { section:"II. B√¢timent", question:"Type de b√¢timent ?", options:["Maison simple","Immeuble R+1 √† R+4","Commercial","Mur de cl√¥ture"] },
    { section:"III. Surface", question:"Surface ?", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"IV. Mat√©riaux", question:"Mat√©riaux ?", options:["Parpaings","Briques","B√©ton arm√©","Pierre"] },
    { section:"V. Sol", question:"Nature du sol ?", options:["Argileux","Sablonneux","Compact","Rocailleux","Humide"] },
    { section:"VI. Acc√®s", question:"Acc√®s chantier ?", options:["Camion","All√©e","Brouette","Manuel"] }
  ],
  Peintre_Decorateur: [
    { section:"I. Surface", question:"Surface √† peindre ?", options:["Murs","Plafonds","Menuiseries","Fa√ßade ext√©rieure"] },
    { section:"II. Travaux", question:"Type de travaux ?", options:["Peinture neuve","R√©novation","D√©coration"] },
    { section:"III. Surface m¬≤", question:"Surface (m¬≤)", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"IV. Support", question:"√âtat du support ?", options:["Neuf","Ancien","Tr√®s ab√Æm√©"] },
    { section:"V. Finition", question:"Niveau de finition ?", options:["Standard","Haut de gamme"] }
  ],
  Pl√¢trier_Plaquiste: [
    { section:"I. Travaux", question:"Type de travaux ?", options:["Cloisons","Isolation","Plafond","Finition s√®che"] },
    { section:"II. Surface", question:"Surface (m¬≤) ?", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"III. Support", question:"Type de support ?", options:["Mur neuf","Mur ancien","Plafond","Combles"] },
    { section:"IV. Finition", question:"Niveau de finition ?", options:["Standard","Haut de gamme","D√©corative"] },
    { section:"V. Acc√®s", question:"Acc√®s ?", options:["Libre","Hauteur >3m","Chantier occup√©"] }
  ],
  Pisciniste: [
    { section:"I. Service", question:"Type de service ?", options:["Construction","R√©novation","Entretien","D√©pannage"] },
    { section:"II. Type", question:"Type de piscine ?", options:["B√©ton","Coque","Hors-sol","Naturelle"] },
    { section:"III. Volume", question:"Volume (m¬≥) ?", options:["<20","20‚Äì50","50‚Äì100","100+"] },
    { section:"IV. Traitement", question:"Traitement ?", options:["Chlore","Sel","UV","Ozone","Autre"] },
    { section:"V. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] }
  ],
  Plombier: [
    { section:"I. Intervention", question:"Quel type d‚Äôintervention ?", options:["Fuite","WC bouch√©","Robinet/lavabo","Chauffe-eau","Pression faible","Salle de bain compl√®te"] },
    { section:"II. Localisation", question:"Localisation ?", options:["Salle de bain","Cuisine","Mur/sol","Ext√©rieur","Toiture/r√©servoir"] },
    { section:"III. Mat√©riel", question:"Tuyauterie ?", options:["PVC","Cuivre","Galva","Multicouche","Inconnu"] },
    { section:"IV. Gravit√©", question:"Gravit√© ?", options:["Majeure","Faible pression","Bouchage","Eau stagnante","Mineur"] },
    { section:"V. Acc√®s", question:"Acc√®s ?", options:["Visible","Encastre","R√©servoir","Pompe"] },
    { section:"VI. Environnement", question:"Lieu ?", options:["Appartement","Maison","Commerce","Collectif"] }
  ],
  Ramoneur: [
    { section:"I. √âquipement", question:"√âquipement ?", options:["Chemin√©e","Po√™le","Chaudi√®re","VMC"] },
    { section:"II. Entretien", question:"Dernier entretien ?", options:["<6 mois","6‚Äì12 mois",">1 an","Inconnu"] },
    { section:"III. Intervention", question:"Type ?", options:["Ramonage","Nettoyage","Bistre","Inspection cam√©ra"] },
    { section:"IV. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] },
    { section:"V. Conduits", question:"Nombre ?", options:["1","2‚Äì3","+3"] }
  ],
  Staffeur_Stucateur: [
    { section:"I. Travail", question:"Type de travail ?", options:["Moulures","Restauration","D√©cor mural","Sur mesure"] },
    { section:"II. Surface", question:"Surface/√©l√©ments ?", options:["1‚Äì5 m","5‚Äì20 m","20+ m","Surface >10 m¬≤"] },
    { section:"III. Lieu", question:"Lieu ?", options:["R√©sidentiel","Patrimoine","Commerce","Institution"] },
    { section:"IV. Finition", question:"Finition ?", options:["Lisse","Patin√©e","Dor√©e"] },
    { section:"V. Acc√®s", question:"Difficult√© ?", options:["Facile","Moyen","Difficile"] }
  ],
  Technicien_Humidite: [
    { section:"I. Probl√®me", question:"Type de probl√®me ?", options:["Capillarit√©","Infiltration","Condensation","Ventilation"] },
    { section:"II. Localisation", question:"O√π ?", options:["Sous-sol","Mur int√©rieur","Salle de bain","Combles"] },
    { section:"III. Surface", question:"Surface ?", options:["0‚Äì10","10‚Äì30","30‚Äì50","50+"] },
    { section:"IV. Traces", question:"Traces visibles ?", options:["Taches","Odeurs","Salp√™tre","Structure ab√Æm√©e"] },
    { section:"V. B√¢timent", question:"Type de b√¢timent ?", options:["Maison","Appartement"] }
  ]
};

/************************************************************
 * 2. QUARTIERS (LISTES COMPL√àTES fournies)
 ************************************************************/
const quartiersYaounde = [
  'Akono','Angangueo','Anguissa','Bastos','Biteng','Biyem-Assi','Briqueterie',
  'Camp SIC Hippodrome','Camp-Sonel','Carri√®re','Cit√© Verte','Condengui','Damas',
  'Ebogo','Efog-Ateba','Efoulan','Ekoudou','Ekounou','Emana','Emonbo','Essos',
  'Etoa-Meki','Etoug-Ebe','Etoudi','Fouda','Jean-Vespa','Kondengui','Koweit City',
  'Maison Blanche','Mbankolo','Mbimi','Mballa 2','Mehandan','Melen','Mefou','Mendong',
  'Mfandena','Mimboman','Mini-ferme','Minkama','Mokolo','Mvan','Mvog Ada',
  'Mvog Atangana Mballa','Mvog-Betsi','Mvog-Mbi','Mvoly√©','Ndzana','Ngoa Ek√©l√©',
  'Ngola','Ngousso','Ngoumou','Nkol-Ewoue','Nkol-Ewouelle','Nkolbisson','Nkoldongo',
  'Nkolmesseng','Nkolndongo','Nkom Kana','Nkometou','Nkomo','Nlongkak','Nkolbikok',
  'Nkolzol','Nkolzol II','Nlongkwa','Nlongmeko‚Äôo','Nlongmeko','Nlongola','Nyom',
  'Obili','Obobogo','Odza','Olemb√©','Ol√©zoa','Oliga','Omnisports','Oyom-Abang',
  'Plateau Atemengue','Poste Centrale','Santa Barbara','Simbock','Tam-Tam Weekend',
  'Tongolo','Tsinga','Village Mvog Ada','Yaound√© Centre','Zamakoe','Messa','Eleveur'
];

const quartiersDouala = [
  'A√©roport','Akra Kombo','Babylone I','Babylone II','Bali','Bangue','Beedi','Bepanda',
  'Bessengue','Besseke','Bikoro','Bilongue','Bilingue','Bobongo','Boko','Bomkul',
  'Bona Bekombo','Bonabeyike','Bonadiwoto','Bonadouma','Bonadoumb√©','Bonadibong',
  'Bonagang','Bonajang','Bonajinje','Bonakouamouang','Bonakeke Akwa','Bonalembe',
  'Bonamatoumbe','Bonambappe','Bonaminkano','Bonamoussadi','Bonamoudourou',
  'Bonamouti','Bonamouti Akwa 2','Bonanjo','Bonanloka','Bonangando','Bonapriso',
  'Bonassama','Bonateki','Bonatene','Bonelang','Bonoleke','Bonoumb√©','Bonutongo',
  'Brazzaville','Bu','Bwap√©','Cacao-Barry','Cap Cameroun','C.C.C.','Cit√© Berge',
  'Cit√© de la Paix','Cit√© des palmiers','Cit√© Sic','Congo','Dahomey','De√Ødo',
  'Dibom','Dikahe','Dj√©bal√®','Emene City','Epaka I','Epaka II','Gentil','Grand Moulin',
  'Hydrocarbures','Japoma','Jourdain','Kassalafam','Kombo Bouma','Kombo Moukoko',
  'Kondi','Koo','Kotto','Koumassi','Lagos Market','Lendi','Logbaba','Logbessou','Logpom',
  'Lyc√©e de New Bell','Madiba','Makepe','Malangue','Mambanda','Manike','Manoka','Massadi',
  'Matanda','Mbam Ewondo','Mbanga Bakoko','Mbengue City','Mb√©nadikoum√©','Moungangu√©',
  'Moukala Tanda','Ndogbati','Ndogbong','Ndoghem','Ndoghem II','Ndogmbe','Ndogpassi',
  'Ndogsimbi','Ndobo','Ndokoti','Ndjong-Mebi','Ngangue','Ngodi','Ngoma','Ngwel√©',
  'Nguereck','Nguibassal','Nkomba','Nkongmondo','Nkongui','Nkololoun','NKondi',
  'Nouvelle zone d\'Akwa Nord','Nouvelle zone de New-Deido','Number One Creek',
  'Nyalla','Nyangadou','Nylon','Oyack','Petit Toub√©','Pk 7','Pk 9','Pk 10','Pk 11',
  'Pk 17','Pk 21','Plateau Joss','Pom Lien','Prison centrale de New Bell','Sabenjongo',
  'Sincatex','So-Boum','Sodiko','Sodikombo','Sobikago','Song-Mahop','Song-Ngongag',
  'Sopom','Source','T.S.F','Tergal','Village','Youpw√©'
];

/************************************************************
 * 3. DOM
 ************************************************************/
const typeClient = document.getElementById("typeClient");
const clientPrive = document.getElementById("clientPrive");
const clientEntreprise = document.getElementById("clientEntreprise");

const nomPrive = document.getElementById("nomPrive");
const telephonePrive = document.getElementById("telephonePrive");
const emailPrive = document.getElementById("emailPrive");

const nomEntrepriseEl = document.getElementById("nomEntreprise");
const nuiEl = document.getElementById("nui");
const rccmEl = document.getElementById("rccm");
const siegeEl = document.getElementById("siege");
const telephoneEntrepriseEl = document.getElementById("telephoneEntreprise");
const emailEntrepriseEl = document.getElementById("emailEntreprise");

const villeSelect = document.getElementById("ville");
const villeAutre = document.getElementById("villeAutre");
const quartierInput = document.getElementById("quartier");
const quartierResults = document.getElementById("quartierResults");
const lieudit = document.getElementById("lieudit");

const intervention = document.getElementById("intervention");
const sectionDisponibilites = document.getElementById("sectionDisponibilites");
const sectionDateSouhaitee = document.getElementById("sectionDateSouhaitee");
const c1 = document.getElementById("c1");
const c2 = document.getElementById("c2");
const c3 = document.getElementById("c3");
const dateSouhaitee = document.getElementById("dateSouhaitee");

const description = document.getElementById("description");
const photosInput = document.getElementById("photos");
const photoPreview = document.getElementById("photoPreview");

const submitBtn = document.getElementById("submitBtn");

let quartiersActifs = [];
let compteurMetiers = 0;

/************************************************************
 * 4. PRIV√â / ENTREPRISE
 ************************************************************/
typeClient.addEventListener("change", () => {
  clientPrive.style.display = typeClient.value === "prive" ? "block" : "none";
  clientEntreprise.style.display = typeClient.value === "entreprise" ? "block" : "none";
  updateSubmitButtonLabel_();
});

/************************************************************
 * 5. AUTOCOMPLETE QUARTIERS
 ************************************************************/
villeSelect.addEventListener("change", () => {
  villeAutre.style.display = (villeSelect.value === "Autre") ? "block" : "none";

  quartiersActifs =
    villeSelect.value === "Yaound√©" ? quartiersYaounde :
    villeSelect.value === "Douala" ? quartiersDouala :
    [];

  quartierInput.value = "";
  quartierResults.innerHTML = "";
  quartierResults.style.display = "none";
  updateSubmitButtonLabel_();
});

quartierInput.addEventListener("input", () => {
  const term = quartierInput.value.toLowerCase();
  quartierResults.innerHTML = "";

  if (term.length === 0 || quartiersActifs.length === 0) {
    quartierResults.style.display = "none";
    updateSubmitButtonLabel_();
    return;
  }

  const filtered = quartiersActifs.filter(q => q.toLowerCase().includes(term));
  if (!filtered.length) {
    quartierResults.style.display = "none";
    updateSubmitButtonLabel_();
    return;
  }

  filtered.forEach(q => {
    const div = document.createElement("div");
    div.className = "autocomplete-item";
    div.textContent = q;
    div.onclick = () => {
      quartierInput.value = q;
      quartierResults.style.display = "none";
      updateSubmitButtonLabel_();
    };
    quartierResults.appendChild(div);
  });

  quartierResults.style.display = "block";
  updateSubmitButtonLabel_();
});

document.addEventListener("click", e => {
  if (!quartierResults.contains(e.target) && e.target !== quartierInput) {
    quartierResults.style.display = "none";
  }
});

/************************************************************
 * 6. PHOTOS ‚Äî preview + limite 2 (‚úÖ precaution)
 ************************************************************/
photosInput.addEventListener("change", () => {
  // ‚úÖ Limite √† 2 d√®s la s√©lection (mieux que ‚Äújuste au moment d‚Äôenvoyer‚Äù)
  const files = Array.from(photosInput.files).slice(0, MAX_PHOTOS);
  if (photosInput.files.length > MAX_PHOTOS) {
    alert(`‚ÑπÔ∏è Maximum ${MAX_PHOTOS} photos. Seules les ${MAX_PHOTOS} premi√®res seront gard√©es.`);
  }

  // Recr√©e un FileList limit√©
  const dt = new DataTransfer();
  files.forEach(f => dt.items.add(f));
  photosInput.files = dt.files;

  photoPreview.innerHTML = "";
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement("img");
      img.src = e.target.result;
      photoPreview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

/************************************************************
 * 7. MULTI-M√âTIERS + MO extras
 ************************************************************/
function ajouterMetier() {
  compteurMetiers++;

  const block = document.createElement("div");
  block.className = "metierBlock";
  block.id = "metierBlock_" + compteurMetiers;

  block.innerHTML = `
    <h3>M√©tier #${compteurMetiers}</h3>

    <select class="metierSelect" data-id="${compteurMetiers}">
      <option value="">S√©lectionner...</option>
      ${Object.keys(data).map(m => `<option value="${m}">${m}</option>`).join("")}
      <option value="Autre">Autre</option>
    </select>

    <div class="questionsTechniques" id="questions_${compteurMetiers}"></div>

    <textarea class="descMetier" id="descMetier_${compteurMetiers}" placeholder="Description sp√©cifique du m√©tier"></textarea>

    <div class="moExtras" id="mo_${compteurMetiers}" style="display:none;">
      <h4>Mains d'≈ìuvres multiples ‚Äì Informations suppl√©mentaires</h4>

      <label>Nombre de techniciens n√©cessaires</label>
      <input type="number" id="techniciens_${compteurMetiers}" min="1" placeholder="Ex : 3">

      <label>Forfait par jour (Mains d'≈ìuvre)</label>
      <input type="text" id="forfait_${compteurMetiers}" placeholder="Ex : 50 000 FCFA / jour">

      <label>Vous prenez en charge l'h√©bergement ?</label>
      <select id="hebergement_${compteurMetiers}">
        <option value="">S√©lectionner...</option>
        <option value="Oui">Oui</option>
        <option value="Non">Non</option>
      </select>

      <label>Date d√©but de prestation</label>
      <input type="date" id="debut_${compteurMetiers}">

      <label>Date fin de prestation</label>
      <input type="date" id="fin_${compteurMetiers}">
    </div>

    <button type="button" class="removeMetierBtn" onclick="supprimerMetier(${compteurMetiers})">‚ùå Supprimer ce m√©tier</button>
  `;

  document.getElementById("metiersContainer").appendChild(block);
  majAffichageMainsOeuvre();
  updateSubmitButtonLabel_();
}

function supprimerMetier(id) {
  const el = document.getElementById("metierBlock_" + id);
  if (el) el.remove();
  updateSubmitButtonLabel_();
}

document.addEventListener("change", function(e) {
  if (e.target.classList.contains("metierSelect")) {
    const id = e.target.dataset.id;
    const metier = e.target.value;
    const container = document.getElementById("questions_" + id);

    container.innerHTML = "";
    if (!metier || !data[metier]) { updateSubmitButtonLabel_(); return; }

    data[metier].forEach(item => {
      const h = document.createElement("h4");
      h.textContent = item.section;
      container.appendChild(h);

      const label = document.createElement("label");
      label.textContent = item.question;
      container.appendChild(label);

      const select = document.createElement("select");
      select.className = "questionSelect";
      select.dataset.metierId = id;
      select.dataset.question = item.question;
      select.innerHTML = `<option value="">S√©lectionner...</option>`;

      item.options.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        select.appendChild(opt);
      });

      const optAutre = document.createElement("option");
      optAutre.value = "Autre";
      optAutre.textContent = "Autre";
      select.appendChild(optAutre);

      container.appendChild(select);
    });

    updateSubmitButtonLabel_();
  }
});

/************************************************************
 * 8. LOGIQUE MO
 ************************************************************/
function majAffichageMainsOeuvre() {
  const isMO = (intervention.value === "Mains d'≈ìuvres multiples");
  sectionDisponibilites.style.display = isMO ? "none" : "block";
  sectionDateSouhaitee.style.display = isMO ? "none" : "block";
  document.querySelectorAll(".moExtras").forEach(div => {
    div.style.display = isMO ? "block" : "none";
  });
}
intervention.addEventListener("change", () => { majAffichageMainsOeuvre(); updateSubmitButtonLabel_(); });

/************************************************************
 * 9. D√©termination "lead" vs "intervention compl√®te" (front)
 ************************************************************/
function buildPayloadLight_() {
  return {
    ville: (villeSelect.value === "Autre") ? villeAutre.value : villeSelect.value,
    quartier: quartierInput.value,
    lieudit: lieudit.value,
    intervention: intervention.value,
    metiers: Array.from(document.querySelectorAll(".metierBlock")).map(block => ({
      metier: block.querySelector(".metierSelect")?.value || ""
    })),
    // projet: { type: "..."} // (pas pr√©sent dans ton formulaire pour l‚Äôinstant)
  };
}

function hasMetierOrProjet_(payloadLight) {
  const hasMetier = Array.isArray(payloadLight.metiers) && payloadLight.metiers.some(m => String(m?.metier || "").trim());
  const hasProjet = !!(payloadLight.projet && String(payloadLight.projet.type || "").trim());
  return hasMetier || hasProjet;
}

function isInterventionCompleteFront_(payloadLight) {
  const hasChantierEtType =
    String(payloadLight.ville || "").trim() &&
    String(payloadLight.quartier || "").trim() &&
    String(payloadLight.lieudit || "").trim() &&
    String(payloadLight.intervention || "").trim();
  return !!(hasChantierEtType && hasMetierOrProjet_(payloadLight));
}

function updateSubmitButtonLabel_() {
  const complete = isInterventionCompleteFront_(buildPayloadLight_());
  submitBtn.textContent = complete ? "üì© Envoyer la demande" : "Enregistrer mes coordonn√©es";
}

// refresh label on key fields
["input","change"].forEach(evt => {
  villeAutre.addEventListener(evt, updateSubmitButtonLabel_);
  quartierInput.addEventListener(evt, updateSubmitButtonLabel_);
  lieudit.addEventListener(evt, updateSubmitButtonLabel_);
  intervention.addEventListener(evt, updateSubmitButtonLabel_);
});

/************************************************************
 * 10. WhatsApp helpers
 ************************************************************/
function normalizeCMPhone_(phoneRaw) {
  const raw = String(phoneRaw || "").trim();
  const digits = raw.replace(/\D/g, "");

  if (digits.startsWith("237") && digits.length >= 11) return digits;     // 2376xxxxxxx
  if (digits.length === 9 && digits.startsWith("6")) return "237" + digits; // 6xxxxxxx -> 2376xxxxxxx
  return digits;
}

function openWhatsAppToClientInvite_(clientPhoneRaw) {
  const phone = normalizeCMPhone_(clientPhoneRaw);
  if (!phone) return;
  const text = `Bonjour, voici le lien d‚Äôadh√©sion au groupe WhatsApp QemWork : ${WHATSAPP_GROUP_LINK}`;
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, "_blank");
}

function openWhatsAppToAdminSummary_(id, mode, payload) {
  if (!WHATSAPP_ADMIN_NUMBER) return;

  const title = mode === "lead" ? "NOUVEAU LEAD" : "NOUVELLE DEMANDE";
  const idLabel = mode === "lead" ? "LeadID" : "Ticket";

  const metiersTxt = (payload.metiers && payload.metiers.length)
    ? payload.metiers.map(m => "‚Ä¢ " + (m.metier || "")).join("\n")
    : "‚Ä¢ (Aucun)";

  const message = `
üî• ${title} QEMWORK (${idLabel}: ${id || "N/A"})

Nom : ${payload.nom || ""}
T√©l√©phone : ${payload.telephone || ""}
Email : ${payload.email || ""}

Chantier :
‚Ä¢ Ville : ${payload.ville || ""}
‚Ä¢ Quartier : ${payload.quartier || ""}
‚Ä¢ Lieu dit : ${payload.lieudit || ""}

Intervention : ${payload.intervention || ""}

M√©tiers :
${metiersTxt}

üìù Description :
${payload.description || ""}
`.trim();

  window.open(`https://wa.me/${WHATSAPP_ADMIN_NUMBER}?text=${encodeURIComponent(message)}`, "_blank");
}

/************************************************************
 * 11. Fetch ‚Äúsafe‚Äù + timeout (‚úÖ precaution contre erreurs fetch)
 ************************************************************/
async function fetchJsonWithTimeout_(url, options = {}, timeoutMs = 25000) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const resp = await fetch(url, { ...options, signal: controller.signal });
    const text = await resp.text();
    let json;
    try { json = JSON.parse(text); }
    catch { throw new Error("R√©ponse non-JSON (serveur/connexion)."); }

    if (!resp.ok) {
      throw new Error(json?.error || `HTTP ${resp.status}`);
    }
    return json;
  } catch (e) {
    if (e.name === "AbortError") throw new Error("Timeout r√©seau (r√©essayez).");
    throw e;
  } finally {
    clearTimeout(t);
  }
}

/************************************************************
 * 12. ENVOI
 *
 * Limites Google :
 * - 12/min : d√©j√† prot√©g√© c√¥t√© Apps Script par rate-limit (10s/phone)
 * - 500/jour : on √©vite les doublons + on incite lead quand incomplet
 * - 2 photos max : appliqu√© c√¥t√© client + c√¥t√© serveur
 ************************************************************/
async function submitForm() {
  if (isSending) return;
  isSending = true;
  submitBtn.disabled = true;

  try {
    // V√©rifications minimales (√©vite erreurs serveur)
    if (!typeClient.value) throw new Error("Veuillez s√©lectionner le type de client.");
    const phone = (typeClient.value === "prive") ? telephonePrive.value : telephoneEntrepriseEl.value;
    if (!String(phone || "").trim()) throw new Error("Veuillez renseigner le t√©l√©phone.");

    // Photos -> base64 (d√©j√† limit√©es √† 2 au change)
    const files = Array.from(photosInput.files).slice(0, MAX_PHOTOS);
    const photosBase64 = await Promise.all(
      files.map(file =>
        toBase64(file).then(b64 => ({
          filename: file.name,
          mimeType: file.type,
          base64: b64.split(",")[1]
        }))
      )
    );

    // M√©tiers d√©taill√©s
    const metiers = [];
    document.querySelectorAll(".metierBlock").forEach(block => {
      const id = block.id.split("_")[1];
      const metier = block.querySelector(".metierSelect").value;
      if (!metier) return;

      const descMetier = block.querySelector(".descMetier").value;
      const reponses = {};
      block.querySelectorAll(".questionSelect").forEach(sel => {
        reponses[sel.dataset.question] = sel.value;
      });

      metiers.push({
        metier,
        description: descMetier,
        questions: reponses,
        forfait: document.getElementById(`forfait_${id}`)?.value || null,
        hebergement: document.getElementById(`hebergement_${id}`)?.value || null,
        techniciens: document.getElementById(`techniciens_${id}`)?.value || null,
        debut: document.getElementById(`debut_${id}`)?.value || null,
        fin: document.getElementById(`fin_${id}`)?.value || null
      });
    });

    // Payload final
    const payload = {
      typeClient: typeClient.value,
      nom: typeClient.value === "prive" ? nomPrive.value : nomEntrepriseEl.value,
      telephone: phone,
      email: typeClient.value === "prive" ? emailPrive.value : emailEntrepriseEl.value,

      telephonePrive: typeClient.value === "prive" ? telephonePrive.value : null,
      emailPrive: typeClient.value === "prive" ? emailPrive.value : null,

      nomEntreprise: typeClient.value === "entreprise" ? nomEntrepriseEl.value : null,
      nui: typeClient.value === "entreprise" ? nuiEl.value : null,
      rccm: typeClient.value === "entreprise" ? rccmEl.value : null,
      siege: typeClient.value === "entreprise" ? siegeEl.value : null,
      telephoneEntreprise: typeClient.value === "entreprise" ? telephoneEntrepriseEl.value : null,
      emailEntreprise: typeClient.value === "entreprise" ? emailEntrepriseEl.value : null,

      ville: (villeSelect.value === "Autre") ? villeAutre.value : villeSelect.value,
      quartier: quartierInput.value,
      lieudit: lieudit.value,

      intervention: intervention.value,

      c1: c1.value,
      c2: c2.value,
      c3: c3.value,
      dateSouhaitee: dateSouhaitee.value,

      description: description.value,

      metiers,
      photos: photosBase64
    };

    // ‚úÖ POST JSON avec timeout + parsing safe
    const res = await fetchJsonWithTimeout_(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }, 25000);

    if (!res.success) throw new Error(res.error || "Erreur serveur.");

    // WhatsApp client: lien groupe pr√™t √† envoyer
    openWhatsAppToClientInvite_(payload.telephone);

    // WhatsApp admin (optionnel)
    const mode = res.mode || (res.ticket ? "intervention" : "lead");
    const id = res.ticket || res.leadId || "";
    openWhatsAppToAdminSummary_(id, mode, payload);

    alert("‚úîÔ∏è Enregistr√© avec succ√®s !");
  } catch (err) {
    alert("‚ùå " + (err?.message || err));
    console.log(err);
  } finally {
    isSending = false;
    submitBtn.disabled = false;
    updateSubmitButtonLabel_();
  }
}

/************************************************************
 * 13. Base64
 ************************************************************/
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Impossible de lire le fichier."));
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

// Init
updateSubmitButtonLabel_();
</script>
</body>
</html>
