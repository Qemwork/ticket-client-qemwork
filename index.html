<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>QemWork - Demande d'intervention</title>
<style>
body{font-family:Arial, sans-serif;background:#f4f6f9;margin:0;padding:20px}
.container{max-width:1100px;margin:20px auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
h1{margin-top:0}
input,select,textarea,button{font-size:15px}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border:1px solid #e0e0e0;border-radius:8px;background:#fbfbfb}
button{padding:12px;border-radius:8px;border:none;background:#25D366;color:#fff;cursor:pointer;font-weight:700}
.smallBtn{display:inline-block;padding:8px 10px;border-radius:8px;border:none;background:#007bff;color:#fff;cursor:pointer;margin:6px 0}
.linkBtn{background:#128C7E}
.metierBlock{border:1px solid #eee;padding:12px;border-radius:8px;margin-bottom:10px;background:#fff}
.projetCheckboxWrap label{display:block}
#photoPreview img{width:90px;height:90px;object-fit:cover;border-radius:8px;margin-right:8px;margin-bottom:8px}
.autocomplete-item{padding:8px;cursor:pointer;border-bottom:1px solid #f0f0f0}
.note{font-size:13px;color:#666;margin-top:6px}
.row{display:flex;gap:10px}
.col2{flex:1}
</style>
</head>
<body>
<div class="container">
  <h1>Demande d'intervention QemWork</h1>

  <form id="qemForm" onsubmit="return false;">
    <h3>1. Coordonn√©es</h3>
    <select id="typeClient" required>
      <option value="">-- Type client --</option>
      <option value="prive">Priv√©</option>
      <option value="entreprise">Entreprise</option>
    </select>

    <div id="clientPrive" style="display:none">
      <input id="nomPrive" placeholder="Nom complet">
      <input id="telephonePrive" placeholder="T√©l√©phone (ex : 676591725)">
      <input id="emailPrive" placeholder="E-mail" type="email">
    </div>

    <div id="clientEntreprise" style="display:none">
      <input id="nomEntreprise" placeholder="Nom de l'entreprise">
      <input id="nui" placeholder="NUI">
      <input id="rccm" placeholder="RCCM">
      <input id="siege" placeholder="Si√®ge">
      <input id="telephoneEntreprise" placeholder="T√©l√©phone entreprise">
      <input id="emailEntreprise" placeholder="E-mail entreprise" type="email">
    </div>

    <h3>2. Chantier</h3>
    <select id="ville">
      <option value="">-- Ville --</option>
      <option value="Yaound√©">Yaound√©</option>
      <option value="Douala">Douala</option>
      <option value="Bafoussam">Bafoussam</option>
      <option value="Garoua">Garoua</option>
      <option value="Maroua">Maroua</option>
      <option value="Bertoua">Bertoua</option>
      <option value="Autre">Autre</option>
    </select>
    <input id="villeAutre" placeholder="Pr√©cisez la ville" style="display:none">
    <input id="quartier" placeholder="Quartier (commencez √† taper)">
    <div id="quartierResults"></div>
    <input id="lieudit" placeholder="Lieu dit">

    <h3>3. Intervention</h3>
    <select id="intervention">
      <option value="">-- Type intervention --</option>
      <option>Mission urgence</option>
      <option>Mission classique</option>
      <option>Mains d'≈ìuvres multiples</option>
      <option>Projet de construction compl√®te</option>
      <option>Projet de r√©novation</option>
    </select>

    <h3 id="titlePoint4">4. Corps de m√©tier</h3>
    <p id="descPoint4">Vous pouvez ajouter plusieurs m√©tiers si n√©cessaire.</p>

    <div id="metiersContainer"></div>
    <button type="button" class="smallBtn addMetierBtn">‚ûï Ajouter un m√©tier</button>

    <div id="projetContainer" style="display:none;margin-top:12px">
      <h4 id="projetTitle">Questionnaire projet</h4>
      <div id="projetQuestions"></div>
      <textarea id="projetDescription" placeholder="Description projet" rows="4"></textarea>
    </div>

    <h3>5. Description</h3>
    <textarea id="description" rows="4" placeholder="Description d√©taill√©e"></textarea>

    <h3>6. Photos (optionnel)</h3>
    <input type="file" id="photos" accept="image/*" multiple>
    <div id="photoPreview"></div>

    <h3>7. Disponibilit√©s / Dates</h3>
    <div class="row">
      <div class="col2"><label>Cr√©neau 1</label><input type="datetime-local" id="c1"></div>
      <div class="col2"><label>Cr√©neau 2</label><input type="datetime-local" id="c2"></div>
      <div class="col2"><label>Cr√©neau 3</label><input type="datetime-local" id="c3"></div>
    </div>
    <label>Date souhait√©e</label>
    <input type="date" id="dateSouhaitee">

    <br><br>
    <button id="sendBtn" type="button">üì© Envoyer la demande</button>
    <button id="waManualBtn" type="button" class="smallBtn linkBtn" style="margin-left:8px">üîó Envoyer invitation WhatsApp (manuel)</button>

    <p class="note">Apr√®s envoi, une fen√™tre WhatsApp s'ouvrira pour envoyer un message pr√©rempli au client (wa.me) ou le lien d'invitation si pas de num√©ro.</p>
  </form>
</div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzefKKEEam0Pk9d2Rc5Qny8TV3m5A5BYlUhGNw_AsUphzMZ-P5TjbqNNAadi-PU8q7U7g/exec";
const WA_GROUP_INVITE = "https://chat.whatsapp.com/EW1WhlaUzzw3qTlrIhqAsf";
const LIB_MO = "Mains d'≈ìuvres multiples";

/* ========== LISTES COMPLETES (tu as fourni) ========== */
const data = {
  Carreleur_Solier: [
    { section:"I. Type de surface", question:"Quel type de surface ?", options:["Sol int√©rieur","Mur","Terrasse"] },
    { section:"II. Type de travaux", question:"Quel type de pose ?", options:["Pose neuve","D√©pose + repose","R√©paration"] },
    { section:"III. Surface (m¬≤)", question:"Surface √† poser (m¬≤) ?", options:["0‚Äì10","10‚Äì30","30‚Äì60","60+"] },
    { section:"IV. Support existant", question:"Type de support existant ?", options:["B√©ton","Ancien carrelage","Bois","Plancher"] }
  ],
  Charpentier_Couvreur: [
    { section:"I. Type de structure", question:"Type de structure ?", options:["Charpente bois","Charpente m√©tallique","Ossature mixte"] },
    { section:"II. Type de couverture", question:"Type de couverture ?", options:["T√¥le simple","Bac aluminium","T√¥le isol√©e","Tuile locale","Membrane bitumeuse"] },
    { section:"III. Type d‚Äôintervention", question:"Nature de l‚Äôintervention ?", options:["Construction neuve","R√©fection partielle","R√©paration fuite","R√©paration rouille","√âtanch√©it√© toiture-terrasse"] },
    { section:"IV. Superficie du toit", question:"Superficie du toit ?", options:["0‚Äì30","30‚Äì80","80‚Äì150","150+"] },
    { section:"V. Inclinaison", question:"Inclinaison ?", options:["Toit plat","Pente moyenne","Forte pente"] },
    { section:"VI. Acc√®s toiture", question:"Acc√®s √† la toiture ?", options:["Facile (plain-pied)","Moyen (maison √©tage)","Difficile (hauteur >6m)"] }
  ],
  Chauffagiste: [
    { section:"I. Type d‚Äô√©quipement", question:"Quel √©quipement ?", options:["Chauffe-eau √©lectrique","Chauffe-eau solaire","Chaudi√®re gaz/fioul","Chauffe-eau instantan√©"] },
    { section:"II. Type d‚Äôintervention", question:"Quel type d‚Äôintervention ?", options:["Plus d‚Äôeau chaude","R√©paration panne","Entretien / d√©tartrage","Remplacement pi√®ce","Remplacement complet","Installation neuve"] },
    { section:"III. Capacit√© / volume", question:"Capacit√© ?", options:["10‚Äì30 L","50‚Äì100 L","100‚Äì200 L","200+ L"] },
    { section:"IV. Localisation", question:"Localisation ?", options:["Salle de bain","Cuisine","Local technique","Ext√©rieur"] },
    { section:"V. Alimentation disponible", question:"Source d‚Äôalimentation ?", options:["√âlectricit√© stable","Gaz","Solaire"] }
  ],
  Climaticien_Frigoriste: [
    { section:"I. Type de service", question:"Type de service ?", options:["Installation neuve","Entretien","R√©paration","Remplacement"] },
    { section:"II. Syst√®me", question:"Type de syst√®me ?", options:["Split mural","Multi-split","Gainable","PAC","Chambre froide"] },
    { section:"III. Capacit√©", question:"Surface / capacit√© ?", options:["0‚Äì30 m¬≤","30‚Äì60 m¬≤","60‚Äì100 m¬≤","100+ m¬≤"] },
    { section:"IV. Sympt√¥mes", question:"Probl√®me constat√© ?", options:["Ne refroidit pas","Fuite","Bruit","Ne d√©marre pas","Entretien"] },
    { section:"V. Installation", question:"Acc√®s installation ?", options:["Simple","Moyen","Difficile"] }
  ],
  Deboucheur: [
    { section:"I. Canalisation", question:"Quel type de canalisation ?", options:["√âvier","Douche","WC","√âgout"] },
    { section:"II. Intervention", question:"Type d‚Äôintervention ?", options:["D√©bouchage","Inspection cam√©ra","Curage complet","R√©paration"] },
    { section:"III. Longueur", question:"Longueur estim√©e ?", options:["<5 m","5‚Äì10 m","10‚Äì20 m","+20 m"] },
    { section:"IV. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] }
  ],
  D√©sinsectiseur: [
    { section:"I. Intervention", question:"Type d‚Äôintervention ?", options:["D√©sinsectisation","D√©ratisation","Retrait amiante"] },
    { section:"II. Surface", question:"Surface ?", options:["0‚Äì50","50‚Äì100","100‚Äì200","200+"] },
    { section:"III. Site", question:"Type de site ?", options:["Logement","Local commercial","Chantier","Sous-sol","Combles"] },
    { section:"IV. Infestation", question:"Niveau ?", options:["L√©ger","Moyen","Fort"] },
    { section:"V. Fr√©quence", question:"Fr√©quence ?", options:["Unique","3 mois","Annuel"] }
  ],
  √âlectricien: [
    { section:"I. Type d‚Äôintervention", question:"Type d‚Äôintervention ?", options:["Nouvelle ligne","√âclairage","Prise/interrupteur","Panne √©lectrique","Mise en conformit√©","Compteur pr√©pay√©"] },
    { section:"II. Localisation", question:"Localisation ?", options:["Salon/chambre","Cuisine","Salle de bain","Ext√©rieur","Tableau principal"] },
    { section:"III. Courant", question:"Type de courant ?", options:["Monophas√©","Triphas√©","Solaire"] },
    { section:"IV. √âquipement", question:"√âquipement concern√© ?", options:["Prise","√âclairage","Ventilateur","Clim","Tableau √©lectrique","Pompe"] },
    { section:"V. Probl√®me", question:"Probl√®me constat√© ?", options:["Disjonction","Court-circuit","Odeur de br√ªl√©","Panne totale","R√©fection compl√®te"] },
    { section:"VI. Contexte", question:"Contexte ?", options:["Maison","Appartement","Commerce","Industriel"] }
  ],
  Enduiseur_Fa√ßadier: [
    { section:"I. Type", question:"Type d'enduit/rev√™tement ?", options:["Enduit neuf","Ravalement","R√©paration fissures","ITE"] },
    { section:"II. Support", question:"Support ?", options:["Brique","B√©ton","Parpaing","Pierre"] },
    { section:"III. Finition", question:"Finition ?", options:["Gratt√©e","Taloch√©e","Lisse","Projet√©e"] },
    { section:"IV. Surface", question:"Surface ?", options:["0‚Äì50","50‚Äì100","100‚Äì200","200+"] },
    { section:"V. Hauteur", question:"Hauteur fa√ßade ?", options:["<3 m","3‚Äì6 m",">6 m"] },
    { section:"VI. Acc√®s", question:"Acc√®s chantier ?", options:["Rue directe","Cour","√âchafaudage"] }
  ],
  Etancheur: [
    { section:"I. Surface", question:"Quelle surface ?", options:["Toiture terrasse","Mur enterr√©","Balcon/dalle","R√©serve d‚Äôeau"] },
    { section:"II. Intervention", question:"Type d‚Äôintervention ?", options:["Neuf","R√©fection","R√©paration fuites","Diagnostic"] },
    { section:"III. Rev√™tement", question:"Type de rev√™tement ?", options:["Bitume","R√©sine","EPDM/PVC","Hydrofuge"] },
    { section:"IV. Surface totale", question:"Surface totale ?", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"V. Acc√®s", question:"Acc√®s chantier ?", options:["Facile","Moyen","Difficile"] },
    { section:"VI. Eau", question:"Pr√©sence d'eau ?", options:["Oui","Non","Occasionnelle"] }
  ],
  Jardinier_Paysagiste: [
    { section:"I. Prestation", question:"Type de prestation ?", options:["Entretien","Taille","Am√©nagement","Gazon"] },
    { section:"II. Surface", question:"Surface ?", options:["0‚Äì100","100‚Äì500","500‚Äì1000","1000+"] },
    { section:"III. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] },
    { section:"IV. √âquipements", question:"√âl√©ments ?", options:["Gazon","Haies","Arbres","Massifs","Arrosage auto"] }
  ],
  Ma√ßon: [
    { section:"I. Travail", question:"Type de structure ?", options:["Fondation","Mur porteur","Chape/dalle","Escalier","R√©novation"] },
    { section:"II. B√¢timent", question:"Type de b√¢timent ?", options:["Maison simple","Immeuble R+1 √† R+4","Commercial","Mur de cl√¥ture"] },
    { section:"III. Surface", question:"Surface ?", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"IV. Mat√©riaux", question:"Mat√©riaux ?", options:["Parpaings","Briques","B√©ton arm√©","Pierre"] },
    { section:"V. Sol", question:"Nature du sol ?", options:["Argileux","Sablonneux","Compact","Rocailleux","Humide"] },
    { section:"VI. Acc√®s", question:"Acc√®s chantier ?", options:["Camion","All√©e","Brouette","Manuel"] }
  ],
  Peintre_Decorateur: [
    { section:"I. Surface", question:"Surface √† peindre ?", options:["Murs","Plafonds","Menuiseries","Fa√ßade ext√©rieure"] },
    { section:"II. Travaux", question:"Type de travaux ?", options:["Peinture neuve","R√©novation","D√©coration"] },
    { section:"III. Surface m¬≤", question:"Surface (m¬≤)", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"IV. Support", question:"√âtat du support ?", options:["Neuf","Ancien","Tr√®s ab√Æm√©"] },
    { section:"V. Finition", question:"Niveau de finition ?", options:["Standard","Haut de gamme"] }
  ],
  Pl√¢trier_Plaquiste: [
    { section:"I. Travaux", question:"Type de travaux ?", options:["Cloisons","Isolation","Plafond","Finition s√®che"] },
    { section:"II. Surface", question:"Surface (m¬≤) ?", options:["0‚Äì20","20‚Äì50","50‚Äì100","100+"] },
    { section:"III. Support", question:"Type de support ?", options:["Mur neuf","Mur ancien","Plafond","Combles"] },
    { section:"IV. Finition", question:"Niveau de finition ?", options:["Standard","Haut de gamme","D√©corative"] },
    { section:"V. Acc√®s", question:"Acc√®s ?", options:["Libre","Hauteur >3m","Chantier occup√©"] }
  ],
  Pisciniste: [
    { section:"I. Service", question:"Type de service ?", options:["Construction","R√©novation","Entretien","D√©pannage"] },
    { section:"II. Type", question:"Type de piscine ?", options:["B√©ton","Coque","Hors-sol","Naturelle"] },
    { section:"III. Volume", question:"Volume (m¬≥) ?", options:["<20","20‚Äì50","50‚Äì100","100+"] },
    { section:"IV. Traitement", question:"Traitement ?", options:["Chlore","Sel","UV","Ozone","Autre"] },
    { section:"V. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] }
  ],
  Plombier: [
    { section:"I. Intervention", question:"Quel type d‚Äôintervention ?", options:["Fuite","WC bouch√©","Robinet/lavabo","Chauffe-eau","Pression faible","Salle de bain compl√®te"] },
    { section:"II. Localisation", question:"Localisation ?", options:["Salle de bain","Cuisine","Mur/sol","Ext√©rieur","Toiture/r√©servoir"] },
    { section:"III. Mat√©riel", question:"Tuyauterie ?", options:["PVC","Cuivre","Galva","Multicouche","Inconnu"] },
    { section:"IV. Gravit√©", question:"Gravit√© ?", options:["Majeure","Faible pression","Bouchage","Eau stagnante","Mineur"] },
    { section:"V. Acc√®s", question:"Acc√®s ?", options:["Visible","Encastre","R√©servoir","Pompe"] },
    { section:"VI. Environnement", question:"Lieu ?", options:["Appartement","Maison","Commerce","Collectif"] }
  ],
  Ramoneur: [
    { section:"I. √âquipement", question:"√âquipement ?", options:["Chemin√©e","Po√™le","Chaudi√®re","VMC"] },
    { section:"II. Entretien", question:"Dernier entretien ?", options:["<6 mois","6‚Äì12 mois",">1 an","Inconnu"] },
    { section:"III. Intervention", question:"Type ?", options:["Ramonage","Nettoyage","Bistre","Inspection cam√©ra"] },
    { section:"IV. Acc√®s", question:"Acc√®s ?", options:["Facile","Moyen","Difficile"] },
    { section:"V. Conduits", question:"Nombre ?", options:["1","2‚Äì3","+3"] }
  ],
  Staffeur_Stucateur: [
    { section:"I. Travail", question:"Type de travail ?", options:["Moulures","Restauration","D√©cor mural","Sur mesure"] },
    { section:"II. Surface", question:"Surface/√©l√©ments ?", options:["1‚Äì5 m","5‚Äì20 m","20+ m","Surface >10 m¬≤"] },
    { section:"III. Lieu", question:"Lieu ?", options:["R√©sidentiel","Patrimoine","Commerce","Institution"] },
    { section:"IV. Finition", question:"Finition ?", options:["Lisse","Patin√©e","Dor√©e"] },
    { section:"V. Acc√®s", question:"Difficult√© ?", options:["Facile","Moyen","Difficile"] }
  ],
  Technicien_Humidite: [
    { section:"I. Probl√®me", question:"Type de probl√®me ?", options:["Capillarit√©","Infiltration","Condensation","Ventilation"] },
    { section:"II. Localisation", question:"O√π ?", options:["Sous-sol","Mur int√©rieur","Salle de bain","Combles"] },
    { section:"III. Surface", question:"Surface ?", options:["0‚Äì10","10‚Äì30","30‚Äì50","50+"] },
    { section:"IV. Traces", question:"Traces visibles ?", options:["Taches","Odeurs","Salp√™tre","Structure ab√Æm√©e"] },
    { section:"V. B√¢timent", question:"Type de b√¢timent ?", options:["Maison","Appartement"] }
  ]
};

const QUESTIONNAIRE_CONSTRUCTION = [
  { section:"PC. Nature du projet", question:"Type de projet ?", options:["Construction neuve","Extension / Sur√©l√©vation","Projet cl√© en main"] },
  { section:"PC. Nature du projet", question:"B√¢timent concern√© ?", options:["Maison individuelle","Immeuble d‚Äôhabitation","B√¢timent commercial","Bureaux","Entrep√¥t / atelier"] },
  { section:"PC. Dimensions", question:"Surface totale approximative ?", options:["<50 m¬≤","50‚Äì100 m¬≤","100‚Äì200 m¬≤","200‚Äì500 m¬≤","500+ m¬≤"] },
  { section:"PC. Dimensions", question:"Nombre de niveaux ?", options:["RDC seul","R+1","R+2","R+3 et +"] },
  { section:"PC. Terrain", question:"Terrain disponible ?", options:["Oui","Non","En cours d‚Äôacquisition"] },
  { section:"PC. Terrain", question:"√âtude de sol ?", options:["Oui ‚Äì disponible","Non","√Ä faire"] },
  { section:"PC. Plans", question:"Plans disponibles ?", options:["Oui ‚Äì architecte","Oui ‚Äì croquis","Non"] },
  { section:"PC. Administratif", question:"Permis de construire ?", options:["Oui obtenu","Oui en cours","Non","Non requis"] },
  { section:"PC. Phase √† chiffrer", question:"Phase demand√©e ?", options:["√âtudes / conception","Fondations","Gros ≈ìuvre","Second ≈ìuvre","Finitions","Projet complet"] },
  { section:"PC. Logistique", question:"Acc√®s chantier ?", options:["Acc√®s camion facile","Acc√®s moyen","Acc√®s difficile"] },
  { section:"PC. Logistique", question:"Eau & √©lectricit√© disponibles ?", options:["Oui les deux","Eau seulement","√âlectricit√© seulement","Aucun"] },
  { section:"PC. Budget / D√©lais", question:"Budget estimatif ?", options:["<5 M","5‚Äì10 M","10‚Äì25 M","25‚Äì50 M","50 M+","√Ä d√©finir"] },
  { section:"PC. Budget / D√©lais", question:"D√©lai souhait√© ?", options:["Urgent","1‚Äì3 mois","3‚Äì6 mois","6‚Äì12 mois","12 mois+"] }
];

const QUESTIONNAIRE_RENOVATION = [
  { section:"PR. Nature du projet", question:"Type de r√©novation ?", options:["R√©novation compl√®te","R√©novation partielle","R√©habilitation lourde"] },
  { section:"PR. B√¢timent", question:"B√¢timent concern√© ?", options:["Maison","Appartement","Immeuble","Commerce / bureaux"] },
  { section:"PR. √Çge / √©tat", question:"√Çge du b√¢timent ?", options:["<10 ans","10‚Äì30 ans","30‚Äì50 ans","50+ ans","Inconnu"] },
  { section:"PR. √Çge / √©tat", question:"√âtat g√©n√©ral ?", options:["Bon","Moyen","D√©grad√©","Tr√®s d√©grad√©"] },
  { section:"PR. Structure", question:"Structure touch√©e ?", options:["Non","Oui ‚Äì murs porteurs","Oui ‚Äì planchers","Oui ‚Äì toiture","Inconnu"] },
  { section:"PR. Risques", question:"Pr√©sence amiante / plomb ?", options:["Oui","Non","Inconnu"] },
  { section:"PR. Occupation", question:"B√¢timent occup√© pendant travaux ?", options:["Oui","Non","Partiellement"] },
  { section:"PR. Surfaces", question:"Surface concern√©e ?", options:["<50 m¬≤","50‚Äì100 m¬≤","100‚Äì200 m¬≤","200+ m¬≤"] },
  {
    section: "PR. Lots",
    question: "Lots √† r√©nover ? (choix multiple)",
    type: "checkboxes",
    options: [
      "Gros ≈ìuvre","Plomberie","√âlectricit√©","Climatisation","Menuiseries","Peinture","Carrelage",
      "Toiture","√âtanch√©it√©","Voirie et R√©seaux Divers / Ext√©rieurs","Pl√¢trerie / Faux plafond",
      "Serrurerie","Cuisine","Salle de bain","Tout"
    ]
  },
  { section:"PR. Objectif", question:"Objectif principal ?", options:["Remise √† neuf","Modernisation","Mise en conformit√©","R√©paration d√©g√¢ts (eau/feu)"] },
  { section:"PR. Logistique", question:"Acc√®s chantier ?", options:["Acc√®s camion facile","Acc√®s moyen","Acc√®s difficile"] },
  { section:"PR. Budget / D√©lais", question:"Budget estimatif ?", options:["<5 M","5‚Äì10 M","10‚Äì25 M","25‚Äì50 M","50 M+","√Ä d√©finir"] },
  { section:"PR. Budget / D√©lais", question:"D√©lai souhait√© ?", options:["Urgent","1‚Äì3 mois","3‚Äì6 mois","6‚Äì12 mois","12 mois+"] }
];

const quartiersYaounde = [
  'Akono','Angangueo','Anguissa','Bastos','Biteng','Biyem-Assi','Briqueterie',
  'Camp SIC Hippodrome','Camp-Sonel','Carri√®re','Cit√© Verte','Condengui','Damas',
  'Ebogo','Efog-Ateba','Efoulan','Ekoudou','Ekounou','Emana','Emonbo','Essos',
  'Etoa-Meki','Etoug-Ebe','Etoudi','Fouda','Jean-Vespa','Kondengui','Koweit City',
  'Maison Blanche','Mbankolo','Mbimi','Mballa 2','Mehandan','Melen','Mefou','Mendong',
  'Mfandena','Mimboman','Mini-ferme','Minkama','Mokolo','Mvan','Mvog Ada',
  'Mvog Atangana Mballa','Mvog-Betsi','Mvog-Mbi','Mvoly√©','Ndzana','Ngoa Ek√©l√©',
  'Ngola','Ngousso','Ngoumou','Nkol-Ewoue','Nkol-Ewouelle','Nkolbisson','Nkoldongo',
  'Nkolmesseng','Nkolndongo','Nkom Kana','Nkometou','Nkomo','Nlongkak','Nkolbikok',
  'Nkolzol','Nkolzol II','Nlongkwa','Nlongmeko‚Äôo','Nlongmeko','Nlongola','Nyom',
  'Obili','Obobogo','Odza','Olemb√©','Ol√©zoa','Oliga','Omnisports','Oyom-Abang',
  'Plateau Atemengue','Poste Centrale','Santa Barbara','Simbock','Tam-Tam Weekend',
  'Tongolo','Tsinga','Village Mvog Ada','Yaound√© Centre','Zamakoe','Messa','Eleveur'
];

const quartiersDouala = [
  'A√©roport','Akra Kombo','Babylone I','Babylone II','Bali','Bangue','Beedi','Bepanda',
  'Bessengue','Besseke','Bikoro','Bilongue','Bilingue','Bobongo','Boko','Bomkul',
  'Bona Bekombo','Bonabeyike','Bonadiwoto','Bonadouma','Bonadoumb√©','Bonadibong',
  'Bonagang','Bonajang','Bonanjin','Bonakouamouang','Bonakeke Akwa','Bonalembe',
  'Bonamatoumbe','Bonambappe','Bonaminkano','Bonamoussadi','Bonamoudourou',
  'Bonamouti','Bonamouti Akwa 2','Bonanjo','Bonanloka','Bonangando','Bonapriso',
  'Bonassama','Bonateki','Bonatene','Bonelang','Bonoleke','Bonoumb√©','Bonutongo',
  'Brazzaville','Bu','Bwap√©','Cacao-Barry','Cap Cameroun','C.C.C.','Cit√© Berge',
  'Cit√© de la Paix','Cit√© des palmiers','Cit√© Sic','Congo','Dahomey','De√Ødo',
  'Dibom','Dikahe','Dj√©bal√®','Emene City','Epaka I','Epaka II','Gentil','Grand Moulin',
  'Hydrocarbures','Japoma','Jourdain','Kassalafam','Kombo Bouma','Kombo Moukoko',
  'Kondi','Koo','Kotto','Koumassi','Lagos Market','Lendi','Logbaba','Logbessou','Logpom',
  'Lyc√©e de New Bell','Madiba','Makepe','Malangue','Mambanda','Manike','Manoka','Massadi',
  'Matanda','Mbam Ewondo','Mbanga Bakoko','Mbengue City','Mb√©nadikoum√©','Moungangu√©',
  'Moukala Tanda','Ndogbati','Ndogbong','Ndoghem','Ndoghem II','Ndogmbe','Ndogpassi',
  'Ndogsimbi','Ndobo','Ndokoti','Ndjong-Mebi','Ngangue','Ngodi','Ngoma','Ngwel√©',
  'Nguereck','Nguibassal','Nkomba','Nkongmondo','Nkongui','Nkololoun','NKondi',
  'Nouvelle zone d\'Akwa Nord','Nouvelle zone de New-Deido','Number One Creek',
  'Nyalla','Nyangadou','Nylon','Oyack','Petit Toub√©','Pk 7','Pk 9','Pk 10','Pk 11',
  'Pk 17','Pk 21','Plateau Joss','Pom Lien','Prison centrale de New Bell','Sabenjongo',
  'Sincatex','So-Boum','Sodiko','Sodikombo','Sobikago','Song-Mahop','Song-Ngongag',
  'Sopom','Source','T.S.F','Tergal','Village','Youpw√©'
];

/* ========== R√âF√âRENCES DOM ========== */
const typeClientEl = document.getElementById("typeClient");
const clientPrive = document.getElementById("clientPrive");
const clientEntreprise = document.getElementById("clientEntreprise");
const nomPrive = document.getElementById("nomPrive");
const telephonePrive = document.getElementById("telephonePrive");
const emailPrive = document.getElementById("emailPrive");
const nomEntreprise = document.getElementById("nomEntreprise");
const nui = document.getElementById("nui");
const rccm = document.getElementById("rccm");
const siege = document.getElementById("siege");
const telephoneEntreprise = document.getElementById("telephoneEntreprise");
const emailEntreprise = document.getElementById("emailEntreprise");
const villeSelect = document.getElementById('ville');
const villeAutre = document.getElementById('villeAutre');
const quartierInput = document.getElementById('quartier');
const quartierResultsEl = document.getElementById('quartierResults');
const lieudit = document.getElementById('lieudit');
const interventionEl = document.getElementById("intervention");
const sectionDisponibilites = document.getElementById("sectionDisponibilites");
const sectionDateSouhaitee = document.getElementById("sectionDateSouhaitee");
const c1 = document.getElementById("c1");
const c2 = document.getElementById("c2");
const c3 = document.getElementById("c3");
const dateSouhaitee = document.getElementById("dateSouhaitee");
const descriptionEl = document.getElementById("description");
const photosInput = document.getElementById("photos");
const photoPreview = document.getElementById("photoPreview");
const metiersContainer = document.getElementById("metiersContainer");
const addMetierBtn = document.querySelector(".addMetierBtn");
const titlePoint4 = document.getElementById("titlePoint4");
const descPoint4  = document.getElementById("descPoint4");
const projetContainer = document.getElementById("projetContainer");
const projetTitle = document.getElementById("projetTitle");
const projetQuestions = document.getElementById("projetQuestions");
const projetDescription = document.getElementById("projetDescription");
const sendBtn = document.getElementById("sendBtn");
const waManualBtn = document.getElementById("waManualBtn");

let quartiersActifs = [];
let compteurMetiers = 0;

/* ========== UI: client type ========== */
function refreshClientTypeUI() {
  const v = typeClientEl.value;
  clientPrive.style.display = (v === "prive") ? "block" : "none";
  clientEntreprise.style.display = (v === "entreprise") ? "block" : "none";
}
typeClientEl.addEventListener("change", refreshClientTypeUI);
refreshClientTypeUI();

/* ========== AUTOCOMPLETE QUARTIERS ========== */
villeSelect.addEventListener('change', () => {
  villeAutre.style.display = (villeSelect.value === 'Autre') ? 'block' : 'none';
  quartiersActifs =
    villeSelect.value === "Yaound√©" ? quartiersYaounde :
    villeSelect.value === "Douala" ? quartiersDouala :
    [];
  quartierInput.value = "";
  quartierResultsEl.innerHTML = "";
  quartierResultsEl.style.display = "none";
});

quartierInput.addEventListener('input', () => {
  const term = quartierInput.value.toLowerCase();
  quartierResultsEl.innerHTML = "";
  if (!term || quartiersActifs.length === 0) {
    quartierResultsEl.style.display = 'none';
    return;
  }
  const filtered = quartiersActifs.filter(q => q.toLowerCase().includes(term)).slice(0,12);
  if (!filtered.length) { quartierResultsEl.style.display = 'none'; return; }
  filtered.forEach(q => {
    const div = document.createElement('div');
    div.className = 'autocomplete-item';
    div.textContent = q;
    div.onclick = () => { quartierInput.value = q; quartierResultsEl.style.display = 'none'; };
    quartierResultsEl.appendChild(div);
  });
  quartierResultsEl.style.display = 'block';
});
document.addEventListener('click', e => { if (!quartierResultsEl.contains(e.target) && e.target !== quartierInput) quartierResultsEl.style.display = 'none'; });

/* ========== PHOTOS PREVIEW ========== */
photosInput.addEventListener("change", () => {
  photoPreview.innerHTML = "";
  Array.from(photosInput.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement("img");
      img.src = e.target.result;
      photoPreview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

/* ========== PROJET questionnaire renderer ========== */
function renderQuestionnaireProjet(list, title) {
  projetTitle.textContent = title;
  projetQuestions.innerHTML = "";
  list.forEach((item) => {
    const h = document.createElement("h4");
    h.textContent = item.section;
    projetQuestions.appendChild(h);
    const label = document.createElement("label");
    label.style.display = "block"; label.style.fontWeight = "bold"; label.style.marginBottom = "6px";
    label.textContent = item.question;
    projetQuestions.appendChild(label);
    if (item.type === "checkboxes") {
      const wrap = document.createElement("div"); wrap.className = "projetCheckboxWrap"; wrap.dataset.question = item.question;
      item.options.forEach((optText) => {
        const row = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.className = "projetQuestionCheckbox"; cb.dataset.question = item.question; cb.value = optText;
        cb.addEventListener("change", () => {
          const allCbs = wrap.querySelectorAll('input[type="checkbox"]');
          const isTout = cb.value.toLowerCase() === "tout";
          if (cb.checked && isTout) { allCbs.forEach(x => { if (x !== cb) x.checked = false; }); }
          else if (cb.checked && !isTout) { allCbs.forEach(x => { if (x.value.toLowerCase() === "tout") x.checked = false; }); }
        });
        const span = document.createElement("span"); span.textContent = optText;
        row.appendChild(cb); row.appendChild(span); wrap.appendChild(row);
      });
      projetQuestions.appendChild(wrap);
      return;
    }
    const select = document.createElement("select"); select.className = "projetQuestionSelect"; select.dataset.question = item.question;
    select.innerHTML = `<option value="">S√©lectionner...</option>`;
    (item.options || []).forEach(o => { const opt = document.createElement("option"); opt.value = o; opt.textContent = o; select.appendChild(opt); });
    const optAutre = document.createElement("option"); optAutre.value = "Autre"; optAutre.textContent = "Autre"; select.appendChild(optAutre);
    projetQuestions.appendChild(select);
  });
}

/* ========== switch projet / metiers ========== */
function isProjetConstruction() { return interventionEl.value === "Projet de construction compl√®te"; }
function isProjetRenovation()  { return interventionEl.value === "Projet de r√©novation"; }
function isProjetBatiment()    { return isProjetConstruction() || isProjetRenovation(); }

function refreshPoint4UI() {
  if (isProjetConstruction()) {
    titlePoint4.textContent = "4. Projet";
    descPoint4.textContent = "Merci de renseigner les informations relatives √† votre projet de construction.";
    metiersContainer.style.display = "none";
    addMetierBtn.style.display = "none";
    projetContainer.style.display = "block";
    renderQuestionnaireProjet(QUESTIONNAIRE_CONSTRUCTION, "Questionnaire projet ‚Äî Construction compl√®te");
    return;
  }
  if (isProjetRenovation()) {
    titlePoint4.textContent = "4. Projet";
    descPoint4.textContent = "Merci de renseigner les informations relatives √† votre projet de r√©novation.";
    metiersContainer.style.display = "none";
    addMetierBtn.style.display = "none";
    projetContainer.style.display = "block";
    renderQuestionnaireProjet(QUESTIONNAIRE_RENOVATION, "Questionnaire projet ‚Äî R√©novation");
    return;
  }
  titlePoint4.textContent = "4. Corps de m√©tier";
  descPoint4.textContent = "Vous pouvez ajouter plusieurs m√©tiers si n√©cessaire.";
  projetContainer.style.display = "none";
  projetQuestions.innerHTML = "";
  projetDescription.value = "";
  metiersContainer.style.display = "block";
  addMetierBtn.style.display = "inline-block";
}
interventionEl.addEventListener("change", () => { refreshPoint4UI(); });
refreshPoint4UI();

/* ========== MULTI-METIERS ========== */
function escapeHtml(s){ return String(s||""); }

function ajouterMetier() {
  compteurMetiers++;
  const id = compteurMetiers;
  const block = document.createElement("div");
  block.className = "metierBlock";
  block.id = "metierBlock_" + id;

  block.innerHTML = `
    <h3>M√©tier #${id}</h3>
    <select class="metierSelect" data-id="${id}">
      <option value="">S√©lectionner...</option>
      ${Object.keys(data).map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("")}
      <option value="Autre">Autre</option>
    </select>
    <div class="questionsTechniques" id="questions_${id}"></div>
    <textarea class="descMetier" id="descMetier_${id}" placeholder="Description sp√©cifique du m√©tier"></textarea>
    <div class="moExtras" id="mo_${id}" style="display:none;">
      <h4>${escapeHtml(LIB_MO)} ‚Äì Informations suppl√©mentaires</h4>
      <label>Nombre de techniciens n√©cessaires</label>
      <input type="number" id="techniciens_${id}" min="1" placeholder="Ex : 3">
      <label>Forfait par jour (Main d'≈ìuvre)</label>
      <input type="text" id="forfait_${id}" placeholder="Ex : 50 000 FCFA / jour">
      <label>Vous prenez en charge l'h√©bergement ?</label>
      <select id="hebergement_${id}"><option value="">S√©lectionner...</option><option value="Oui">Oui</option><option value="Non">Non</option></select>
      <label>Date d√©but de prestation</label><input type="date" id="debut_${id}">
      <label>Date fin de prestation</label><input type="date" id="fin_${id}">
    </div>
    <button type="button" class="removeMetierBtn smallBtn" onclick="supprimerMetier(${id})" style="background:#dc3545">‚ùå Supprimer ce m√©tier</button>
  `;
  metiersContainer.appendChild(block);

  // √©coute changement s√©lection m√©tier pour afficher questions techniques
  const sel = block.querySelector(".metierSelect");
  sel.addEventListener("change", (e) => {
    const val = e.target.value;
    const container = document.getElementById("questions_" + id);
    container.innerHTML = "";
    if (!val) return;
    if (val === "Autre") {
      const inp = document.createElement("input"); inp.placeholder = "Pr√©cisez le m√©tier";
      container.appendChild(inp);
      return;
    }
    const qlist = data[val] || [];
    qlist.forEach(q => {
      const h = document.createElement("h5"); h.textContent = q.section; container.appendChild(h);
      const label = document.createElement("label"); label.textContent = q.question; container.appendChild(label);
      if (q.type === "checkboxes") {
        const wrap = document.createElement("div");
        (q.options||[]).forEach(opt => {
          const lab = document.createElement("label");
          const cb = document.createElement("input"); cb.type = "checkbox"; cb.value = opt;
          lab.appendChild(cb); lab.appendChild(document.createTextNode(" " + opt)); wrap.appendChild(lab);
        });
        container.appendChild(wrap);
      } else {
        const select = document.createElement("select"); select.className = "metierQSelect";
        select.innerHTML = `<option value="">S√©lectionner...</option>` + (q.options||[]).map(o => `<option value="${o}">${o}</option>`).join("");
        container.appendChild(select);
      }
    });

    // afficher extras MO si intervention MO
    const moBlock = document.getElementById("mo_" + id);
    moBlock.style.display = (interventionEl.value === LIB_MO) ? "block" : "none";
  });
}

function supprimerMetier(id) {
  const el = document.getElementById("metierBlock_" + id);
  if (el) el.remove();
}

/* liaison bouton ajouter */
addMetierBtn.addEventListener("click", ajouterMetier);

/* ========== SUBMIT ========== */
function toBase64(file){ return new Promise(resolve=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.readAsDataURL(file); }); }
function normalizeTel(raw){
  if(!raw) return "";
  let s = String(raw).trim();
  s = s.replace(/\s+/g,"").replace(/\+/g,"").replace(/\(|\)|-/g,"");
  if(s.startsWith("0")) s = "237" + s.slice(1);
  if(s.startsWith("+")) s = s.slice(1);
  return s;
}

sendBtn.addEventListener("click", async () => {
  sendBtn.disabled = true; sendBtn.textContent = "Envoi‚Ä¶";
  try {
    // photos to base64
    const photosBase64 = await Promise.all(Array.from(photosInput.files||[]).map(async f => {
      const b = await toBase64(f);
      return { filename: f.name, mimeType: f.type, base64: b.split(",")[1] };
    }));

    // metiers collect
    const metiers = [];
    document.querySelectorAll(".metierBlock").forEach(block => {
      const id = block.id.split("_")[1];
      const sel = block.querySelector(".metierSelect")?.value || "";
      const desc = block.querySelector(".descMetier")?.value || "";
      const questions = {};
      block.querySelectorAll(".metierQSelect").forEach(s => { questions[s.previousSibling?.textContent || s.dataset.q || "Q"] = s.value || ""; });
      block.querySelectorAll("input[type='checkbox']").forEach(cb => {
        if(cb.checked){
          const qlabel = cb.closest(".questionsTechniques")?.querySelector("label")?.textContent || "Option";
          if(!questions[qlabel]) questions[qlabel] = [];
          questions[qlabel].push(cb.value);
        }
      });
      if(sel) metiers.push({ metier: sel, description: desc, questions });
      else if(desc) metiers.push({ metier: "Autre", description: desc, questions });
    });

    // projet collect
    let projet = null;
    if (isProjetConstruction() || isProjetRenovation()) {
      const qs = {};
      document.querySelectorAll(".projetQuestionSelect").forEach(s => { qs[s.dataset.question || "Q"] = s.value || ""; });
      document.querySelectorAll(".projetQuestionCheckbox:checked").forEach(cb => {
        const q = cb.dataset.question || "Q";
        if(!qs[q]) qs[q] = [];
        qs[q].push(cb.value);
      });
      projet = { type: isProjetConstruction() ? "construction" : "renovation", questions: qs, description: projetDescription.value || "" };
    }

    const isMO = (interventionEl.value === LIB_MO);

    const payload = {
      typeClient: typeClientEl.value,
      nom: typeClientEl.value === "prive" ? (nomPrive.value||"") : (nomEntreprise.value||""),
      telephone: typeClientEl.value === "prive" ? (telephonePrive.value||"") : (telephoneEntreprise.value||""),
      email: typeClientEl.value === "prive" ? (emailPrive.value||"") : (emailEntreprise.value||""),
      nomEntreprise: typeClientEl.value === "entreprise" ? (nomEntreprise.value||"") : null,
      nui: typeClientEl.value === "entreprise" ? (nui.value||"") : null,
      rccm: typeClientEl.value === "entreprise" ? (rccm.value||"") : null,
      siege: typeClientEl.value === "entreprise" ? (siege.value||"") : null,
      ville: (villeSelect.value === "Autre") ? (villeAutre.value||"") : (villeSelect.value||""),
      quartier: quartierInput.value || "",
      lieudit: lieudit.value || "",
      intervention: interventionEl.value || "",
      c1: isMO ? null : (c1.value || null),
      c2: isMO ? null : (c2.value || null),
      c3: isMO ? null : (c3.value || null),
      dateSouhaitee: isMO ? null : (dateSouhaitee.value || null),
      description: descriptionEl.value || "",
      metiers,
      projet,
      photos: photosBase64
    };

    const resp = await fetch(SCRIPT_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    if(!resp.ok){ const t = await resp.text(); throw new Error("HTTP " + resp.status + " ‚Äî " + t); }
    const res = await resp.json();
    if(!res.success) throw new Error(res.error || "Erreur serveur inconnue");

    // open wa.me 1:1 prefilled
    const ticket = res.ticket || "N/A";
    const folderUrl = res.folderUrl || "";
    const clientRaw = payload.telephone || "";
    const telNorm = normalizeTel(clientRaw);
    let waUrl = "";
    if(telNorm){
      const msg = encodeURIComponent(`Bonjour ${payload.nom || ""}\nMerci pour votre demande (ticket ${ticket}).\nDossier: ${folderUrl}\nCordialement, QemWork`);
      waUrl = `https://wa.me/${telNorm}?text=${msg}`;
    } else {
      waUrl = WA_GROUP_INVITE;
    }
    window.open(waUrl, "_blank");
    alert("‚úîÔ∏è Envoy√© ‚Äî ticket: " + ticket);

  } catch(err){
    console.error(err);
    alert("‚ùå √âchec : " + (err.message || err));
  } finally {
    sendBtn.disabled = false; sendBtn.textContent = "üì© Envoyer la demande";
  }
});

/* ========== Manual WA button ========== */
waManualBtn.addEventListener("click", () => {
  const clientType = typeClientEl.value;
  const telRaw = clientType === "prive" ? telephonePrive.value : telephoneEntreprise.value;
  const tel = normalizeTel(telRaw || "");
  if(tel){
    const msg = encodeURIComponent("Bonjour, nous vous invitons √† rejoindre notre discussion WhatsApp pour le suivi.");
    window.open(`https://wa.me/${tel}?text=${msg}`, "_blank");
  } else {
    window.open(WA_GROUP_INVITE, "_blank");
  }
});
</script>
</body>
</html>
